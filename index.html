<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zakat Calculator - Purify Your Wealth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --dark-bg: #050a16;
            --darker-bg: #03070f;
            --card-bg: rgba(15, 23, 42, 0.6);
            --glass-bg: rgba(30, 41, 59, 0.4);
            --border-color: rgba(148, 163, 184, 0.1);
            --gold: #d4af37;
            --gold-light: #f4d47b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #10b981;
            --teal-accent: #14b8a6;
            --indigo-soft: rgba(74, 85, 170, 0.16);
            --purple-depth: rgba(99, 70, 145, 0.12);
            --page-glow-a: rgba(13, 29, 61, 0.28);
            --page-glow-b: rgba(5, 56, 68, 0.18);
            --page-base-start: #040913;
            --page-base-end: #040812;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background:
                radial-gradient(1200px 600px at 15% 5%, var(--page-glow-a) 0%, rgba(13, 29, 61, 0) 60%),
                radial-gradient(900px 460px at 85% 8%, var(--page-glow-b) 0%, rgba(5, 56, 68, 0) 62%),
                radial-gradient(1100px 520px at 50% 40%, var(--indigo-soft) 0%, rgba(74, 85, 170, 0) 70%),
                linear-gradient(180deg, var(--page-base-start) 0%, var(--dark-bg) 55%, var(--page-base-end) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1200;
            padding: 0.65rem 1rem;
            background: linear-gradient(180deg, rgba(3, 10, 22, 0.88) 0%, rgba(3, 10, 22, 0.62) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        }

        .top-nav-inner {
            max-width: 1260px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .top-nav-logo {
            font-weight: 700;
            color: var(--gold-light);
            letter-spacing: 0.02em;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .top-nav-links {
            display: flex;
            gap: 0.55rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .top-nav-links::-webkit-scrollbar {
            display: none;
        }

        .top-link {
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(15, 23, 42, 0.55);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.5rem 0.95rem;
            font-size: 0.86rem;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .top-link:hover {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.55);
        }

        .top-link.active {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.75);
            background: rgba(212, 175, 55, 0.14);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.18);
        }

        .top-nav-controls {
            display: flex;
            align-items: center;
            gap: 0.55rem;
            flex-shrink: 0;
        }

        .top-nav-theme {
            min-width: 156px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(15, 23, 42, 0.62);
            color: var(--text-primary);
            font-size: 0.82rem;
            font-weight: 600;
            padding: 0 0.75rem;
        }

        .top-nav-theme:focus-visible {
            outline: none;
            border-color: rgba(212, 175, 55, 0.75);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.16);
        }

        .nav-spacer {
            height: 64px;
        }

        #landing,
        #how-it-works,
        #calculator,
        #settingsCard,
        #assetsCard,
        #debtsCard,
        #resultsCard,
        #historyCard {
            scroll-margin-top: 84px;
        }

        body[data-theme="midnight-gold"] {
            --dark-bg: #050a16;
            --darker-bg: #03070f;
            --gold: #d4af37;
            --gold-light: #f4d47b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #10b981;
            --teal-accent: #14b8a6;
            --indigo-soft: rgba(74, 85, 170, 0.16);
            --purple-depth: rgba(99, 70, 145, 0.12);
            --page-glow-a: rgba(13, 29, 61, 0.28);
            --page-glow-b: rgba(5, 56, 68, 0.18);
            --page-base-start: #040913;
            --page-base-end: #040812;
        }

        body[data-theme="emerald-night"] {
            --dark-bg: #04120f;
            --darker-bg: #020b09;
            --gold: #1fa97a;
            --gold-light: #8fe3c9;
            --text-primary: #eaf7f3;
            --text-secondary: #a7b9c7;
            --accent: #1fa97a;
            --teal-accent: #59d6b0;
            --indigo-soft: rgba(39, 119, 100, 0.2);
            --purple-depth: rgba(23, 74, 62, 0.18);
            --page-glow-a: rgba(7, 46, 36, 0.34);
            --page-glow-b: rgba(17, 84, 68, 0.2);
            --page-base-start: #03120f;
            --page-base-end: #04100d;
        }

        body[data-theme="royal-indigo"] {
            --dark-bg: #070b1f;
            --darker-bg: #040713;
            --gold: #6c7cff;
            --gold-light: #b8c2ff;
            --text-primary: #edf0ff;
            --text-secondary: #9fb0c7;
            --accent: #8ea0ff;
            --teal-accent: #7f8fff;
            --indigo-soft: rgba(108, 124, 255, 0.2);
            --purple-depth: rgba(66, 77, 152, 0.18);
            --page-glow-a: rgba(31, 48, 115, 0.32);
            --page-glow-b: rgba(46, 69, 155, 0.2);
            --page-base-start: #060a1c;
            --page-base-end: #06091a;
        }

        body[data-theme="teal-dawn"] {
            --dark-bg: #06131a;
            --darker-bg: #030d12;
            --gold: #14b8a6;
            --gold-light: #7ee8dd;
            --text-primary: #ecf8f8;
            --text-secondary: #a8bac6;
            --accent: #14b8a6;
            --teal-accent: #38d3c4;
            --indigo-soft: rgba(20, 184, 166, 0.18);
            --purple-depth: rgba(12, 82, 94, 0.16);
            --page-glow-a: rgba(9, 58, 72, 0.33);
            --page-glow-b: rgba(22, 99, 108, 0.22);
            --page-base-start: #05131a;
            --page-base-end: #051019;
        }

        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.4), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 90% 60%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 33% 80%, rgba(255, 255, 255, 0.25), transparent),
                radial-gradient(1px 1px at 15% 90%, rgba(255, 255, 255, 0.2), transparent);
            background-size: 200% 200%;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #landing {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow: hidden;
            z-index: 1;
        }

        .moon {
            position: absolute;
            top: 10%;
            right: 10%;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                rgba(255, 255, 255, 0.14) 0%,
                rgba(255, 255, 255, 0.10) 40%,
                rgba(255, 255, 255, 0.06) 70%,
                transparent 100%);
            filter: blur(1px);
            animation: moonDrift 60s ease-in-out infinite;
            z-index: -1;
            will-change: transform;
        }

        .moon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%,
                rgba(255, 255, 255, 0.08),
                transparent 60%);
            filter: blur(2px);
        }

        .moon-crater {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            filter: blur(1px);
        }

        .crater-1 { top: 20%; left: 30%; width: 40px; height: 40px; }
        .crater-2 { top: 50%; left: 50%; width: 30px; height: 30px; }
        .crater-3 { top: 60%; left: 20%; width: 25px; height: 25px; }

        @keyframes moonDrift {
            0%, 100% {
                transform: translate(var(--moon-px, 0px), var(--moon-py, 0px)) rotate(0deg);
            }
            25% {
                transform: translate(calc(var(--moon-px, 0px) - 20px), calc(var(--moon-py, 0px) - 30px)) rotate(5deg);
            }
            50% {
                transform: translate(calc(var(--moon-px, 0px) - 10px), calc(var(--moon-py, 0px) - 50px)) rotate(10deg);
            }
            75% {
                transform: translate(calc(var(--moon-px, 0px) + 20px), calc(var(--moon-py, 0px) - 30px)) rotate(5deg);
            }
        }

        .hero-content {
            max-width: 900px;
            text-align: center;
            z-index: 2;
            animation: fadeUp 1s ease-out;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-title {
            font-size: clamp(4rem, 12vw, 8rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
            text-shadow: 0 0 40px rgba(212, 175, 55, 0.3);
        }

        .hero-subtitle {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: var(--text-secondary);
            margin-bottom: 3rem;
            font-weight: 300;
        }

        .verse-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .verse-text {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.8;
        }

        .verse-reference {
            color: var(--gold);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .cta-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 4rem;
        }

        .btn {
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--darker-bg);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(212, 175, 55, 0.28);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(20, 184, 166, 0.55);
            box-shadow: 0 8px 20px rgba(20, 184, 166, 0.14);
            transform: translateY(-1px);
        }

        .why-zakat {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .why-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .why-card:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .why-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .why-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gold);
        }

        .why-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        #how-it-works {
            padding: 6rem 2rem;
            background: transparent;
            position: relative;
            z-index: 1;
        }

        .section-title {
            text-align: center;
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 4rem;
            font-size: 1.1rem;
        }

        .steps-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2rem;
        }

        .step-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .step-card:hover::before {
            transform: scaleX(1);
        }

        .step-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            border-color: var(--gold);
        }

        .step-number {
            display: inline-block;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--darker-bg);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .step-text {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        #calculator {
            padding: 5rem 2rem;
            max-width: 1380px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            isolation: isolate;
            border-radius: 0;
            background: transparent;
            border: 0;
            box-shadow: none;
        }

        #calculator::before {
            display: none;
        }

        #calculator.spotlight-active::before {
            opacity: 1;
            transform: scale(1);
        }

        #calculator::after {
            display: none;
        }

        #calculator > * {
            position: relative;
            z-index: 1;
        }

        .calculator-header {
            text-align: center;
            margin-bottom: 3.5rem;
        }

        .calc-shell {
            display: grid;
            grid-template-columns: 155px minmax(0, 1fr);
            gap: 0.9rem;
            align-items: start;
        }

        .section-rail {
            position: sticky;
            top: 92px;
            align-self: start;
            display: grid;
            gap: 0.55rem;
            padding: 0.7rem;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.28);
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.22);
        }

        .rail-link {
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(15, 23, 42, 0.5);
            color: var(--text-secondary);
            border-radius: 12px;
            padding: 0.5rem 0.65rem;
            text-align: left;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .rail-link:hover {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .rail-link.active {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.72);
            background: rgba(212, 175, 55, 0.14);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.18);
        }

        .content-canvas {
            border-radius: 0;
            padding: 0.35rem 0;
            background: transparent;
            border: 0;
            box-shadow: none;
        }

        /* Premium themed asset panel (applies across all theme modes via vars). */
        #assetsCard {
            background: rgba(15, 23, 42, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }

        #assetsCard .calc-card-title {
            font-size: 2.1rem;
            color: color-mix(in srgb, var(--gold-light) 88%, #fff 12%);
            margin-bottom: 2rem;
        }

        #assetsCard .section-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            font-size: 1.08rem;
            background: linear-gradient(145deg, color-mix(in srgb, var(--gold) 84%, #fff 16%) 0%, color-mix(in srgb, var(--gold-light) 90%, #fff 10%) 100%);
            color: rgba(8, 12, 22, 0.9);
            border: 0;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.2);
        }

        #assetsCard .form-label {
            text-transform: uppercase;
            letter-spacing: 0.045em;
            font-size: 0.84rem;
            color: color-mix(in srgb, var(--gold-light) 78%, var(--text-primary) 22%);
            margin-bottom: 0.55rem;
        }

        #assetsCard .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.35rem;
            align-items: start;
        }

        #assetsCard .money-input {
            width: 100%;
            max-width: 100%;
        }

        #assetsCard .money-input .form-input {
            width: 100%;
            min-height: 64px;
            border-radius: 14px;
            background: rgba(4, 8, 14, 0.92);
            border: 1px solid color-mix(in srgb, var(--gold) 44%, rgba(148, 163, 184, 0.2));
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
            font-size: 1.1rem;
            padding-right: 5.8rem;
        }

        #assetsCard .money-input .form-input:focus {
            border-color: color-mix(in srgb, var(--gold-light) 86%, #fff 14%);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--gold) 24%, transparent), 0 10px 20px color-mix(in srgb, var(--gold) 20%, transparent);
            transform: translateY(-1px);
        }

        #assetsCard .currency-mini {
            top: 50%;
            right: 9px;
            transform: translateY(-50%);
            min-width: 62px;
            height: 34px;
            border-radius: 999px;
            border: 0;
            background: linear-gradient(145deg, color-mix(in srgb, var(--gold) 90%, #fff 10%) 0%, color-mix(in srgb, var(--gold-light) 86%, #fff 14%) 100%);
            color: rgba(8, 12, 22, 0.95);
            font-weight: 700;
            letter-spacing: 0.06em;
            font-size: 0.86rem;
            box-shadow: 0 6px 14px color-mix(in srgb, var(--gold) 36%, transparent);
        }

        #assetsCard .currency-mini[data-currency-for]:hover {
            box-shadow: 0 10px 20px color-mix(in srgb, var(--gold) 42%, transparent);
            transform: translateY(calc(-50% - 1px));
        }

        #assetsCard .currency-mini[data-currency-for]:focus-visible {
            transform: translateY(-50%);
        }

        .extra-asset-row .money-input {
            position: static;
            display: flex;
            align-items: center;
            min-height: 58px;
        }

        .extra-asset-row .extra-asset-currency-btn {
            position: static;
            transform: none;
            width: 100%;
            min-width: 72px;
            justify-content: center;
        }

        #assetsCard .split-link {
            color: color-mix(in srgb, var(--gold-light) 86%, var(--text-secondary) 14%);
            text-decoration: none;
            border-bottom: 1px dashed color-mix(in srgb, var(--gold) 52%, transparent);
        }

        #assetsCard .split-panel {
            border-top: 1px dashed color-mix(in srgb, var(--gold) 36%, rgba(148, 163, 184, 0.2));
        }

        #assetsCard .optional-accordion {
            margin-top: 1.8rem;
            border-radius: 20px;
            background: rgba(8, 15, 27, 0.42);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--gold) 24%, rgba(148, 163, 184, 0.14));
        }

        .header-actions {
            margin-top: 0.9rem;
            display: flex;
            justify-content: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .calculator-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .calculator-subtitle {
            color: var(--text-secondary);
        }

        .today-dates {
            margin-top: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .ramadan-meta {
            margin-top: 0.55rem;
            min-height: 26px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.55rem;
        }

        .ramadan-badge {
            display: none;
            padding: 0.22rem 0.65rem;
            border-radius: 999px;
            font-size: 0.78rem;
            border: 1px solid rgba(212, 175, 55, 0.45);
            color: #f4d47b;
            background: rgba(212, 175, 55, 0.12);
            letter-spacing: 0.01em;
        }

        .ramadan-crescent {
            display: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            position: relative;
            background: rgba(244, 212, 123, 0.65);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.35);
            animation: crescentFloat 3.8s ease-in-out infinite;
        }

        .ramadan-crescent::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            top: 1px;
            left: 4px;
            background: var(--dark-bg);
        }

        @keyframes crescentFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.85; }
            50% { transform: translateY(-2px) rotate(5deg); opacity: 1; }
        }

        body.ramadan-mode .calc-card,
        body.ramadan-mode .results-card {
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.14), 0 18px 34px rgba(212, 175, 55, 0.08);
        }

        body.ramadan-mode .ramadan-badge,
        body.ramadan-mode .ramadan-crescent {
            display: inline-block;
        }

        .quick-start {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .quick-step {
            border: 1px solid var(--border-color);
            background: rgba(15, 23, 42, 0.75);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.45rem 0.85rem;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: border-color 0.35s cubic-bezier(0.22, 1, 0.36, 1), box-shadow 0.35s cubic-bezier(0.22, 1, 0.36, 1), color 0.35s cubic-bezier(0.22, 1, 0.36, 1), transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .moon-phase {
            font-size: 0.95rem;
            line-height: 1;
            filter: saturate(0.9);
        }

        .quick-step:hover {
            border-color: var(--gold);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .quick-step.active {
            border-color: var(--gold);
            color: var(--text-primary);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.12), 0 6px 18px rgba(20, 184, 166, 0.2);
        }

        .quick-step.done {
            color: #9ce8be;
            border-color: rgba(16, 185, 129, 0.45);
            background: rgba(16, 185, 129, 0.08);
        }

        .quick-step.calculated {
            border-color: rgba(244, 212, 123, 0.75);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.12), 0 0 16px rgba(212, 175, 55, 0.22);
        }

        .quick-step.calculated .moon-phase {
            filter: drop-shadow(0 0 6px rgba(255, 228, 145, 0.7));
        }

        .quick-sep {
            color: var(--text-secondary);
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .calc-card {
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.08);
            border-radius: 28px;
            padding: 2.2rem;
            margin-bottom: 2.6rem;
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            position: relative;
            overflow: hidden;
        }

        .calc-card::after {
            content: "";
            position: absolute;
            left: 2.2rem;
            right: 2.2rem;
            bottom: 0;
            height: 1px;
            background: linear-gradient(90deg, rgba(148, 163, 184, 0), rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0));
            pointer-events: none;
        }

        .settings-accordion {
            padding: 0;
            overflow: hidden;
        }

        .settings-accordion > summary {
            list-style: none;
            cursor: pointer;
            padding: 2rem 2.2rem;
            margin: 0;
            user-select: none;
            position: relative;
        }

        .settings-accordion > summary::-webkit-details-marker {
            display: none;
        }

        .settings-accordion > summary::after {
            content: "+";
            position: absolute;
            right: 2.2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.35rem;
            color: var(--gold);
            line-height: 1;
        }

        .settings-accordion[open] > summary::after {
            content: "−";
        }

        .settings-content {
            padding: 0 2.2rem 2.2rem;
        }

        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.58s cubic-bezier(0.22, 1, 0.36, 1), transform 0.58s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reveal-on-scroll.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        .calc-card-title {
            font-size: 1.85rem;
            font-weight: 700;
            margin-bottom: 1.9rem;
            color: var(--gold);
            letter-spacing: 0.02em;
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
        }

        .section-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: rgba(212, 175, 55, 0.16);
            border: 1px solid rgba(212, 175, 55, 0.35);
            color: #f4d47b;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.85rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .amount-currency {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
        }

        .money-input {
            position: relative;
        }

        .money-input .form-input {
            padding-right: 5.8rem;
        }

        .currency-mini {
            position: absolute;
            right: 0.4rem;
            top: 50%;
            transform: translateY(-50%);
            border: 1px solid var(--border-color);
            background: rgba(30, 41, 59, 0.9);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.35rem 0.6rem;
            min-width: 56px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .currency-mini:hover {
            border-color: var(--teal-accent);
            box-shadow: 0 0 0 1px rgba(20, 184, 166, 0.24);
        }

        .split-link {
            margin-top: 0.6rem;
            align-self: flex-start;
            border: 0;
            background: transparent;
            color: var(--text-secondary);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
        }

        .split-panel {
            margin-top: 0.85rem;
            padding-top: 0.85rem;
            border-top: 1px dashed var(--border-color);
        }

        .split-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .optional-accordion {
            margin-top: 1.45rem;
            border: 0;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.3);
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
            overflow: hidden;
        }

        .optional-accordion > summary {
            list-style: none;
            cursor: pointer;
            padding: 0.95rem 1rem;
            color: var(--text-secondary);
            user-select: none;
        }

        .optional-accordion > summary::-webkit-details-marker {
            display: none;
        }

        .optional-accordion > summary::after {
            content: "+";
            float: right;
            color: var(--gold);
            font-weight: 700;
        }

        .optional-accordion[open] > summary::after {
            content: "-";
        }

        .optional-content {
            padding: 0 1rem 1rem;
        }

        .explain-toggle {
            margin-top: 0.5rem;
        }

        .explain-toggle > summary {
            list-style: none;
            cursor: pointer;
            font-size: 0.82rem;
            color: var(--text-secondary);
            text-decoration: underline;
        }

        .explain-toggle > summary::-webkit-details-marker {
            display: none;
        }

        .explain-content {
            margin-top: 0.45rem;
            padding: 0.65rem 0.75rem;
            border-radius: 10px;
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
            background: rgba(15, 23, 42, 0.45);
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.55;
        }

        .dual-currency {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .extra-assets {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .extra-assets-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .extra-assets-title {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .extra-assets-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .extra-asset-row {
            display: grid;
            grid-template-columns: 1.2fr 1fr 0.8fr auto;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .core-entry-list {
            margin-top: 0.55rem;
            display: grid;
            gap: 0.55rem;
        }

        .core-extra-row {
            display: grid;
            grid-template-columns: 1.15fr 1fr 0.65fr auto;
            gap: 0.65rem;
        }

        .core-extra-row .form-input {
            min-height: 48px;
            border-radius: 12px;
        }

        .core-extra-row .money-input {
            position: static;
            display: flex;
            align-items: center;
        }

        .core-extra-row .core-extra-currency-btn {
            position: static;
            transform: none;
            width: 100%;
            min-width: 72px;
            justify-content: center;
        }

        .mini-btn {
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 0.65rem 0.85rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .mini-btn:hover {
            border-color: var(--teal-accent);
            box-shadow: 0 6px 14px rgba(20, 184, 166, 0.12);
            transform: translateY(-1px);
        }

        .invoice-sheet {
            display: none;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .invoice-table th,
        .invoice-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.65rem 0;
            text-align: left;
        }

        .invoice-table td:last-child,
        .invoice-table th:last-child {
            text-align: right;
        }

        .form-label {
            font-size: 0.96rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.7rem;
        }

        .form-input {
            background: rgba(12, 20, 36, 0.78);
            border: 1px solid rgba(148, 163, 184, 0.14);
            border-radius: 18px;
            min-height: 58px;
            padding: 0 1.1rem;
            font-size: 1.04rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.14), 0 8px 18px rgba(212, 175, 55, 0.14);
            transform: translateY(-1px);
            animation: inputFocusPulse 380ms cubic-bezier(0.22, 1, 0.36, 1) 1;
        }

        .form-input::placeholder {
            color: rgba(148, 163, 184, 0.3);
        }

        .select-input {
            background: rgba(12, 20, 36, 0.78);
            border: 1px solid rgba(148, 163, 184, 0.14);
            border-radius: 18px;
            min-height: 58px;
            padding: 0 1.1rem;
            font-size: 1.04rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .currency-mini:focus-visible,
        .mini-btn:focus-visible,
        .split-link:focus-visible,
        .select-input:focus-visible {
            outline: none;
            border-color: var(--teal-accent);
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.2), 0 8px 18px rgba(20, 184, 166, 0.15);
            transform: translateY(-1px);
            animation: inputFocusPulse 380ms cubic-bezier(0.22, 1, 0.36, 1) 1;
        }

        .results-card {
            background: rgba(15, 23, 42, 0.45);
            border: 0;
            border-radius: 28px;
            padding: 2.8rem 2.4rem;
            margin-top: 2.2rem;
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            transform: translateY(-4px);
            position: relative;
            z-index: 3;
            text-align: center;
            overflow: hidden;
        }

        .results-card::before {
            display: none;
        }

        .results-card::after {
            content: "";
            position: absolute;
            left: 2.4rem;
            right: 2.4rem;
            bottom: 0;
            height: 1px;
            background: linear-gradient(90deg, rgba(148, 163, 184, 0), rgba(148, 163, 184, 0.24), rgba(148, 163, 184, 0));
            pointer-events: none;
        }

        .results-card > * {
            position: relative;
            z-index: 1;
        }

        .result-row {
            display: none;
        }

        .results-hero {
            max-width: 760px;
            margin: 0 auto 1rem;
            padding: 1.1rem 1rem 1.2rem;
            border-radius: 18px;
            background: linear-gradient(180deg, rgba(22, 45, 78, 0.62) 0%, rgba(15, 31, 55, 0.58) 100%);
            border: 1px solid rgba(148, 177, 214, 0.28);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04), 0 14px 28px rgba(3, 10, 24, 0.34);
        }

        .results-hero-status {
            color: rgba(206, 224, 246, 0.92);
            font-size: 0.92rem;
            margin-bottom: 0.7rem;
            letter-spacing: 0.01em;
        }

        .results-compact-grid {
            max-width: 760px;
            margin: 0.85rem auto 0.9rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .compact-stat {
            border: 1px solid rgba(148, 177, 214, 0.24);
            border-radius: 12px;
            background: rgba(11, 24, 43, 0.56);
            padding: 0.72rem 0.85rem;
            text-align: left;
        }

        .compact-stat-label {
            display: block;
            font-size: 0.72rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: rgba(194, 214, 240, 0.82);
            margin-bottom: 0.18rem;
        }

        .compact-stat-value {
            font-size: 1.02rem;
            font-weight: 700;
            color: #e8f1ff;
            text-shadow: 0 0 10px rgba(74, 135, 219, 0.2);
        }

        .breakdown-card {
            background: rgba(9, 20, 38, 0.56);
            border: 1px solid rgba(148, 177, 214, 0.2);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            padding: 0.9rem 0.9rem 0.55rem;
            margin: 0.3rem auto 1rem;
            max-width: 760px;
        }

        .breakdown-title {
            font-size: 0.95rem;
            color: rgba(212, 226, 246, 0.95);
            margin-bottom: 0.75rem;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.84rem;
            padding: 0.34rem 0;
            color: rgba(211, 225, 243, 0.9);
            border-bottom: 1px solid rgba(148, 177, 214, 0.18);
        }

        .history-card {
            margin-top: 2rem;
            background: rgba(15, 23, 42, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            border-top: 1px solid rgba(212, 175, 55, 0.35);
            border-radius: 18px;
            padding: 1.4rem;
        }

        .history-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .history-chart {
            width: 100%;
            height: 96px;
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.45);
            margin-bottom: 0.65rem;
        }

        .history-list {
            font-size: 0.88rem;
            color: var(--text-secondary);
            display: grid;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .hawl-card {
            margin-top: 1rem;
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.45);
            padding: 1rem;
        }

        .hawl-title {
            color: var(--text-secondary);
            font-size: 0.92rem;
            margin-bottom: 0.75rem;
        }

        .hawl-summary {
            margin-top: 0.75rem;
            display: grid;
            gap: 0.4rem;
        }

        .hawl-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.88rem;
            color: var(--text-secondary);
        }

        .due-badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.2rem 0.55rem;
            font-size: 0.78rem;
            font-weight: 700;
            border: 1px solid transparent;
            color: var(--text-primary);
            background: rgba(148, 163, 184, 0.16);
        }

        .due-badge.soon {
            background: rgba(251, 191, 36, 0.14);
            border-color: rgba(251, 191, 36, 0.45);
            color: #fde68a;
        }

        .due-badge.overdue {
            background: rgba(239, 68, 68, 0.14);
            border-color: rgba(239, 68, 68, 0.45);
            color: #fca5a5;
        }

        .result-label {
            font-size: 0.92rem;
            color: rgba(194, 214, 240, 0.86);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .result-value {
            font-size: 1.42rem;
            font-weight: 700;
            color: #e8f1ff;
            text-shadow: 0 0 14px rgba(74, 135, 219, 0.28);
        }

        .final-result {
            background:
                radial-gradient(420px 200px at 50% 40%, rgba(212, 175, 55, 0.34) 0%, rgba(212, 175, 55, 0.14) 42%, rgba(212, 175, 55, 0) 78%),
                linear-gradient(180deg, rgba(117, 92, 34, 0.74) 0%, rgba(74, 57, 20, 0.7) 100%);
            padding: 2rem 1.2rem 1.3rem;
            border-radius: 20px;
            text-align: center;
            margin-top: 0.2rem;
            position: relative;
            overflow: hidden;
            transform: scale(1);
            opacity: 1;
            animation: finalLoadIn 560ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
            isolation: isolate;
            box-shadow:
                inset 0 0 0 1px rgba(212, 175, 55, 0.54),
                0 6px 14px rgba(2, 6, 18, 0.24);
        }

        .final-result::before {
            content: "";
            position: absolute;
            inset: -20%;
            z-index: -1;
            background:
                radial-gradient(circle at 50% 50%, rgba(224, 189, 79, 0.36) 0%, rgba(212, 175, 55, 0.24) 28%, rgba(212, 175, 55, 0.07) 60%, rgba(212, 175, 55, 0) 82%);
            opacity: 0.25;
            animation: none;
        }

        .final-result::after {
            content: "";
            position: absolute;
            width: 220px;
            height: 220px;
            left: 50%;
            top: 45%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(233, 205, 118, 0.5) 0%, rgba(212, 175, 55, 0.08) 45%, rgba(212, 175, 55, 0) 72%);
            z-index: -1;
            opacity: 0.18;
        }

        .amount-divider {
            width: min(440px, 86%);
            height: 1px;
            margin: 0.9rem auto;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0), rgba(255, 218, 120, 0.98), rgba(212, 175, 55, 0));
            box-shadow: none;
        }

        .result-shimmer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(255, 243, 196, 0.9) 50%, rgba(212, 175, 55, 0) 100%);
            background-size: 220% 100%;
            animation: none;
            opacity: 0.35;
        }

        .final-label {
            font-size: 1.05rem;
            color: #D4AF37;
            font-weight: 600;
            margin-bottom: 0.35rem;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.28);
        }

        .final-amount {
            font-size: clamp(2.2rem, 4.6vw, 3.35rem);
            font-weight: 800;
            color: #ffefb6;
            text-shadow: none;
            position: relative;
            display: inline-block;
            z-index: 1;
            white-space: nowrap;
            line-height: 1.05;
        }

        .final-amount::before {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 260px;
            height: 120px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 239, 188, 0.4) 0%, rgba(212, 175, 55, 0.24) 40%, rgba(212, 175, 55, 0) 74%);
            z-index: -1;
            opacity: 0.12;
            animation: none;
        }

        .final-result.pulse-in {
            animation: finalValuePulse 420ms cubic-bezier(0.16, 1, 0.3, 1);
        }

        .final-subamount {
            margin-top: 0.45rem;
            font-size: 0.92rem;
            color: rgba(255, 240, 196, 0.88);
            font-weight: 600;
        }

        .nisab-status {
            margin: 0.75rem auto 0;
            max-width: 620px;
            padding: 0.45rem 0.65rem;
            border-radius: 10px;
            background: rgba(116, 87, 27, 0.24);
            color: #f8e5ab;
            border: 1px solid rgba(244, 212, 123, 0.3);
            text-align: center;
            font-size: 0.8rem;
            line-height: 1.35;
        }

        #backToTop {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--darker-bg);
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        #backToTop:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.4);
        }

        #backToTop.show {
            display: flex;
        }

        .info-box {
            background: rgba(16, 185, 129, 0.1);
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.25);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .calc-shell {
                grid-template-columns: 1fr;
            }

            .section-rail {
                display: none;
            }

            .content-canvas {
                padding: 0;
                border: 0;
                box-shadow: none;
                background: transparent;
            }

            .top-nav-inner {
                flex-direction: column;
                align-items: stretch;
                gap: 0.55rem;
            }

            .top-nav-logo {
                text-align: center;
            }

            .top-nav-controls {
                justify-content: center;
            }

            .top-nav-theme {
                min-width: 136px;
            }

            .nav-spacer {
                height: 90px;
            }

            .moon {
                width: 300px;
                height: 300px;
                top: 5%;
                right: -50px;
            }

            .hero-title {
                font-size: 4rem;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            #assetsCard .form-grid {
                grid-template-columns: 1fr;
            }

            #assetsCard .money-input .form-input {
                min-height: 58px;
                font-size: 1.02rem;
            }
            
            .results-compact-grid {
                grid-template-columns: 1fr;
            }
            
            .amount-currency {
                grid-template-columns: 1fr;
            }

            .dual-currency {
                grid-template-columns: 1fr;
            }

            .extra-asset-row {
                grid-template-columns: 1fr;
            }

            .core-extra-row {
                grid-template-columns: 1fr;
            }

            .final-amount {
                font-size: 2.5rem;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .reveal-on-scroll {
                opacity: 1 !important;
                transform: none !important;
            }

            .ramadan-crescent {
                animation: none !important;
            }

            .final-result,
            .final-result::before {
                animation: none !important;
            }

            .result-shimmer,
            .final-amount::before {
                animation: none !important;
            }

            .final-result {
                transform: none !important;
                opacity: 1 !important;
            }

            .form-input:focus,
            .currency-mini:focus-visible,
            .mini-btn:focus-visible,
            .split-link:focus-visible,
            .select-input:focus-visible {
                animation: none !important;
            }
        }

        @keyframes finalLoadIn {
            from { transform: scale(0.98); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes finalGlowPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes finalValuePulse {
            0% { transform: scale(0.985); opacity: 1; }
            70% { transform: scale(1.012); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shimmerSweep {
            0% { background-position: 200% 0; }
            100% { background-position: -120% 0; }
        }

        @keyframes amountAuraPulse {
            0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(0.97); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.04); }
        }

        @keyframes inputFocusPulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0), 0 0 0 rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.14), 0 8px 18px rgba(212, 175, 55, 0.14); }
        }

        html {
            scroll-behavior: smooth;
        }

        @media print {
            .starfield,
            .top-nav,
            .nav-spacer,
            .section-rail,
            #landing,
            #how-it-works,
            #backToTop,
            .mini-btn,
            .header-actions {
                display: none !important;
            }

            body {
                background: #fff !important;
                color: #000 !important;
            }

            #calculator {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            .calc-card,
            .results-card {
                border: 1px solid #ddd !important;
                background: #fff !important;
                box-shadow: none !important;
                break-inside: avoid;
            }

            .result-value,
            .final-amount,
            .calc-card-title,
            .calculator-title {
                color: #000 !important;
                -webkit-text-fill-color: #000 !important;
            }

            body.invoice-print #calculator {
                display: none !important;
            }

            body.invoice-print .invoice-sheet {
                display: block !important;
                max-width: 850px;
                margin: 0 auto;
                padding: 24px;
                color: #111827;
                font-family: "Segoe UI", Tahoma, sans-serif;
            }
        }
    </style>
</head>
<body>
    <div class="starfield"></div>
    <header class="top-nav" aria-label="Main navigation">
        <div class="top-nav-inner">
            <div class="top-nav-logo">Zakat App</div>
            <div class="top-nav-controls">
                <nav class="top-nav-links">
                    <button type="button" class="top-link active" data-nav-target="landing">Home</button>
                    <button type="button" class="top-link" data-nav-target="how-it-works">How It Works</button>
                    <button type="button" class="top-link" data-nav-target="calculator">Calculator</button>
                    <button type="button" class="top-link" data-nav-target="assetsCard">Assets</button>
                    <button type="button" class="top-link" data-nav-target="debtsCard">Debts</button>
                    <button type="button" class="top-link" data-nav-target="resultsCard">Results</button>
                    <button type="button" class="top-link" data-nav-target="historyCard">History</button>
                </nav>
                <select id="topThemeMode" class="top-nav-theme" aria-label="Theme mode">
                    <option value="midnight-gold">Midnight Gold</option>
                    <option value="emerald-night">Emerald Night</option>
                    <option value="royal-indigo">Royal Indigo</option>
                    <option value="teal-dawn">Teal Dawn</option>
                </select>
            </div>
        </div>
    </header>
    <div class="nav-spacer" aria-hidden="true"></div>

    <section id="landing">
        <div class="moon">
            <div class="moon-crater crater-1"></div>
            <div class="moon-crater crater-2"></div>
            <div class="moon-crater crater-3"></div>
        </div>

        <div class="hero-content">
            <h1 class="hero-title">Zakat</h1>
            <p class="hero-subtitle">Purify your wealth. Strengthen your community.</p>

            <div class="verse-container">
                <p class="verse-text">
                    "Take from their wealth a charity by which you purify them and cause them increase."
                </p>
                <p class="verse-reference">— Qur'an 9:103</p>
            </div>

            <div class="cta-buttons">
                <button id="calculateCtaBtn" class="btn btn-primary">Calculate Your Zakat</button>
                <a href="#how-it-works" class="btn btn-secondary">Learn How It Works</a>
            </div>

            <div class="why-zakat">
                <div class="why-card">
                    <div class="why-icon">✨</div>
                    <h3 class="why-title">Purifies Wealth</h3>
                    <p class="why-text">Brings barakah (blessing) to your earnings and possessions</p>
                </div>
                <div class="why-card">
                    <div class="why-icon">🤝</div>
                    <h3 class="why-title">Supports the Needy</h3>
                    <p class="why-text">Helps those in need and strengthens community bonds</p>
                </div>
                <div class="why-card">
                    <div class="why-icon">⚖️</div>
                    <h3 class="why-title">Social Balance</h3>
                    <p class="why-text">Creates equity and fulfills our responsibility to society</p>
                </div>
            </div>
        </div>
    </section>

    <section id="how-it-works">
        <h2 class="section-title">How Zakat is Calculated</h2>
        <p class="section-subtitle">A simple four-step process</p>

        <div class="steps-container">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3 class="step-title">Add Your Assets</h3>
                <p class="step-text">
                    Include cash, bank savings, gold, silver, stocks, crypto, business inventory, and any wealth you've held for one lunar year.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">2</div>
                <h3 class="step-title">Subtract Debts</h3>
                <p class="step-text">
                    Deduct short-term debts that are due within the year. Long-term debts like mortgages are typically not deducted.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">3</div>
                <h3 class="step-title">Check Nisab</h3>
                <p class="step-text">
                    Compare your net wealth with the nisab threshold (value of 87.48g gold or 612.36g silver). Zakat is due if you're above this.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">4</div>
                <h3 class="step-title">Pay 2.5%</h3>
                <p class="step-text">
                    If your wealth exceeds nisab for one full lunar year, pay 2.5% of your total zakatable wealth to eligible recipients.
                </p>
            </div>
        </div>
    </section>

    <section id="calculator">
        <div class="calculator-header">
            <h2 class="calculator-title">Zakat Calculator</h2>
            <p class="calculator-subtitle">Enter your financial details below</p>
            <p class="today-dates">
                Today (Gregorian): <span id="todayGregorian">-</span> |
                Today (Hijri): <span id="todayHijri">-</span>
            </p>
            <div class="ramadan-meta">
                <span class="ramadan-crescent" aria-hidden="true"></span>
                <span class="ramadan-badge" id="ramadanBadge">Ramadan Mubarak</span>
            </div>
            <div class="header-actions">
                <button type="button" id="exportInvoiceBtn" class="mini-btn">Export Invoice PDF</button>
            </div>
            <div class="quick-start" id="quickStartBar" aria-label="Quick start">
                <button type="button" class="quick-step active" data-target="assetsCard"><span class="moon-phase" aria-hidden="true">🌑</span><span>Assets</span></button>
                <span class="quick-sep">→</span>
                <button type="button" class="quick-step" data-target="debtsCard"><span class="moon-phase" aria-hidden="true">🌓</span><span>Debts</span></button>
                <span class="quick-sep">→</span>
                <button type="button" class="quick-step" data-target="resultsCard"><span class="moon-phase" aria-hidden="true">🌓</span><span>Result</span></button>
            </div>
        </div>
        <div class="calc-shell">
            <aside class="section-rail" aria-label="Calculator sections">
                <button type="button" class="rail-link active" data-rail-target="settingsCard">Settings</button>
                <button type="button" class="rail-link" data-rail-target="assetsCard">Assets</button>
                <button type="button" class="rail-link" data-rail-target="debtsCard">Debts</button>
                <button type="button" class="rail-link" data-rail-target="resultsCard">Results</button>
                <button type="button" class="rail-link" data-rail-target="historyCard">History</button>
            </aside>
            <div class="content-canvas">

        <details class="calc-card settings-accordion" id="settingsCard">
            <summary class="calc-card-title"><span class="section-icon">⚙️</span>Settings</summary>
            <div class="settings-content">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Display Currency</label>
                    <select id="currency" class="select-input form-input">
                        <option value="USD">USD ($)</option>
                        <option value="BDT">BDT</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Theme Mode</label>
                    <select id="themeMode" class="select-input form-input">
                        <option value="midnight-gold">Midnight Gold</option>
                        <option value="emerald-night">Emerald Night</option>
                        <option value="royal-indigo">Royal Indigo</option>
                        <option value="teal-dawn">Teal Dawn</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">USD to BDT Rate</label>
                    <input type="number" id="usdToBdt" class="form-input" value="122.30" step="0.01" placeholder="122.30">
                </div>

                <div class="form-group">
                    <label class="form-label">Nisab Calculation</label>
                    <select id="nisabType" class="select-input form-input">
                        <option value="silver">Silver (612.36g) - Recommended</option>
                        <option value="gold">Gold (87.48g)</option>
                    </select>
                    <details class="explain-toggle">
                        <summary>Why Silver is Recommended?</summary>
                        <div class="explain-content">
                            Silver nisab is lower than gold nisab, so more people who are able to contribute are included.
                            This tends to increase support reaching poor and eligible recipients.
                            Many scholars recommend silver-based nisab for this broader social benefit, while gold remains an accepted opinion.
                        </div>
                    </details>
                </div>

                <div class="form-group">
                    <label class="form-label">Gold Price per Gram (USD)</label>
                    <input type="number" id="goldPrice" class="form-input" value="159.93" step="0.01" placeholder="159.93">
                </div>

                <div class="form-group">
                    <label class="form-label">Silver Price per Gram (USD)</label>
                    <input type="number" id="silverPrice" class="form-input" value="2.52" step="0.01" placeholder="2.52">
                </div>
            </div>
            <div class="hawl-card">
                <div class="hawl-title">Zakat Date + Hawl Reminder</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Your Zakat Date (Hijri)</label>
                        <div class="amount-currency">
                            <select id="zakatHijriMonth" class="select-input form-input">
                                <option value="">Month</option>
                                <option>Muḥarram</option>
                                <option>Safar</option>
                                <option>Rabi al-Awwal</option>
                                <option>Rabi al-Thani</option>
                                <option>Jumada al-Ula</option>
                                <option>Jumada al-Akhirah</option>
                                <option>Rajab</option>
                                <option>Sha’ban</option>
                                <option>Ramadan</option>
                                <option>Shawwal</option>
                                <option>Dhu al-Qadah</option>
                                <option>Dhu al-Hijjah</option>
                            </select>
                            <select id="zakatHijriDay" class="select-input form-input">
                                <option value="">Day</option>
                            </select>
                        </div>
                        <input type="text" id="zakatHijriNote" class="form-input" placeholder="Optional note (e.g., 1 Ramadan)" style="margin-top:0.6rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Zakat Paid (Gregorian)</label>
                        <input type="date" id="lastZakatPaid" class="form-input">
                    </div>
                </div>
                <div class="hawl-summary">
                    <div class="hawl-row"><span>Zakat Date</span><strong id="zakatDateSummary">-</strong></div>
                    <div class="hawl-row"><span>Last Paid</span><strong id="lastPaidSummary">-</strong></div>
                    <div class="hawl-row"><span>Next Due (estimate)</span><strong id="nextDueSummary">-</strong></div>
                    <div class="hawl-row"><span>Status</span><span class="due-badge" id="dueStatusBadge">On track</span></div>
                </div>
            </div>
            <div class="info-box">
                <p><strong>Defaults are examples:</strong> Update with today’s market rates or enter your own.</p>
            </div>
            </div>
        </details>

        <div class="calc-card" id="assetsCard">
            <h3 class="calc-card-title"><span class="section-icon">💎</span>Your Assets</h3>
            <p class="form-label">Core Assets</p>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Cash & Bank (Total)</label>
                    <div class="money-input">
                        <input type="number" id="cashBankTotalAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="cashBankTotalCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="cashBankTotalCur">BDT</button>
                    </div>
                    <button type="button" class="split-link" id="splitCashBankBtn">Split details</button>
                    <div class="split-panel" id="splitCashBankPanel" hidden>
                        <div class="split-grid">
                            <div class="form-group">
                                <label class="form-label">Cash at Home</label>
                                <div class="money-input">
                                    <input type="number" id="cashAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                                    <input type="hidden" id="cashCur" value="BDT">
                                    <button type="button" class="currency-mini" data-currency-for="cashCur">BDT</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bank Balance</label>
                                <div class="money-input">
                                    <input type="number" id="bankAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                                    <input type="hidden" id="bankCur" value="BDT">
                                    <button type="button" class="currency-mini" data-currency-for="bankCur">BDT</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="cashBank">+ Add entry</button>
                    <div class="core-entry-list" id="cashBankExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Stocks & Investments</label>
                    <div class="money-input">
                        <input type="number" id="investmentsAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="investmentsCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="investmentsCur">BDT</button>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="stocks">+ Add entry</button>
                    <div class="core-entry-list" id="stocksExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Gold (Cash Value)</label>
                    <div class="money-input">
                        <input type="number" id="goldAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="goldCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="goldCur">BDT</button>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="gold">+ Add entry</button>
                    <div class="core-entry-list" id="goldExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Silver (Cash Value)</label>
                    <div class="money-input">
                        <input type="number" id="silverAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="silverCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="silverCur">BDT</button>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="silver">+ Add entry</button>
                    <div class="core-entry-list" id="silverExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Business Inventory</label>
                    <div class="money-input">
                        <input type="number" id="businessAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="businessCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="businessCur">BDT</button>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="business">+ Add entry</button>
                    <div class="core-entry-list" id="businessExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Money Owed to You</label>
                    <div class="money-input">
                        <input type="number" id="receivablesAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="receivablesCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="receivablesCur">BDT</button>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="receivables">+ Add entry</button>
                    <div class="core-entry-list" id="receivablesExtraList"></div>
                </div>
            </div>

            <details class="optional-accordion">
                <summary>Additional fields</summary>
                <div class="optional-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Digital Assets</label>
                            <div class="money-input">
                                <input type="number" id="digitalAssetsAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                                <input type="hidden" id="digitalAssetsCur" value="BDT">
                                <button type="button" class="currency-mini" data-currency-for="digitalAssetsCur">BDT</button>
                            </div>
                        </div>
                    </div>
                    <div class="extra-assets">
                        <div class="extra-assets-header">
                            <div class="extra-assets-title">Additional Asset Entries</div>
                            <div class="extra-assets-actions">
                                <button type="button" id="addAssetRowBtn" class="mini-btn">+ Add Entry</button>
                            </div>
                        </div>
                        <div id="extraAssetsList"></div>
                    </div>
                </div>
            </details>
        </div>

        <div class="calc-card" id="debtsCard">
            <h3 class="calc-card-title"><span class="section-icon">🧾</span>Liabilities</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Short-term Debts (due within year)</label>
                    <div class="money-input">
                        <input type="number" id="debtsAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="debtsCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="debtsCur">BDT</button>
                    </div>
                </div>
            </div>
            <div class="info-box">
                <p><strong>Note:</strong> Only include debts due within the current year. Long-term debts like mortgages are typically not deducted from zakatable wealth.</p>
            </div>
        </div>

        <div class="info-box">
            <p>
                <strong>Important:</strong> This calculator provides an estimate. Zakat is due if you've held wealth above nisab for one complete lunar year (Hawl).
                For specific cases or questions, please consult with a qualified Islamic scholar.
            </p>
        </div>
        <div class="results-card" id="resultsCard">
            <h3 class="calc-card-title"><span class="section-icon">📊</span>Results</h3>
            <div class="results-hero">
                <p class="results-hero-status" id="resultsHeroStatus">Your current status will appear here.</p>
                <div class="final-result">
                    <span class="result-shimmer" aria-hidden="true"></span>
                    <div class="final-label" id="zakatAmountLabel">Your Zakat Due (2.5%)</div>
                    <div class="amount-divider" aria-hidden="true"></div>
                    <div class="final-amount" id="zakatAmount">BDT 0.00</div>
                    <div class="amount-divider" aria-hidden="true"></div>
                    <div class="final-subamount" id="zakatAmountSecondary">USD 0.00</div>
                    <div class="nisab-status" id="nisabStatus"></div>
                </div>
            </div>

            <div class="results-compact-grid">
                <div class="compact-stat">
                    <span class="compact-stat-label">Total Assets</span>
                    <span class="compact-stat-value" id="totalAssets">$0.00</span>
                </div>
                <div class="compact-stat">
                    <span class="compact-stat-label">Total Liabilities</span>
                    <span class="compact-stat-value" id="totalLiabilities">$0.00</span>
                </div>
                <div class="compact-stat">
                    <span class="compact-stat-label">Zakatable Wealth</span>
                    <span class="compact-stat-value" id="zakatableWealth">$0.00</span>
                </div>
                <div class="compact-stat">
                    <span class="compact-stat-label">Nisab Threshold</span>
                    <span class="compact-stat-value" id="nisabThreshold">$0.00</span>
                </div>
            </div>

            <div class="breakdown-card">
                <div class="breakdown-title">Breakdown</div>
                <div class="breakdown-row"><span>Cash + Bank</span><strong id="bdCashBank">-</strong></div>
                <div class="breakdown-row"><span>Metals</span><strong id="bdMetals">-</strong></div>
                <div class="breakdown-row"><span>Digital Assets</span><strong id="bdCrypto">-</strong></div>
                <div class="breakdown-row"><span>Stocks</span><strong id="bdStocks">-</strong></div>
                <div class="breakdown-row"><span>Business</span><strong id="bdBusiness">-</strong></div>
                <div class="breakdown-row"><span>Receivables</span><strong id="bdReceivables">-</strong></div>
                <div class="breakdown-row"><span>Extra assets</span><strong id="bdExtraAssets">-</strong></div>
                <div class="breakdown-row"><span>Debts deducted</span><strong id="bdDebts">-</strong></div>
            </div>

        </div>

        <div class="calc-card history-card" id="historyCard">
            <h3 class="calc-card-title"><span class="section-icon">📈</span>Zakat History Tracker</h3>
            <div class="history-actions">
                <input type="number" id="historyYear" class="form-input" min="1900" max="2200" placeholder="Year (e.g., 2026)">
                <button type="button" id="saveHistoryBtn" class="mini-btn">Save Year</button>
            </div>
            <svg id="historyChart" class="history-chart" viewBox="0 0 100 40" preserveAspectRatio="none" aria-label="Zakat history line chart"></svg>
            <div class="history-list" id="historyList">No history saved yet.</div>
            <div class="breakdown-row"><span>Total zakat given (lifetime)</span><strong id="historyLifetime">BDT 0.00</strong></div>
        </div>
            </div>
        </div>
    </section>

    <section id="invoiceSheet" class="invoice-sheet" aria-hidden="true">
        <h1>Zakat Invoice</h1>
        <p id="invoiceGeneratedOn">Generated on: -</p>
        <table class="invoice-table">
            <tbody>
                <tr><th>Total Assets</th><td id="invoiceTotalAssets">-</td></tr>
                <tr><th>Total Liabilities</th><td id="invoiceTotalLiabilities">-</td></tr>
                <tr><th>Net Zakatable Wealth</th><td id="invoiceZakatableWealth">-</td></tr>
                <tr><th>Nisab Threshold</th><td id="invoiceNisabThreshold">-</td></tr>
                <tr><th>Zakat Status</th><td id="invoiceNisabStatus">-</td></tr>
                <tr><th>Zakat Due (BDT)</th><td id="invoiceZakatAmount">-</td></tr>
            </tbody>
        </table>
    </section>

    <button id="backToTop">↑</button>

    <script>
        const currencySymbols = {
            'USD': '$',
            'BDT': 'BDT '
        };
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const runningAnimations = new WeakMap();
        const zakatHistoryStorageKey = 'zakatHistoryData';
        const themeStorageKey = 'zakatThemeMode';
        const elementCache = new Map();
        const formatterCache = new Map();
        let saveTimer = null;
        let midnightRefreshTimer = null;
        let scrollRafId = null;
        let quickStepButtons = [];
        let quickStepSections = [];
        let topNavLinks = [];
        let topNavSections = [];
        let railLinks = [];
        let railSections = [];
        const calcInputIds = new Set([
            'usdToBdt', 'goldPrice', 'silverPrice', 'zakatHijriMonth', 'zakatHijriDay', 'zakatHijriNote',
            'lastZakatPaid', 'cashBankTotalAmt', 'cashAmt', 'bankAmt', 'investmentsAmt',
            'goldAmt', 'silverAmt', 'businessAmt', 'receivablesAmt', 'digitalAssetsAmt', 'debtsAmt', 'currency', 'nisabType', 'themeMode'
        ]);
        let latestZakatAmountBdt = 0;

        function byId(id) {
            if (!elementCache.has(id)) {
                elementCache.set(id, document.getElementById(id));
            }
            return elementCache.get(id);
        }

        function getCurrencyFormatter(currency) {
            if (!formatterCache.has(currency)) {
                formatterCache.set(currency, new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }));
            }
            return formatterCache.get(currency);
        }

        function scheduleSaveData(delayMs = 300) {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveData();
                saveTimer = null;
            }, delayMs);
        }

        function applyTheme(themeMode) {
            const allowed = new Set(['midnight-gold', 'emerald-night', 'royal-indigo', 'teal-dawn']);
            const mode = allowed.has(themeMode) ? themeMode : 'midnight-gold';
            document.body.setAttribute('data-theme', mode);
            const themeEl = byId('themeMode');
            if (themeEl && themeEl.value !== mode) themeEl.value = mode;
            const topThemeEl = byId('topThemeMode');
            if (topThemeEl && topThemeEl.value !== mode) topThemeEl.value = mode;
        }

        function getZakatHistory() {
            try {
                const raw = localStorage.getItem(zakatHistoryStorageKey);
                const parsed = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parsed)) return [];
                return parsed
                    .map((x) => ({ year: parseInt(x.year, 10), amountBdt: parseFloat(x.amountBdt) || 0 }))
                    .filter((x) => Number.isFinite(x.year));
            } catch (_) {
                return [];
            }
        }

        function setZakatHistory(rows) {
            localStorage.setItem(zakatHistoryStorageKey, JSON.stringify(rows));
        }

        function upsertZakatHistory(year, amountBdt) {
            const y = parseInt(year, 10);
            if (!Number.isFinite(y)) return;
            const rows = getZakatHistory();
            const idx = rows.findIndex((r) => r.year === y);
            const safeAmount = Number.isFinite(amountBdt) ? amountBdt : 0;
            if (idx >= 0) rows[idx].amountBdt = safeAmount;
            else rows.push({ year: y, amountBdt: safeAmount });
            rows.sort((a, b) => a.year - b.year);
            setZakatHistory(rows);
            renderZakatHistory();
        }

        function renderZakatHistory() {
            const rows = getZakatHistory().sort((a, b) => a.year - b.year);
            const listEl = document.getElementById('historyList');
            const lifeEl = document.getElementById('historyLifetime');
            const chartEl = document.getElementById('historyChart');
            if (!listEl || !lifeEl || !chartEl) return;

            const formatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            listEl.innerHTML = rows.length
                ? rows.map((r) => `<div>${r.year} — BDT ${formatter.format(r.amountBdt)}</div>`).join('')
                : 'No history saved yet.';

            const lifetime = rows.reduce((sum, r) => sum + (r.amountBdt || 0), 0);
            lifeEl.textContent = `BDT ${formatter.format(lifetime)}`;

            if (!rows.length) {
                chartEl.innerHTML = '<text x="50" y="22" text-anchor="middle" font-size="4" fill="#94a3b8">No data yet</text>';
                return;
            }

            const w = 100;
            const h = 40;
            const px = 5;
            const py = 4;
            const min = Math.min(...rows.map((r) => r.amountBdt));
            const max = Math.max(...rows.map((r) => r.amountBdt));
            const spread = Math.max(1, max - min);

            const points = rows.map((r, i) => {
                const x = rows.length === 1 ? (w / 2) : (px + (i * (w - 2 * px)) / (rows.length - 1));
                const y = h - py - (((r.amountBdt - min) / spread) * (h - 2 * py));
                return { x, y };
            });

            const polylinePoints = points.map((p) => `${p.x.toFixed(2)},${p.y.toFixed(2)}`).join(' ');
            const dots = points.map((p) => `<circle cx="${p.x.toFixed(2)}" cy="${p.y.toFixed(2)}" r="1.1" fill="#d4af37"></circle>`).join('');
            chartEl.innerHTML = `
                <line x1="${px}" y1="${h - py}" x2="${w - px}" y2="${h - py}" stroke="rgba(148,163,184,0.5)" stroke-width="0.4"></line>
                <polyline fill="none" stroke="#d4af37" stroke-width="0.8" points="${polylinePoints}"></polyline>
                ${dots}
            `;
        }

        function animateNumber(el, targetValue, renderFn, duration = 560) {
            if (!el) return;
            const safeTarget = Number.isFinite(targetValue) ? targetValue : 0;
            const currentValue = parseFloat(el.dataset.animValue || `${safeTarget}`);
            if (runningAnimations.has(el)) {
                cancelAnimationFrame(runningAnimations.get(el));
                runningAnimations.delete(el);
            }
            if (prefersReducedMotion) {
                renderFn(safeTarget);
                el.dataset.animValue = String(safeTarget);
                return;
            }

            const start = Number.isFinite(currentValue) ? currentValue : safeTarget;
            const startTime = performance.now();
            const easeOut = (t) => 1 - Math.pow(1 - t, 4);

            const tick = (now) => {
                const progress = Math.min(1, (now - startTime) / duration);
                const eased = easeOut(progress);
                const value = start + (safeTarget - start) * eased;
                renderFn(value);
                if (progress < 1) {
                    runningAnimations.set(el, requestAnimationFrame(tick));
                } else {
                    el.dataset.animValue = String(safeTarget);
                    runningAnimations.delete(el);
                }
            };

            runningAnimations.set(el, requestAnimationFrame(tick));
        }

        function setupScrollReveal() {
            const cards = document.querySelectorAll('#calculator .calc-card, #calculator .results-card, #calculator .info-box');
            cards.forEach((el, index) => {
                el.classList.add('reveal-on-scroll');
                el.style.transitionDelay = `${index * 100}ms`;
            });
            if (prefersReducedMotion || !('IntersectionObserver' in window)) {
                cards.forEach((el) => el.classList.add('revealed'));
                return;
            }

            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.12 });

            cards.forEach((el) => observer.observe(el));
        }

        function setupMoonParallax() {
            const landing = document.getElementById('landing');
            const moon = document.querySelector('.moon');
            if (!landing || !moon || prefersReducedMotion) return;

            let rafId = null;
            let targetX = 0;
            let targetY = 0;
            let currentX = 0;
            let currentY = 0;

            const tick = () => {
                currentX += (targetX - currentX) * 0.12;
                currentY += (targetY - currentY) * 0.12;
                moon.style.setProperty('--moon-px', `${currentX.toFixed(2)}px`);
                moon.style.setProperty('--moon-py', `${currentY.toFixed(2)}px`);

                if (Math.abs(targetX - currentX) > 0.05 || Math.abs(targetY - currentY) > 0.05) {
                    rafId = requestAnimationFrame(tick);
                } else {
                    rafId = null;
                }
            };

            const startTick = () => {
                if (!rafId) rafId = requestAnimationFrame(tick);
            };

            landing.addEventListener('mousemove', (event) => {
                const rect = landing.getBoundingClientRect();
                const nx = ((event.clientX - rect.left) / rect.width) - 0.5;
                const ny = ((event.clientY - rect.top) / rect.height) - 0.5;
                targetX = nx * 6; // very subtle: ~3px range each side
                targetY = ny * 6;
                startTick();
            });

            landing.addEventListener('mouseleave', () => {
                targetX = 0;
                targetY = 0;
                startTick();
            });
        }

        function addExtraAssetRow(entry = {}) {
            const list = document.getElementById('extraAssetsList');
            if (!list) return;
            const defaultCurrency = document.getElementById('currency')?.value || 'BDT';

            const row = document.createElement('div');
            row.className = 'extra-asset-row';
            row.innerHTML = `
                <select class="select-input form-input extra-asset-type">
                    <option value="Cash">Cash</option>
                    <option value="Bank">Bank</option>
                    <option value="Gold">Gold</option>
                    <option value="Silver">Silver</option>
                    <option value="Stocks">Stocks</option>
                    <option value="Digital Assets">Digital Assets</option>
                    <option value="Business">Business</option>
                    <option value="Receivable">Receivable</option>
                    <option value="Other">Other</option>
                </select>
                <input type="number" class="form-input extra-asset-amount" step="0.01" placeholder="Amount" value="${entry.amount || 0}">
                <div class="money-input">
                    <input type="hidden" class="extra-asset-currency" value="${entry.currency || defaultCurrency}">
                    <button type="button" class="currency-mini extra-asset-currency-btn">${entry.currency || defaultCurrency}</button>
                </div>
                <button type="button" class="mini-btn remove-asset-row">Remove</button>
            `;

            row.querySelector('.extra-asset-type').value = entry.type || 'Other';
            row.querySelectorAll('input, select').forEach((el) => {
                el.addEventListener('input', calculateZakat);
                el.addEventListener('change', calculateZakat);
            });
            row.querySelector('.remove-asset-row').addEventListener('click', () => {
                row.remove();
                calculateZakat();
            });
            list.appendChild(row);
        }

        function addCoreExtraRow(field, entry = {}) {
            const list = byId(`${field}ExtraList`);
            if (!list) return;
            const defaultCurrency = byId('currency')?.value || 'BDT';

            const row = document.createElement('div');
            row.className = 'core-extra-row';
            row.dataset.field = field;
            row.innerHTML = `
                <input type="text" class="form-input core-extra-label" placeholder="Source (optional)" value="${entry.label || ''}">
                <input type="number" class="form-input core-extra-amount" step="0.01" placeholder="Amount" value="${entry.amount || 0}">
                <div class="money-input">
                    <input type="hidden" class="core-extra-currency" value="${entry.currency || defaultCurrency}">
                    <button type="button" class="currency-mini core-extra-currency-btn">${entry.currency || defaultCurrency}</button>
                </div>
                <button type="button" class="mini-btn remove-core-row">Remove</button>
            `;

            row.querySelectorAll('input').forEach((el) => {
                el.addEventListener('input', calculateZakat);
                el.addEventListener('change', calculateZakat);
            });
            row.querySelector('.remove-core-row').addEventListener('click', () => {
                row.remove();
                calculateZakat();
            });
            list.appendChild(row);
        }

        function serializeCoreExtraEntries() {
            const fields = ['cashBank', 'stocks', 'gold', 'silver', 'business', 'receivables'];
            const data = {};
            fields.forEach((field) => {
                const rows = [];
                byId(`${field}ExtraList`)?.querySelectorAll('.core-extra-row').forEach((row) => {
                    rows.push({
                        label: row.querySelector('.core-extra-label')?.value || '',
                        amount: row.querySelector('.core-extra-amount')?.value || '0',
                        currency: row.querySelector('.core-extra-currency')?.value || 'BDT'
                    });
                });
                data[field] = rows;
            });
            return data;
        }

        function restoreCoreExtraEntries(data) {
            const fields = ['cashBank', 'stocks', 'gold', 'silver', 'business', 'receivables'];
            fields.forEach((field) => {
                const list = byId(`${field}ExtraList`);
                if (!list) return;
                list.innerHTML = '';
                (data?.[field] || []).forEach((entry) => addCoreExtraRow(field, entry));
            });
        }

        function getCoreExtraTotalBdt(field, toBdt) {
            let total = 0;
            byId(`${field}ExtraList`)?.querySelectorAll('.core-extra-row').forEach((row) => {
                const amount = parseFloat(row.querySelector('.core-extra-amount')?.value) || 0;
                const currency = row.querySelector('.core-extra-currency')?.value || 'BDT';
                total += toBdt(amount, currency);
            });
            return total;
        }

        function updateCurrencyMiniButtons() {
            document.querySelectorAll('.currency-mini[data-currency-for]').forEach((btn) => {
                const id = btn.getAttribute('data-currency-for');
                const hidden = id ? document.getElementById(id) : null;
                if (hidden) btn.textContent = hidden.value || 'BDT';
            });
        }

        function toggleCurrencyFor(hiddenId) {
            const hidden = document.getElementById(hiddenId);
            if (!hidden) return;
            hidden.value = hidden.value === 'USD' ? 'BDT' : 'USD';
            updateCurrencyMiniButtons();
            calculateZakat();
        }

        function syncDefaultCurrenciesToMain() {
            const mainCurrency = document.getElementById('currency')?.value || 'BDT';
            const fieldMap = {
                cashBankTotalCur: 'cashBankTotalAmt',
                cashCur: 'cashAmt',
                bankCur: 'bankAmt',
                goldCur: 'goldAmt',
                silverCur: 'silverAmt',
                investmentsCur: 'investmentsAmt',
                digitalAssetsCur: 'digitalAssetsAmt',
                businessCur: 'businessAmt',
                receivablesCur: 'receivablesAmt',
                debtsCur: 'debtsAmt'
            };

            Object.keys(fieldMap).forEach((curId) => {
                const curEl = document.getElementById(curId);
                const amtEl = document.getElementById(fieldMap[curId]);
                if (!curEl || !amtEl) return;
                const amount = parseFloat(amtEl.value) || 0;
                if (!curEl.value || amount === 0) curEl.value = mainCurrency;
            });

            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                const amount = parseFloat(row.querySelector('.extra-asset-amount')?.value) || 0;
                const curEl = row.querySelector('.extra-asset-currency');
                const curBtn = row.querySelector('.extra-asset-currency-btn');
                if (!curEl) return;
                if (!curEl.value || amount === 0) curEl.value = mainCurrency;
                if (curBtn) curBtn.textContent = curEl.value;
            });

            updateCurrencyMiniButtons();
        }

        function handleMainCurrencyChange() {
            syncDefaultCurrenciesToMain();
            calculateZakat();
        }

        function getExtraAssetsBdt(toBdt) {
            let total = 0;
            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                const amount = parseFloat(row.querySelector('.extra-asset-amount')?.value) || 0;
                const currency = row.querySelector('.extra-asset-currency')?.value || 'BDT';
                total += toBdt(amount, currency);
            });
            return total;
        }

        function serializeExtraAssets() {
            const rows = [];
            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                rows.push({
                    type: row.querySelector('.extra-asset-type')?.value || 'Other',
                    amount: row.querySelector('.extra-asset-amount')?.value || '0',
                    currency: row.querySelector('.extra-asset-currency')?.value || 'BDT'
                });
            });
            return rows;
        }

        function restoreExtraAssets(entries) {
            const list = document.getElementById('extraAssetsList');
            if (!list) return;
            list.innerHTML = '';
            (entries || []).forEach((entry) => addExtraAssetRow(entry));
        }

        function updateCurrentDates() {
            const now = new Date();
            const gregorianEl = document.getElementById('todayGregorian');
            const hijriEl = document.getElementById('todayHijri');
            if (!gregorianEl || !hijriEl) return;

            const gregorianDate = new Intl.DateTimeFormat('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).format(now);
            gregorianEl.textContent = gregorianDate;

            try {
                const hijriFormatter = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                const calendarName = hijriFormatter.resolvedOptions().calendar || '';
                if (!calendarName.toLowerCase().startsWith('islamic')) {
                    throw new Error('Hijri calendar not supported');
                }
                const parts = hijriFormatter.formatToParts(now);
                const monthPart = parts.find((p) => p.type === 'month')?.value || '';
                hijriEl.textContent = hijriFormatter.format(now) + ' AH';

                const isRamadan = monthPart.toLowerCase().includes('ramadan');
                document.body.classList.toggle('ramadan-mode', isRamadan);
            } catch (e) {
                hijriEl.textContent = 'Hijri date not supported on this device';
                document.body.classList.remove('ramadan-mode');
            }
        }

        function scheduleDateRefreshAtMidnight() {
            if (midnightRefreshTimer) clearTimeout(midnightRefreshTimer);
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const msUntilMidnight = nextMidnight.getTime() - now.getTime();

            midnightRefreshTimer = setTimeout(() => {
                updateCurrentDates();
                scheduleDateRefreshAtMidnight();
            }, msUntilMidnight);
        }

        function fillHijriDayOptions() {
            const daySelect = document.getElementById('zakatHijriDay');
            if (!daySelect || daySelect.options.length > 1) return;
            for (let d = 1; d <= 30; d += 1) {
                const option = document.createElement('option');
                option.value = String(d);
                option.textContent = String(d);
                daySelect.appendChild(option);
            }
        }

        function formatIsoDate(isoDate) {
            if (!isoDate) return '-';
            const dt = new Date(`${isoDate}T00:00:00`);
            if (Number.isNaN(dt.getTime())) return '-';
            return new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).format(dt);
        }

        function addDaysToIso(isoDate, days) {
            if (!isoDate) return '';
            const dt = new Date(`${isoDate}T00:00:00`);
            if (Number.isNaN(dt.getTime())) return '';
            dt.setDate(dt.getDate() + days);
            return dt.toISOString().slice(0, 10);
        }

        function updateHawlReminderUI() {
            const hijriDay = document.getElementById('zakatHijriDay')?.value || '';
            const hijriMonth = document.getElementById('zakatHijriMonth')?.value || '';
            const hijriNote = document.getElementById('zakatHijriNote')?.value?.trim() || '';
            const lastPaid = document.getElementById('lastZakatPaid')?.value || '';

            const zakatDateText = hijriNote || ((hijriDay && hijriMonth) ? `${hijriDay} ${hijriMonth}` : '-');
            const nextDueIso = addDaysToIso(lastPaid, 354);

            const zakatDateSummary = document.getElementById('zakatDateSummary');
            const lastPaidSummary = document.getElementById('lastPaidSummary');
            const nextDueSummary = document.getElementById('nextDueSummary');
            const dueStatusBadge = document.getElementById('dueStatusBadge');
            if (!zakatDateSummary || !lastPaidSummary || !nextDueSummary || !dueStatusBadge) return;

            zakatDateSummary.textContent = zakatDateText;
            lastPaidSummary.textContent = formatIsoDate(lastPaid);
            nextDueSummary.textContent = nextDueIso ? formatIsoDate(nextDueIso) : '-';

            dueStatusBadge.classList.remove('soon', 'overdue');
            dueStatusBadge.textContent = 'On track';

            if (nextDueIso) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const nextDue = new Date(`${nextDueIso}T00:00:00`);
                const msDiff = nextDue.getTime() - today.getTime();
                const daysDiff = Math.floor(msDiff / (24 * 60 * 60 * 1000));
                if (daysDiff < 0) {
                    dueStatusBadge.textContent = 'Overdue';
                    dueStatusBadge.classList.add('overdue');
                } else if (daysDiff <= 14) {
                    dueStatusBadge.textContent = 'Due soon';
                    dueStatusBadge.classList.add('soon');
                }
            }
        }

        function recalcFast() {
            const currency = byId('currency').value;
            const symbol = currencySymbols[currency];
            const nisabType = byId('nisabType').value;
            const goldPrice = parseFloat(byId('goldPrice').value) || 0;
            const silverPrice = parseFloat(byId('silverPrice').value) || 0;
            const usdToBdt = parseFloat(byId('usdToBdt').value) || 0;

            const read = (id) => parseFloat(byId(id).value) || 0;
            const toBdt = (amount, entryCurrency) => {
                if (entryCurrency === 'BDT') return amount;
                if (entryCurrency === 'USD') return amount * usdToBdt;
                return 0;
            };
            const bdtToDisplay = (amountBdt) => (currency === 'BDT' ? amountBdt : (usdToBdt > 0 ? (amountBdt / usdToBdt) : 0));

            const splitCash = read('cashAmt');
            const splitBank = read('bankAmt');
            const useSplitCashBank = splitCash > 0 || splitBank > 0;
            const cashBdt = useSplitCashBank
                ? toBdt(splitCash, byId('cashCur').value)
                : toBdt(read('cashBankTotalAmt'), byId('cashBankTotalCur').value);
            const bankBdt = useSplitCashBank ? toBdt(splitBank, byId('bankCur').value) : 0;
            const goldBdt = toBdt(read('goldAmt'), byId('goldCur').value);
            const silverBdt = toBdt(read('silverAmt'), byId('silverCur').value);
            const investmentsBdt = toBdt(read('investmentsAmt'), byId('investmentsCur').value);
            const digitalAssetsBdt = toBdt(read('digitalAssetsAmt'), byId('digitalAssetsCur').value);
            const businessBdt = toBdt(read('businessAmt'), byId('businessCur').value);
            const receivablesBdt = toBdt(read('receivablesAmt'), byId('receivablesCur').value);
            const extraAssetsBdt = getExtraAssetsBdt(toBdt);
            const debtsBdt = toBdt(read('debtsAmt'), byId('debtsCur').value);

            const cashBankBdt = cashBdt + bankBdt + getCoreExtraTotalBdt('cashBank', toBdt);
            const stocksBdt = investmentsBdt + getCoreExtraTotalBdt('stocks', toBdt);
            const goldTotalBdt = goldBdt + getCoreExtraTotalBdt('gold', toBdt);
            const silverTotalBdt = silverBdt + getCoreExtraTotalBdt('silver', toBdt);
            const businessTotalBdt = businessBdt + getCoreExtraTotalBdt('business', toBdt);
            const receivablesTotalBdt = receivablesBdt + getCoreExtraTotalBdt('receivables', toBdt);

            const totalAssetsBdt = cashBankBdt + goldTotalBdt + silverTotalBdt + stocksBdt + digitalAssetsBdt + businessTotalBdt + receivablesTotalBdt + extraAssetsBdt;
            const totalLiabilitiesBdt = debtsBdt;
            const zakatableWealthBdt = totalAssetsBdt - totalLiabilitiesBdt;

            const GOLD_NISAB_GRAMS = 87.48;
            const SILVER_NISAB_GRAMS = 612.36;
            const nisabUsd = nisabType === 'gold' ? (GOLD_NISAB_GRAMS * goldPrice) : (SILVER_NISAB_GRAMS * silverPrice);
            const nisabThresholdBdt = nisabUsd * usdToBdt;
            const zakatAmountBdt = zakatableWealthBdt >= nisabThresholdBdt ? (zakatableWealthBdt * 0.025) : 0;
            latestZakatAmountBdt = zakatAmountBdt;

            const formatter = getCurrencyFormatter(currency);
            const totalAssets = bdtToDisplay(totalAssetsBdt);
            const totalLiabilities = bdtToDisplay(totalLiabilitiesBdt);
            const zakatableWealth = bdtToDisplay(zakatableWealthBdt);
            const nisabThreshold = bdtToDisplay(nisabThresholdBdt);
            const zakatAmountDisplay = bdtToDisplay(zakatAmountBdt);
            const zakatAmountUsd = usdToBdt > 0 ? (zakatAmountBdt / usdToBdt) : 0;

            animateNumber(byId('totalAssets'), totalAssets, (v) => { byId('totalAssets').textContent = symbol + formatter.format(v); });
            animateNumber(byId('totalLiabilities'), totalLiabilities, (v) => { byId('totalLiabilities').textContent = symbol + formatter.format(v); });
            byId('zakatableWealth').textContent = currency === 'BDT'
                ? ("BDT " + formatter.format(zakatableWealthBdt))
                : (symbol + formatter.format(zakatableWealth) + " (BDT " + formatter.format(zakatableWealthBdt) + ")");
            byId('nisabThreshold').textContent = currency === 'BDT'
                ? ("BDT " + formatter.format(nisabThresholdBdt))
                : (symbol + formatter.format(nisabThreshold) + " (BDT " + formatter.format(nisabThresholdBdt) + ")");
            byId('zakatAmountLabel').textContent = `Your Zakat Due (2.5%) in ${currency}`;
            animateNumber(byId('zakatAmount'), zakatAmountDisplay, (v) => { byId('zakatAmount').textContent = formatter.format(v); }, 850);
            animateNumber(byId('zakatAmountSecondary'), currency === 'BDT' ? zakatAmountUsd : zakatAmountBdt, (v) => {
                byId('zakatAmountSecondary').textContent = currency === 'BDT' ? ("USD " + formatter.format(v)) : ("BDT " + formatter.format(v));
            }, 850);
            animateNumber(byId('bdCashBank'), bdtToDisplay(cashBankBdt), (v) => { byId('bdCashBank').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdMetals'), bdtToDisplay(goldTotalBdt + silverTotalBdt), (v) => { byId('bdMetals').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdCrypto'), bdtToDisplay(digitalAssetsBdt), (v) => { byId('bdCrypto').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdStocks'), bdtToDisplay(stocksBdt), (v) => { byId('bdStocks').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdBusiness'), bdtToDisplay(businessTotalBdt), (v) => { byId('bdBusiness').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdReceivables'), bdtToDisplay(receivablesTotalBdt), (v) => { byId('bdReceivables').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdExtraAssets'), bdtToDisplay(extraAssetsBdt), (v) => { byId('bdExtraAssets').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdDebts'), bdtToDisplay(debtsBdt), (v) => { byId('bdDebts').textContent = symbol + formatter.format(v); });
            updateHawlReminderUI();

            const finalCard = document.querySelector('.final-result');
            if (finalCard && !prefersReducedMotion) {
                finalCard.classList.remove('pulse-in');
                void finalCard.offsetWidth;
                finalCard.classList.add('pulse-in');
            }

            const statusEl = byId('nisabStatus');
            const heroStatusEl = byId('resultsHeroStatus');
            if (zakatableWealthBdt < nisabThresholdBdt) {
                if (heroStatusEl) heroStatusEl.textContent = 'Below Nisab. Zakat is not due at this time.';
                statusEl.innerHTML = 'Below Nisab threshold';
                statusEl.style.background = 'rgba(139, 97, 24, 0.4)';
                statusEl.style.border = '1px solid rgba(255, 208, 106, 0.55)';
            } else {
                if (heroStatusEl) heroStatusEl.textContent = 'Above Nisab. Your zakat is due for this cycle.';
                statusEl.innerHTML = 'Above Nisab threshold';
                statusEl.style.background = 'rgba(116, 87, 27, 0.38)';
                statusEl.style.border = '1px solid rgba(244, 212, 123, 0.5)';
            }

            updateQuickStartProgress();
        }

        function calculateZakat() {
            recalcFast();
            scheduleSaveData();
        }

        function saveData() {
            const data = {
                currency: byId('currency').value,
                themeMode: byId('themeMode')?.value || 'midnight-gold',
                nisabType: byId('nisabType').value,
                usdToBdt: byId('usdToBdt').value,
                goldPrice: byId('goldPrice').value,
                silverPrice: byId('silverPrice').value,
                zakatHijriMonth: byId('zakatHijriMonth').value,
                zakatHijriDay: byId('zakatHijriDay').value,
                zakatHijriNote: byId('zakatHijriNote').value,
                lastZakatPaid: byId('lastZakatPaid').value,
                cashBankTotalAmt: byId('cashBankTotalAmt').value,
                cashBankTotalCur: byId('cashBankTotalCur').value,
                cashAmt: byId('cashAmt').value,
                cashCur: byId('cashCur').value,
                bankAmt: byId('bankAmt').value,
                bankCur: byId('bankCur').value,
                goldAmt: byId('goldAmt').value,
                goldCur: byId('goldCur').value,
                silverAmt: byId('silverAmt').value,
                silverCur: byId('silverCur').value,
                investmentsAmt: byId('investmentsAmt').value,
                investmentsCur: byId('investmentsCur').value,
                digitalAssetsAmt: byId('digitalAssetsAmt').value,
                digitalAssetsCur: byId('digitalAssetsCur').value,
                businessAmt: byId('businessAmt').value,
                businessCur: byId('businessCur').value,
                receivablesAmt: byId('receivablesAmt').value,
                receivablesCur: byId('receivablesCur').value,
                debtsAmt: byId('debtsAmt').value,
                debtsCur: byId('debtsCur').value,
                coreExtraEntries: serializeCoreExtraEntries(),
                extraAssets: serializeExtraAssets()
            };
            localStorage.setItem('zakatCalculatorData', JSON.stringify(data));
            localStorage.setItem(themeStorageKey, data.themeMode);
        }

        function loadData() {
            const saved = localStorage.getItem('zakatCalculatorData');
            const savedTheme = localStorage.getItem(themeStorageKey);
            if (savedTheme) applyTheme(savedTheme);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.themeMode) applyTheme(data.themeMode);

                // Backward compatibility: migrate old BDT/USD split fields if present.
                const migrate = (newAmt, newCur, oldBDT, oldUSD) => {
                    if (data[newAmt] !== undefined) return;
                    const bdt = parseFloat(data[oldBDT] || 0) || 0;
                    const usd = parseFloat(data[oldUSD] || 0) || 0;
                    if (bdt > 0) {
                        data[newAmt] = String(bdt);
                        data[newCur] = 'BDT';
                    } else if (usd > 0) {
                        data[newAmt] = String(usd);
                        data[newCur] = 'USD';
                    }
                };

                migrate('bankAmt', 'bankCur', 'bankBDT', 'bankUSD');
                migrate('goldAmt', 'goldCur', 'goldBDT', 'goldUSD');
                migrate('silverAmt', 'silverCur', 'silverBDT', 'silverUSD');
                migrate('investmentsAmt', 'investmentsCur', 'investmentsBDT', 'investmentsUSD');
                migrate('digitalAssetsAmt', 'digitalAssetsCur', 'cryptoBDT', 'cryptoUSD');
                migrate('businessAmt', 'businessCur', 'businessBDT', 'businessUSD');
                migrate('receivablesAmt', 'receivablesCur', 'receivablesBDT', 'receivablesUSD');
                migrate('debtsAmt', 'debtsCur', 'debtsBDT', 'debtsUSD');

                if (data.digitalAssetsAmt === undefined && data.cryptoAmt !== undefined) {
                    data.digitalAssetsAmt = data.cryptoAmt;
                    data.digitalAssetsCur = data.cryptoCur || 'BDT';
                }

                // Migrate previous dual cash inputs back into current single cash input.
                if (data.cashAmt === undefined) {
                    const legacyCashBdt = parseFloat(data.cashBDT || 0) || 0;
                    const legacyCashUsd = parseFloat(data.cashUSD || 0) || 0;
                    data.cashAmt = String(legacyCashBdt);
                    data.cashCur = 'BDT';
                    if (legacyCashUsd > 0) {
                        data.extraAssets = data.extraAssets || [];
                        data.extraAssets.push({
                            type: 'Cash',
                            amount: String(legacyCashUsd),
                            currency: 'USD'
                        });
                    }
                }

                if (data.cashBankTotalAmt === undefined) data.cashBankTotalAmt = '0';
                if (data.cashBankTotalCur === undefined) data.cashBankTotalCur = data.currency || 'BDT';
                if (data.lastZakatPaid === undefined) data.lastZakatPaid = new Date().toISOString().slice(0, 10);

                // Backward compatibility: older extra rows used "label" instead of "type".
                if (Array.isArray(data.extraAssets)) {
                    data.extraAssets = data.extraAssets.map((entry) => ({
                        type: entry.type || entry.label || 'Other',
                        amount: entry.amount || '0',
                        currency: entry.currency || 'BDT'
                    }));
                }

                if (!data.coreExtraEntries || typeof data.coreExtraEntries !== 'object') {
                    data.coreExtraEntries = {
                        cashBank: [],
                        stocks: [],
                        gold: [],
                        silver: [],
                        business: [],
                        receivables: []
                    };
                }

                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = data[key];
                });
                restoreCoreExtraEntries(data.coreExtraEntries);
                restoreExtraAssets(data.extraAssets);
                const splitPanel = document.getElementById('splitCashBankPanel');
                const splitBtn = document.getElementById('splitCashBankBtn');
                if (splitPanel && splitBtn) {
                    const cashSplit = parseFloat(data.cashAmt || '0') || 0;
                    const bankSplit = parseFloat(data.bankAmt || '0') || 0;
                    if (cashSplit > 0 || bankSplit > 0) {
                        splitPanel.removeAttribute('hidden');
                        splitBtn.textContent = 'Hide split details';
                    }
                }
                syncDefaultCurrenciesToMain();
                recalcFast();
            } else {
                restoreCoreExtraEntries({});
                restoreExtraAssets([]);
                syncDefaultCurrenciesToMain();
                const lastPaidEl = document.getElementById('lastZakatPaid');
                if (lastPaidEl && !lastPaidEl.value) {
                    lastPaidEl.value = new Date().toISOString().slice(0, 10);
                }
                recalcFast();
            }
        }

        function scrollToCalculator() {
            const calculator = document.getElementById('calculator');
            if (!calculator) return;
            calculator.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' });
            if (prefersReducedMotion) return;
            calculator.classList.remove('spotlight-active');
            void calculator.offsetWidth;
            calculator.classList.add('spotlight-active');
            setTimeout(() => calculator.classList.remove('spotlight-active'), 900);
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exportInvoicePdf() {
            // Ensure invoice values use the latest current calculation output.
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setText('invoiceGeneratedOn', `Generated on: ${new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date())}`);
            setText('invoiceTotalAssets', document.getElementById('totalAssets')?.textContent || '-');
            setText('invoiceTotalLiabilities', document.getElementById('totalLiabilities')?.textContent || '-');
            setText('invoiceZakatableWealth', document.getElementById('zakatableWealth')?.textContent || '-');
            setText('invoiceNisabThreshold', document.getElementById('nisabThreshold')?.textContent || '-');
            setText('invoiceZakatAmount', document.getElementById('zakatAmount')?.textContent || '-');

            const statusRaw = (document.getElementById('nisabStatus')?.textContent || '').replace(/[⚠️✅]/g, '').trim();
            setText('invoiceNisabStatus', statusRaw || '-');

            document.body.classList.add('invoice-print');
            window.print();
            setTimeout(() => {
                document.body.classList.remove('invoice-print');
            }, 250);
        }

        function hasEnteredFinancialData() {
            const fieldIds = [
                'cashBankTotalAmt', 'cashAmt', 'bankAmt', 'goldAmt', 'silverAmt',
                'investmentsAmt', 'digitalAssetsAmt', 'businessAmt', 'receivablesAmt', 'debtsAmt'
            ];
            const hasMainValues = fieldIds.some((id) => {
                const el = byId(id);
                const value = parseFloat(el?.value || '0');
                return Number.isFinite(value) && Math.abs(value) > 0;
            });
            if (hasMainValues) return true;

            const coreFields = ['cashBank', 'stocks', 'gold', 'silver', 'business', 'receivables'];
            const hasCoreExtraValues = coreFields.some((field) => {
                const list = byId(`${field}ExtraList`);
                if (!list) return false;
                return Array.from(list.querySelectorAll('.core-extra-amount')).some((input) => {
                    const value = parseFloat(input.value || '0');
                    return Number.isFinite(value) && Math.abs(value) > 0;
                });
            });
            if (hasCoreExtraValues) return true;

            return serializeExtraAssets().some((entry) => {
                const value = parseFloat(entry?.amount || '0');
                return Number.isFinite(value) && Math.abs(value) > 0;
            });
        }

        function updateQuickStartProgress() {
            const stepButtons = quickStepButtons.length ? quickStepButtons : Array.from(document.querySelectorAll('.quick-step'));
            if (!stepButtons.length) return;

            const sectionIds = quickStepSections.length ? quickStepSections : ['assetsCard', 'debtsCard', 'resultsCard'];
            let activeIndex = 0;
            const anchor = window.innerHeight * 0.35;

            sectionIds.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (!el) return;
                const rect = el.getBoundingClientRect();
                if (rect.top <= anchor) activeIndex = idx;
            });

            stepButtons.forEach((btn, idx) => {
                btn.classList.toggle('active', idx === activeIndex);
                btn.classList.toggle('done', idx < activeIndex);
            });

            const resultBtn = stepButtons.find((btn) => btn.getAttribute('data-target') === 'resultsCard');
            if (resultBtn) {
                const phaseEl = resultBtn.querySelector('.moon-phase');
                const calculated = hasEnteredFinancialData();
                resultBtn.classList.toggle('calculated', calculated);
                if (phaseEl) phaseEl.textContent = calculated ? '🌕' : '🌓';
            }
        }

        function setupTopNav() {
            topNavLinks = Array.from(document.querySelectorAll('.top-link[data-nav-target]'));
            topNavSections = topNavLinks
                .map((link) => byId(link.getAttribute('data-nav-target') || ''))
                .filter(Boolean);

            topNavLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    const target = byId(link.getAttribute('data-nav-target') || '');
                    if (!target) return;
                    target.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' });
                });
            });

            const topThemeEl = byId('topThemeMode');
            if (topThemeEl) {
                topThemeEl.addEventListener('change', () => {
                    applyTheme(topThemeEl.value);
                    scheduleSaveData(0);
                });
            }
        }

        function updateTopNavActive() {
            if (!topNavLinks.length) return;
            const anchor = window.innerHeight * 0.28;
            let activeId = 'landing';

            topNavSections.forEach((section) => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= anchor) activeId = section.id;
            });

            topNavLinks.forEach((link) => {
                link.classList.toggle('active', link.getAttribute('data-nav-target') === activeId);
            });
        }

        function setupSectionRail() {
            railLinks = Array.from(document.querySelectorAll('.rail-link[data-rail-target]'));
            railSections = railLinks
                .map((link) => byId(link.getAttribute('data-rail-target') || ''))
                .filter(Boolean);

            railLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    const target = byId(link.getAttribute('data-rail-target') || '');
                    if (!target) return;
                    target.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' });
                });
            });
        }

        function updateSectionRailActive() {
            if (!railLinks.length) return;
            const anchor = window.innerHeight * 0.3;
            let activeId = 'settingsCard';

            railSections.forEach((section) => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= anchor) activeId = section.id;
            });

            railLinks.forEach((link) => {
                link.classList.toggle('active', link.getAttribute('data-rail-target') === activeId);
            });
        }

        function onScrollTick() {
            const backToTop = byId('backToTop');
            if (backToTop) {
                if (window.scrollY > 500) {
                    backToTop.classList.add('show');
                } else {
                    backToTop.classList.remove('show');
                }
            }
            updateTopNavActive();
            updateSectionRailActive();
            updateQuickStartProgress();
            scrollRafId = null;
        }

        window.addEventListener('scroll', () => {
            if (scrollRafId) return;
            scrollRafId = requestAnimationFrame(onScrollTick);
        }, { passive: true });

        window.addEventListener('load', () => {
            quickStepButtons = Array.from(document.querySelectorAll('.quick-step'));
            quickStepSections = ['assetsCard', 'debtsCard', 'resultsCard'];

            const splitBtn = byId('splitCashBankBtn');
            const splitPanel = byId('splitCashBankPanel');
            if (splitBtn && splitPanel) {
                splitBtn.addEventListener('click', () => {
                    const isHidden = splitPanel.hasAttribute('hidden');
                    if (isHidden) {
                        splitPanel.removeAttribute('hidden');
                        splitBtn.textContent = 'Hide split details';
                    } else {
                        splitPanel.setAttribute('hidden', '');
                        splitBtn.textContent = 'Split details';
                    }
                });
            }

            const calculator = byId('calculator');
            if (calculator) {
                const onCalcInput = (event) => {
                    const target = event.target;
                    if (!(target instanceof HTMLElement)) return;
                    if (!target.id || !calcInputIds.has(target.id)) return;
                    if (target.id === 'currency') {
                        handleMainCurrencyChange();
                        return;
                    }
                    if (target.id === 'themeMode') {
                        applyTheme(target.value);
                        scheduleSaveData(0);
                        return;
                    }
                    calculateZakat();
                };
                calculator.addEventListener('input', onCalcInput);
                calculator.addEventListener('change', onCalcInput);
            }

            document.addEventListener('click', (event) => {
                const btn = event.target.closest('.currency-mini[data-currency-for]');
                if (btn) {
                    const hiddenId = btn.getAttribute('data-currency-for');
                    if (hiddenId) toggleCurrencyFor(hiddenId);
                    return;
                }

                const coreBtn = event.target.closest('.core-extra-currency-btn');
                if (coreBtn) {
                    const row = coreBtn.closest('.core-extra-row');
                    const hidden = row ? row.querySelector('.core-extra-currency') : null;
                    if (!hidden) return;
                    hidden.value = hidden.value === 'USD' ? 'BDT' : 'USD';
                    coreBtn.textContent = hidden.value;
                    calculateZakat();
                    return;
                }

                const extraBtn = event.target.closest('.extra-asset-currency-btn');
                if (!extraBtn) return;
                const row = extraBtn.closest('.extra-asset-row');
                const hidden = row ? row.querySelector('.extra-asset-currency') : null;
                if (!hidden) return;
                hidden.value = hidden.value === 'USD' ? 'BDT' : 'USD';
                extraBtn.textContent = hidden.value;
                calculateZakat();
            });

            const ctaBtn = byId('calculateCtaBtn');
            if (ctaBtn) ctaBtn.addEventListener('click', scrollToCalculator);
            const exportBtn = byId('exportInvoiceBtn');
            if (exportBtn) exportBtn.addEventListener('click', exportInvoicePdf);
            const backToTopBtn = byId('backToTop');
            if (backToTopBtn) backToTopBtn.addEventListener('click', scrollToTop);

            const addAssetBtn = byId('addAssetRowBtn');
            if (addAssetBtn) addAssetBtn.addEventListener('click', () => addExtraAssetRow({ type: 'Other', amount: 0, currency: byId('currency')?.value || 'BDT' }));
            document.querySelectorAll('.add-core-entry[data-core-field]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const field = btn.getAttribute('data-core-field');
                    if (!field) return;
                    addCoreExtraRow(field, { label: '', amount: 0, currency: byId('currency')?.value || 'BDT' });
                    calculateZakat();
                });
            });
            const saveHistoryBtn = byId('saveHistoryBtn');
            if (saveHistoryBtn) {
                saveHistoryBtn.addEventListener('click', () => {
                    const y = parseInt(byId('historyYear')?.value || '', 10) || new Date().getFullYear();
                    upsertZakatHistory(y, latestZakatAmountBdt);
                });
            }
            quickStepButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const target = targetId ? byId(targetId) : null;
                    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
            updateCurrentDates();
            scheduleDateRefreshAtMidnight();
            fillHijriDayOptions();
            setupScrollReveal();
            setupMoonParallax();
            setupTopNav();
            setupSectionRail();
            applyTheme(byId('themeMode')?.value || localStorage.getItem(themeStorageKey) || 'midnight-gold');
            loadData();
            const historyYearEl = byId('historyYear');
            if (historyYearEl && !historyYearEl.value) historyYearEl.value = String(new Date().getFullYear());
            renderZakatHistory();
            updateCurrencyMiniButtons();
            updateTopNavActive();
            updateSectionRailActive();
            updateQuickStartProgress();
        });
    </script>
</body>
</html>
