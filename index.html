<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zakat Calculator - Purify Your Wealth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Hide default number input spinners across browsers */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        :root {
            --dark-bg: #050a16;
            --darker-bg: #03070f;
            --card-bg: rgba(15, 23, 42, 0.6);
            --glass-bg: rgba(30, 41, 59, 0.4);
            --border-color: rgba(148, 163, 184, 0.1);
            --gold: #d4af37;
            --gold-light: #f4d47b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #10b981;
            --teal-accent: #14b8a6;
            --indigo-soft: rgba(74, 85, 170, 0.16);
            --purple-depth: rgba(99, 70, 145, 0.12);
            --page-glow-a: rgba(13, 29, 61, 0.28);
            --page-glow-b: rgba(5, 56, 68, 0.18);
            --page-base-start: #040913;
            --page-base-end: #040812;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background:
                radial-gradient(1200px 600px at 15% 5%, var(--page-glow-a) 0%, rgba(13, 29, 61, 0) 60%),
                radial-gradient(900px 460px at 85% 8%, var(--page-glow-b) 0%, rgba(5, 56, 68, 0) 62%),
                radial-gradient(1100px 520px at 50% 40%, var(--indigo-soft) 0%, rgba(74, 85, 170, 0) 70%),
                linear-gradient(180deg, var(--page-base-start) 0%, var(--dark-bg) 55%, var(--page-base-end) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            isolation: isolate;
        }

        body::before {
            content: "";
            position: fixed;
            inset: -8%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.02;
            background:
                linear-gradient(180deg, rgba(4, 10, 22, 0.42) 0%, rgba(4, 10, 22, 0.18) 45%, rgba(4, 10, 22, 0.5) 100%),
                radial-gradient(circle at 20% 12%, rgba(244, 212, 123, 0.14), transparent 44%),
                repeating-conic-gradient(
                    from 0deg at 50% 50%,
                    rgba(244, 212, 123, 0.34) 0deg 8deg,
                    rgba(244, 212, 123, 0) 8deg 16deg
                );
            background-size: 100% 100%, 140% 140%, 280px 280px;
            background-position: center center, center center, center center;
            mask-image: radial-gradient(circle at center, black 12%, rgba(0, 0, 0, 0.48) 56%, transparent 86%);
            filter: blur(1.6px);
        }

        body::after {
            content: "";
            position: fixed;
            left: 0;
            right: 0;
            bottom: -1px;
            height: min(25vh, 230px);
            z-index: 0;
            pointer-events: none;
            opacity: 0.085;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: bottom center;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 260' preserveAspectRatio='none'%3E%3Cpath fill='%23060d1a' d='M0 260V212c40-4 64-26 96-26 37 0 61 22 93 22 30 0 54-20 90-20s54 18 90 18c28 0 52-16 76-16 38 0 56 24 94 24 32 0 54-18 86-18 28 0 50 12 80 12 42 0 64-36 106-36 44 0 62 32 104 32 26 0 44-14 70-14 39 0 56 22 92 22 34 0 54-22 88-22 38 0 58 30 96 30 34 0 52-22 86-22 30 0 56 20 86 20 34 0 60-22 88-22 38 0 56 24 95 24 31 0 49-14 79-14 25 0 43 8 69 16V260Z'/%3E%3Cpath fill='%23091121' d='M172 211c10-52 35-82 70-82s60 30 70 82zm366 5c8-40 28-64 56-64s49 24 56 64zm178-2c12-68 46-108 92-108s80 40 92 108zm306 0c9-48 34-76 68-76 34 0 58 28 67 76zm250 0c7-32 21-52 38-52 17 0 31 20 38 52z'/%3E%3Ccircle cx='762' cy='105' r='10' fill='%23091121'/%3E%3Cpath fill='%23091121' d='M772 103c10-11 23-16 36-16 13 0 24 4 31 12-8-3-14-4-21-4-18 0-30 8-46 22z'/%3E%3C/svg%3E");
            filter: blur(1.4px);
            transform: translate3d(var(--skyline-px, 0px), var(--skyline-py, 0px), 0);
            will-change: transform;
        }

        .aurora-layer {
            position: fixed;
            inset: -10% -6% auto -6%;
            height: 72vh;
            z-index: 0;
            pointer-events: none;
            opacity: 0.18;
            background:
                radial-gradient(42% 40% at 28% 18%, rgba(39, 167, 197, 0.34), transparent 70%),
                radial-gradient(38% 36% at 58% 12%, rgba(78, 118, 221, 0.26), transparent 72%),
                radial-gradient(44% 40% at 84% 20%, rgba(101, 172, 144, 0.22), transparent 72%);
            filter: blur(38px) saturate(110%);
            animation: auroraDrift 28s ease-in-out infinite alternate;
            transform-origin: 50% 20%;
        }

        @keyframes auroraDrift {
            0% {
                transform: translate3d(-1.5%, -1%, 0) scale(1);
                opacity: 0.14;
            }
            50% {
                transform: translate3d(1.8%, 0.5%, 0) scale(1.04);
                opacity: 0.2;
            }
            100% {
                transform: translate3d(3.5%, -1.5%, 0) scale(1.08);
                opacity: 0.16;
            }
        }

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1200;
            padding: 0.65rem 1rem;
            background: linear-gradient(180deg, rgba(3, 10, 22, 0.88) 0%, rgba(3, 10, 22, 0.62) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        }

        .nav-progress {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 2px;
            background: rgba(148, 163, 184, 0.2);
            overflow: hidden;
        }

        .nav-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.7), rgba(244, 212, 123, 0.95), rgba(212, 175, 55, 0.72));
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.45);
            transition: width 0.2s linear;
        }

        .top-nav-inner {
            max-width: 1260px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .top-nav-logo {
            font-weight: 700;
            color: var(--gold-light);
            letter-spacing: 0.02em;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .top-nav-menu-btn {
            display: none;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(15, 23, 42, 0.65);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 0.42rem 0.72rem;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
        }

        .top-nav-links {
            display: flex;
            position: relative;
            gap: 0.55rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            padding: 0.18rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: rgba(15, 23, 42, 0.35);
        }

        .top-nav-links::-webkit-scrollbar {
            display: none;
        }

        .top-link-indicator {
            position: absolute;
            top: 0.16rem;
            left: 0.16rem;
            width: 0;
            height: calc(100% - 0.32rem);
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.24), rgba(244, 212, 123, 0.16));
            border: 1px solid rgba(212, 175, 55, 0.45);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.12), 0 6px 16px rgba(0, 0, 0, 0.24);
            transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), width 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
        }

        .top-link {
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(15, 23, 42, 0.14);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.5rem 0.95rem;
            font-size: 0.86rem;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.25s ease, border-color 0.25s ease, transform 0.25s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .top-link::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            left: -140%;
            width: 34%;
            transform: skewX(-18deg);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 247, 214, 0.34), rgba(255, 255, 255, 0));
            opacity: 0;
            pointer-events: none;
        }

        .top-link:hover::after {
            opacity: 1;
            animation: navGlint 1s ease;
        }

        .top-link:hover {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.55);
        }

        .top-link.active {
            color: var(--text-primary);
            border-color: transparent;
            background: transparent;
            box-shadow: none;
        }

        .top-nav-controls {
            display: flex;
            align-items: center;
            gap: 0.55rem;
            flex-shrink: 0;
        }

        .top-theme-wrap {
            display: inline-flex;
            align-items: center;
            gap: 0;
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-radius: 12px;
            padding: 0 0.45rem;
            background: rgba(15, 23, 42, 0.62);
        }

        .entries-nav-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-radius: 12px;
            padding: 0.5rem 0.78rem;
            background: rgba(15, 23, 42, 0.62);
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.82rem;
            font-weight: 700;
            white-space: nowrap;
            min-height: 40px;
        }

        .entries-nav-btn:hover {
            border-color: rgba(212, 175, 55, 0.55);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.18);
        }

        .entries-badge {
            border-radius: 999px;
            min-width: 1.4rem;
            padding: 0.08rem 0.38rem;
            text-align: center;
            font-size: 0.72rem;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.42);
            color: #f4d47b;
            line-height: 1.2;
        }

        .top-theme-icon {
            font-size: 0.9rem;
            line-height: 1;
            opacity: 0.95;
        }

        .top-theme-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .top-nav-theme {
            min-width: 130px;
            height: 40px;
            border-radius: 12px;
            border: 0;
            background: transparent;
            color: var(--text-primary);
            font-size: 0.82rem;
            font-weight: 600;
            padding: 0 0.55rem;
            color-scheme: dark;
        }

        .top-nav-theme:focus-visible {
            outline: none;
            border-color: rgba(212, 175, 55, 0.75);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.16);
        }

        .top-nav-theme option {
            background: #0b1630;
            color: #e8eefc;
        }

        .top-nav-theme option:checked {
            background: #1b2a4a;
            color: #ffffff;
        }

        @keyframes navGlint {
            0% { left: -140%; }
            100% { left: 155%; }
        }

        .nav-spacer {
            height: 64px;
        }

        #landing,
        #how-it-works,
        #calculator,
        #settingsCard,
        #assetsCard,
        #debtsCard,
        #resultsCard,
        #historyCard {
            scroll-margin-top: 84px;
        }


        body[data-theme="midnight-gold"] {
            --dark-bg: #050a16;
            --darker-bg: #03070f;
            --gold: #d4af37;
            --gold-light: #f4d47b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #10b981;
            --teal-accent: #14b8a6;
            --indigo-soft: rgba(74, 85, 170, 0.16);
            --purple-depth: rgba(99, 70, 145, 0.12);
            --page-glow-a: rgba(13, 29, 61, 0.28);
            --page-glow-b: rgba(5, 56, 68, 0.18);
            --page-base-start: #040913;
            --page-base-end: #040812;
        }

        body[data-theme="emerald-night"] {
            --dark-bg: #04120f;
            --darker-bg: #020b09;
            --gold: #1fa97a;
            --gold-light: #8fe3c9;
            --text-primary: #eaf7f3;
            --text-secondary: #a7b9c7;
            --accent: #1fa97a;
            --teal-accent: #59d6b0;
            --indigo-soft: rgba(39, 119, 100, 0.2);
            --purple-depth: rgba(23, 74, 62, 0.18);
            --page-glow-a: rgba(7, 46, 36, 0.34);
            --page-glow-b: rgba(17, 84, 68, 0.2);
            --page-base-start: #03120f;
            --page-base-end: #04100d;
        }

        body[data-theme="royal-indigo"] {
            --dark-bg: #070b1f;
            --darker-bg: #040713;
            --gold: #6c7cff;
            --gold-light: #b8c2ff;
            --text-primary: #edf0ff;
            --text-secondary: #9fb0c7;
            --accent: #8ea0ff;
            --teal-accent: #7f8fff;
            --indigo-soft: rgba(108, 124, 255, 0.2);
            --purple-depth: rgba(66, 77, 152, 0.18);
            --page-glow-a: rgba(31, 48, 115, 0.32);
            --page-glow-b: rgba(46, 69, 155, 0.2);
            --page-base-start: #060a1c;
            --page-base-end: #06091a;
        }

        body[data-theme="teal-dawn"] {
            --dark-bg: #06131a;
            --darker-bg: #030d12;
            --gold: #14b8a6;
            --gold-light: #7ee8dd;
            --text-primary: #ecf8f8;
            --text-secondary: #a8bac6;
            --accent: #14b8a6;
            --teal-accent: #38d3c4;
            --indigo-soft: rgba(20, 184, 166, 0.18);
            --purple-depth: rgba(12, 82, 94, 0.16);
            --page-glow-a: rgba(9, 58, 72, 0.33);
            --page-glow-b: rgba(22, 99, 108, 0.22);
            --page-base-start: #05131a;
            --page-base-end: #051019;
        }

        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.4), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 90% 60%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 33% 80%, rgba(255, 255, 255, 0.25), transparent),
                radial-gradient(1px 1px at 15% 90%, rgba(255, 255, 255, 0.2), transparent);
            background-size: 200% 200%;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
            transform: translate3d(var(--star-px, 0px), var(--star-py, 0px), 0);
            will-change: transform, opacity;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #landing {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow: hidden;
            z-index: 1;
        }

        .hero-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }

        .floating-particle {
            position: absolute;
            left: var(--x, 50%);
            top: var(--y, 50%);
            opacity: 0.34;
            animation: particleFloat var(--dur, 14s) ease-in-out infinite;
            animation-delay: var(--delay, 0s);
            transform-origin: center;
            filter: drop-shadow(0 0 6px rgba(212, 175, 55, 0.25));
        }

        .floating-particle.crescent {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(244, 212, 123, 0.8);
        }

        .floating-particle.crescent::after {
            content: "";
            position: absolute;
            inset: 1px;
            left: 5px;
            border-radius: 50%;
            background: var(--dark-bg);
        }

        .floating-particle.lantern {
            width: 10px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(244, 212, 123, 0.7);
            background: linear-gradient(180deg, rgba(244, 212, 123, 0.45), rgba(244, 212, 123, 0.1));
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.22);
        }

        .floating-particle.lantern::before {
            content: "";
            position: absolute;
            width: 8px;
            height: 2px;
            left: 50%;
            top: -4px;
            transform: translateX(-50%);
            border-radius: 999px;
            background: rgba(244, 212, 123, 0.65);
        }

        @keyframes particleFloat {
            0%, 100% { transform: translate3d(0, 0, 0) rotate(0deg); opacity: 0.22; }
            40% { transform: translate3d(8px, -14px, 0) rotate(4deg); opacity: 0.36; }
            70% { transform: translate3d(-6px, -20px, 0) rotate(-3deg); opacity: 0.3; }
        }

        .moon {
            position: absolute;
            top: 10%;
            right: 10%;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                rgba(255, 255, 255, 0.14) 0%,
                rgba(255, 255, 255, 0.10) 40%,
                rgba(255, 255, 255, 0.06) 70%,
                transparent 100%);
            filter: blur(1px);
            animation: moonDrift 60s ease-in-out infinite;
            z-index: -1;
            will-change: transform;
        }

        .moon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%,
                rgba(255, 255, 255, 0.08),
                transparent 60%);
            filter: blur(2px);
        }

        .moon-crater {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            filter: blur(1px);
        }

        .crater-1 { top: 20%; left: 30%; width: 40px; height: 40px; }
        .crater-2 { top: 50%; left: 50%; width: 30px; height: 30px; }
        .crater-3 { top: 60%; left: 20%; width: 25px; height: 25px; }

        @keyframes moonDrift {
            0%, 100% {
                transform: translate(var(--moon-px, 0px), var(--moon-py, 0px)) rotate(0deg);
            }
            25% {
                transform: translate(calc(var(--moon-px, 0px) - 20px), calc(var(--moon-py, 0px) - 30px)) rotate(5deg);
            }
            50% {
                transform: translate(calc(var(--moon-px, 0px) - 10px), calc(var(--moon-py, 0px) - 50px)) rotate(10deg);
            }
            75% {
                transform: translate(calc(var(--moon-px, 0px) + 20px), calc(var(--moon-py, 0px) - 30px)) rotate(5deg);
            }
        }

        .hero-content {
            max-width: 900px;
            text-align: center;
            z-index: 2;
            animation: fadeUp 1s ease-out;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-title {
            font-size: clamp(4rem, 12vw, 8rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
            text-shadow: 0 0 40px rgba(212, 175, 55, 0.3);
        }

        .hero-subtitle {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: var(--text-secondary);
            margin-bottom: 3rem;
            font-weight: 300;
        }

        .verse-container {
            background: linear-gradient(180deg, rgba(32, 44, 66, 0.46) 0%, rgba(20, 30, 48, 0.5) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-radius: 18px;
            padding: 2rem;
            margin-bottom: 3rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            overflow: hidden;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.06),
                inset 0 0 36px rgba(212, 175, 55, 0.08),
                0 12px 30px rgba(0, 0, 0, 0.25);
        }

        .verse-container::before {
            content: "";
            position: absolute;
            left: 10%;
            right: 10%;
            top: 0;
            height: 1px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0), rgba(244, 212, 123, 0.9), rgba(212, 175, 55, 0));
            opacity: 0.8;
        }

        .verse-container::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            left: -55%;
            width: 30%;
            transform: skewX(-18deg);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 241, 196, 0.22), rgba(255, 255, 255, 0));
            opacity: 0;
            animation: plaqueShimmer 9s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes plaqueShimmer {
            0%, 82% { left: -55%; opacity: 0; }
            85% { opacity: 0.12; }
            94% { left: 130%; opacity: 0.2; }
            100% { left: 130%; opacity: 0; }
        }

        .verse-text {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.8;
        }

        .verse-reference {
            color: var(--gold);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .cta-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2.2rem;
        }

        .hero-preview-card {
            max-width: 560px;
            margin: 0 auto 2.8rem;
            padding: 1rem 1.05rem 1.05rem;
            border-radius: 16px;
            background: linear-gradient(180deg, rgba(17, 29, 50, 0.72) 0%, rgba(12, 23, 39, 0.78) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04), 0 10px 26px rgba(0, 0, 0, 0.25);
            text-align: left;
        }

        .hero-preview-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(210, 221, 238, 0.85);
            margin-bottom: 0.8rem;
        }

        .preview-pill {
            border-radius: 999px;
            padding: 0.2rem 0.55rem;
            background: rgba(212, 175, 55, 0.18);
            border: 1px solid rgba(212, 175, 55, 0.45);
            color: #f4d47b;
            font-size: 0.72rem;
            letter-spacing: 0.02em;
            text-transform: none;
        }

        .hero-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.55rem 0.9rem;
            margin-bottom: 0.72rem;
        }

        .hero-preview-item {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .hero-preview-item span {
            font-size: 0.72rem;
            color: rgba(155, 173, 199, 0.92);
        }

        .hero-preview-item strong {
            font-size: 0.92rem;
            color: #e8eef9;
            font-weight: 700;
        }

        .hero-preview-due {
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            padding-top: 0.72rem;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.7rem;
        }

        .hero-preview-due-label {
            font-size: 0.78rem;
            color: rgba(169, 188, 214, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hero-preview-due-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: #f4d47b;
            text-shadow: 0 0 12px rgba(212, 175, 55, 0.2);
        }

        .btn {
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--darker-bg);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(212, 175, 55, 0.28);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(20, 184, 166, 0.55);
            box-shadow: 0 8px 20px rgba(20, 184, 166, 0.14);
            transform: translateY(-1px);
        }

        .why-zakat {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .why-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .why-card:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .why-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .why-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gold);
        }

        .why-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        #how-it-works {
            padding: 4.6rem 2rem;
            background: transparent;
            position: relative;
            z-index: 1;
        }

        .section-title {
            text-align: center;
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2.9rem;
            font-size: 1.1rem;
        }


        .steps-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2rem;
        }

        .step-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .step-card:hover::before {
            transform: scaleX(1);
        }

        .step-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            border-color: var(--gold);
        }

        .step-number {
            display: inline-block;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--darker-bg);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .step-text {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .section-separator {
            position: relative;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .section-separator::before {
            content: "";
            width: min(860px, 86vw);
            height: 1px;
            background: linear-gradient(
                90deg,
                rgba(212, 175, 55, 0),
                rgba(212, 175, 55, 0.56) 32%,
                rgba(118, 227, 200, 0.56) 68%,
                rgba(118, 227, 200, 0)
            );
            box-shadow:
                0 0 14px rgba(212, 175, 55, 0.2),
                0 0 20px rgba(118, 227, 200, 0.12);
            opacity: 0.78;
        }

        #calculator {
            padding: 3.8rem 2rem;
            max-width: 1380px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            isolation: isolate;
            border-radius: 0;
            background: transparent;
            border: 0;
            box-shadow: none;
        }

        #calculator::before {
            display: none;
        }

        #calculator.spotlight-active::before {
            opacity: 1;
            transform: scale(1);
        }

        #calculator::after {
            display: none;
        }

        #calculator > * {
            position: relative;
            z-index: 1;
        }

        .calculator-header {
            text-align: center;
            margin-bottom: 2.6rem;
        }

        .calc-shell {
            display: grid;
            grid-template-columns: 155px minmax(0, 1fr);
            gap: 0.9rem;
            align-items: start;
        }

        .section-rail {
            position: sticky;
            top: 84px;
            align-self: start;
            display: grid;
            gap: 0.55rem;
            padding: 0.7rem;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.28);
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.22);
        }

        .rail-link {
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(15, 23, 42, 0.5);
            color: var(--text-secondary);
            border-radius: 12px;
            padding: 0.5rem 0.65rem;
            text-align: left;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .rail-link:hover {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .rail-link.active {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.72);
            background: rgba(212, 175, 55, 0.14);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.18);
        }

        .content-canvas {
            border-radius: 0;
            padding: 0.35rem 0;
            background: transparent;
            border: 0;
            box-shadow: none;
        }

        /* Premium themed asset panel (applies across all theme modes via vars). */
        #assetsCard {
            background: rgba(15, 23, 42, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }

        #assetsCard .calc-card-title {
            font-size: 2.1rem;
            color: color-mix(in srgb, var(--gold-light) 88%, #fff 12%);
            margin-bottom: 1rem;
        }

        .assets-topbar {
            position: sticky;
            top: 10px;
            z-index: 5;
            margin: 0 0 1.15rem;
            padding: 0.7rem 0.85rem 0.8rem;
            border-radius: 14px;
            border: 1px solid rgba(212, 175, 55, 0.34);
            background: linear-gradient(180deg, rgba(16, 28, 48, 0.96) 0%, rgba(11, 20, 34, 0.94) 100%);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.2);
        }

        .assets-live-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.35rem;
            flex-wrap: wrap;
        }

        .assets-live-label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: color-mix(in srgb, var(--gold-light) 70%, var(--text-secondary) 30%);
        }

        .assets-live-total {
            font-size: 1.08rem;
            font-weight: 800;
            color: #f7df8a;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.24);
        }

        .assets-live-sub {
            font-size: 0.75rem;
            color: rgba(176, 193, 218, 0.86);
            text-align: right;
            width: 100%;
            margin: 0 0 0.45rem;
        }

        .asset-category-chips {
            display: flex;
            gap: 0.45rem;
            flex-wrap: wrap;
            margin-top: 0.1rem;
        }

        .asset-chip {
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(15, 23, 42, 0.64);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.3rem 0.68rem;
            font-size: 0.76rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: border-color 0.25s ease, color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
        }

        .asset-chip:hover {
            color: var(--text-primary);
            border-color: rgba(212, 175, 55, 0.6);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.16);
            transform: translateY(-1px);
        }

        #assetsCard .section-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            font-size: 1.08rem;
            background: linear-gradient(145deg, color-mix(in srgb, var(--gold) 84%, #fff 16%) 0%, color-mix(in srgb, var(--gold-light) 90%, #fff 10%) 100%);
            color: rgba(8, 12, 22, 0.9);
            border: 0;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.2);
        }

        #assetsCard .form-label {
            text-transform: uppercase;
            letter-spacing: 0.045em;
            font-size: 0.84rem;
            color: color-mix(in srgb, var(--gold-light) 78%, var(--text-primary) 22%);
            margin-bottom: 0.55rem;
        }

        #assetsCard .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.2rem;
            align-items: start;
        }

        .asset-field-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) clamp(130px, 26%, 190px);
            gap: 0.6rem;
            align-items: center;
        }

        .asset-note-input {
            min-height: 52px;
            border-radius: 12px;
            padding: 0 0.8rem;
            font-size: 0.82rem;
            color: var(--text-secondary);
            border-color: rgba(148, 163, 184, 0.2);
            background: rgba(10, 18, 32, 0.72);
        }

        .asset-note-input::placeholder {
            color: rgba(148, 163, 184, 0.72);
        }

        #assetsCard .money-input {
            width: 100%;
            max-width: 100%;
        }

        #assetsCard .money-input .form-input {
            width: 100%;
            min-height: 64px;
            border-radius: 14px;
            background: rgba(4, 8, 14, 0.92);
            border: 1px solid color-mix(in srgb, var(--gold) 44%, rgba(148, 163, 184, 0.2));
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
            font-size: 1.1rem;
            padding-right: 5.2rem;
        }

        #assetsCard .money-input .form-input:focus {
            border-color: color-mix(in srgb, var(--gold-light) 86%, #fff 14%);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--gold) 24%, transparent), 0 10px 20px color-mix(in srgb, var(--gold) 20%, transparent);
            transform: translateY(-1px);
        }

        #assetsCard .currency-mini {
            top: 50%;
            right: 9px;
            transform: translateY(-50%);
            min-width: 62px;
            height: 34px;
            border-radius: 999px;
            border: 0;
            background: linear-gradient(145deg, color-mix(in srgb, var(--gold) 90%, #fff 10%) 0%, color-mix(in srgb, var(--gold-light) 86%, #fff 14%) 100%);
            color: rgba(8, 12, 22, 0.95);
            font-weight: 700;
            letter-spacing: 0.06em;
            font-size: 0.86rem;
            box-shadow: 0 6px 14px color-mix(in srgb, var(--gold) 36%, transparent);
        }

        #assetsCard .currency-mini[data-currency-for]:hover {
            box-shadow: 0 10px 20px color-mix(in srgb, var(--gold) 42%, transparent);
            transform: translateY(calc(-50% - 1px));
        }

        #assetsCard .currency-mini[data-currency-for]:focus-visible {
            transform: translateY(-50%);
        }

        .extra-asset-row .money-input {
            position: static;
            display: flex;
            align-items: center;
            min-height: 58px;
        }

        .extra-asset-row .extra-asset-currency-btn {
            position: static;
            transform: none;
            width: 100%;
            min-width: 72px;
            justify-content: center;
        }

        #assetsCard .split-link {
            color: color-mix(in srgb, var(--gold-light) 86%, var(--text-secondary) 14%);
            text-decoration: none;
            border-bottom: 1px dashed color-mix(in srgb, var(--gold) 52%, transparent);
        }

        #assetsCard .split-panel {
            border-top: 1px dashed color-mix(in srgb, var(--gold) 36%, rgba(148, 163, 184, 0.2));
        }

        #assetsCard .optional-accordion {
            margin-top: 1.8rem;
            border-radius: 20px;
            background: rgba(8, 15, 27, 0.42);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--gold) 24%, rgba(148, 163, 184, 0.14));
        }

        .header-actions {
            margin-top: 0.9rem;
            display: flex;
            justify-content: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .assets-entry-tools {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
            margin-bottom: 0.6rem;
        }

        .assets-entry-tools .form-label {
            margin-bottom: 0;
        }

        .view-all-entries-link {
            color: var(--teal-accent);
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 2px;
            white-space: nowrap;
        }

        .view-all-entries-link:hover {
            color: color-mix(in srgb, var(--teal-accent) 78%, #fff 22%);
        }

        .app-toast {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            z-index: 1400;
            padding: 0.62rem 0.8rem;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.45);
            background: rgba(12, 24, 42, 0.95);
            color: #f5e6b8;
            font-size: 0.82rem;
            font-weight: 600;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(8px);
            pointer-events: none;
            transition: opacity 0.22s ease, transform 0.22s ease;
        }

        .app-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .calculator-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .calculator-subtitle {
            color: var(--text-secondary);
        }

        .today-dates {
            margin-top: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .ramadan-meta {
            margin-top: 0.55rem;
            min-height: 26px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.55rem;
        }

        .ramadan-badge {
            display: none;
            padding: 0.22rem 0.65rem;
            border-radius: 999px;
            font-size: 0.78rem;
            border: 1px solid rgba(212, 175, 55, 0.45);
            color: #f4d47b;
            background: rgba(212, 175, 55, 0.12);
            letter-spacing: 0.01em;
        }

        .ramadan-crescent {
            display: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            position: relative;
            background: rgba(244, 212, 123, 0.65);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.35);
            animation: crescentFloat 3.8s ease-in-out infinite;
        }

        .ramadan-crescent::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            top: 1px;
            left: 4px;
            background: var(--dark-bg);
        }

        @keyframes crescentFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.85; }
            50% { transform: translateY(-2px) rotate(5deg); opacity: 1; }
        }

        body.ramadan-mode .calc-card,
        body.ramadan-mode .results-card {
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.14), 0 18px 34px rgba(212, 175, 55, 0.08);
        }

        body.ramadan-mode .ramadan-badge,
        body.ramadan-mode .ramadan-crescent {
            display: inline-block;
        }

        .quick-start {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .quick-step {
            border: 1px solid var(--border-color);
            background: rgba(15, 23, 42, 0.75);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.45rem 0.85rem;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: border-color 0.35s cubic-bezier(0.22, 1, 0.36, 1), box-shadow 0.35s cubic-bezier(0.22, 1, 0.36, 1), color 0.35s cubic-bezier(0.22, 1, 0.36, 1), transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .moon-phase {
            font-size: 0.95rem;
            line-height: 1;
            filter: saturate(0.9);
        }

        .quick-step:hover {
            border-color: var(--gold);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .quick-step.active {
            border-color: var(--gold);
            color: var(--text-primary);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.12), 0 6px 18px rgba(20, 184, 166, 0.2);
        }

        .quick-step.done {
            color: #9ce8be;
            border-color: rgba(16, 185, 129, 0.45);
            background: rgba(16, 185, 129, 0.08);
        }

        .quick-step.calculated {
            border-color: rgba(244, 212, 123, 0.75);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.12), 0 0 16px rgba(212, 175, 55, 0.22);
        }

        .quick-step.calculated .moon-phase {
            filter: drop-shadow(0 0 6px rgba(255, 228, 145, 0.7));
        }

        .quick-sep {
            color: var(--text-secondary);
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .calc-card {
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.08);
            border-radius: 28px;
            padding: 1.7rem 1.85rem;
            margin-bottom: 1.9rem;
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        .calc-card::after {
            content: "";
            position: absolute;
            left: 2.2rem;
            right: 2.2rem;
            bottom: 0;
            height: 1px;
            background: linear-gradient(90deg, rgba(148, 163, 184, 0), rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0));
            pointer-events: none;
        }

        .settings-accordion {
            padding: 0;
            overflow: hidden;
        }

        .settings-accordion > summary {
            list-style: none;
            cursor: pointer;
            padding: 1.55rem 1.8rem;
            margin: 0;
            user-select: none;
            position: relative;
            width: 100%;
            justify-content: space-between;
        }

        .settings-accordion > summary::-webkit-details-marker {
            display: none;
        }

        .settings-accordion > summary::after {
            content: "+";
            position: absolute;
            right: 2.2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.35rem;
            color: var(--gold);
            line-height: 1;
        }

        .settings-accordion[open] > summary::after {
            content: "-";
        }

        .settings-summary-right {
            font-size: 0.82rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-right: 1.9rem;
        }

        .settings-content {
            padding: 0 1.8rem 1.7rem;
        }

        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.58s cubic-bezier(0.22, 1, 0.36, 1), transform 0.58s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reveal-on-scroll.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        .calc-card-title {
            font-size: 1.85rem;
            font-weight: 700;
            margin-bottom: 1.6rem;
            color: var(--gold);
            letter-spacing: 0.02em;
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
        }

        .section-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: rgba(212, 175, 55, 0.16);
            border: 1px solid rgba(212, 175, 55, 0.35);
            color: #f4d47b;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.55rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .amount-currency {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
        }

        .money-input {
            position: relative;
        }

        .money-input .form-input {
            padding-right: 5.8rem;
        }

        .currency-mini {
            position: absolute;
            right: 0.4rem;
            top: 50%;
            transform: translateY(-50%);
            border: 1px solid var(--border-color);
            background: rgba(30, 41, 59, 0.9);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.35rem 0.6rem;
            min-width: 56px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .currency-mini:hover {
            border-color: var(--teal-accent);
            box-shadow: 0 0 0 1px rgba(20, 184, 166, 0.24);
        }

        .split-link {
            margin-top: 0.6rem;
            align-self: flex-start;
            border: 0;
            background: transparent;
            color: var(--text-secondary);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
        }

        .split-panel {
            margin-top: 0.75rem;
            padding-top: 0;
            border-top: 1px dashed transparent;
            max-height: 0;
            opacity: 0;
            transform: translateY(-4px);
            overflow: hidden;
            transition: max-height 0.35s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.25s ease, transform 0.35s cubic-bezier(0.22, 1, 0.36, 1), padding-top 0.25s ease, border-color 0.25s ease;
        }

        .split-panel.open {
            max-height: 280px;
            opacity: 1;
            transform: translateY(0);
            padding-top: 0.85rem;
            border-top-color: var(--border-color);
        }

        .asset-group {
            scroll-margin-top: 220px;
        }

        #assetsCard > .form-label {
            margin-bottom: 0.85rem;
        }

        .split-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .optional-accordion {
            margin-top: 1.45rem;
            border: 0;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.3);
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
            overflow: hidden;
        }

        .optional-accordion > summary {
            list-style: none;
            cursor: pointer;
            padding: 0.95rem 1rem;
            color: var(--text-secondary);
            user-select: none;
        }

        .optional-accordion > summary::-webkit-details-marker {
            display: none;
        }

        .optional-accordion > summary::after {
            content: "+";
            float: right;
            color: var(--gold);
            font-weight: 700;
        }

        .optional-accordion[open] > summary::after {
            content: "-";
        }

        .optional-content {
            padding: 0 1rem 1rem;
        }

        .explain-toggle {
            margin-top: 0.5rem;
        }

        .explain-toggle > summary {
            list-style: none;
            cursor: pointer;
            font-size: 0.82rem;
            color: var(--text-secondary);
            text-decoration: underline;
        }

        .explain-toggle > summary::-webkit-details-marker {
            display: none;
        }

        .explain-content {
            margin-top: 0.45rem;
            padding: 0.65rem 0.75rem;
            border-radius: 10px;
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
            background: rgba(15, 23, 42, 0.45);
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.55;
        }

        .dual-currency {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .extra-assets {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .extra-assets-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .extra-assets-title {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .extra-assets-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .extra-asset-row {
            display: grid;
            grid-template-columns: 1.2fr 1fr 0.8fr auto;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .core-entry-list {
            margin-top: 0.55rem;
            display: grid;
            gap: 0.55rem;
        }

        .core-extra-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto auto;
            grid-template-areas: "amount currency remove";
            gap: 0.65rem;
            align-items: center;
        }

        .core-extra-row .core-extra-amount {
            grid-area: amount;
            min-width: 0;
        }

        .core-extra-row .form-input {
            min-height: 48px;
            border-radius: 12px;
            width: 100%;
        }

        .core-extra-row .money-input {
            grid-area: currency;
            position: static;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 74px;
        }

        .core-extra-row .core-extra-currency-btn {
            position: static;
            transform: none;
            width: auto;
            min-width: 72px;
            justify-content: center;
        }

        .core-extra-row .mini-btn {
            grid-area: remove;
            white-space: nowrap;
        }

        #assetsCard .core-extra-row .currency-mini {
            top: auto;
            right: auto;
            transform: none;
            min-width: 72px;
            height: 40px;
            border-radius: 12px;
        }

        #assetsCard .core-extra-row .currency-mini:hover,
        #assetsCard .core-extra-row .currency-mini:focus-visible {
            transform: none;
        }

        .mini-btn {
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 0.65rem 0.85rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .mini-btn:hover {
            border-color: var(--teal-accent);
            box-shadow: 0 6px 14px rgba(20, 184, 166, 0.12);
            transform: translateY(-1px);
        }

        .settings-live-prices {
            gap: 0.5rem;
            align-self: end;
        }

        .highlight-callout {
            position: relative;
            display: grid;
            gap: 0.55rem;
            padding: 0.75rem;
            border-radius: 14px;
            border: 1px solid rgba(34, 197, 94, 0.28);
            background:
                radial-gradient(130% 140% at 14% 0%, rgba(22, 163, 74, 0.16), rgba(22, 163, 74, 0) 64%),
                linear-gradient(180deg, rgba(8, 37, 25, 0.58) 0%, rgba(6, 28, 20, 0.5) 100%);
            box-shadow:
                inset 0 1px 0 rgba(167, 243, 208, 0.08),
                0 0 0 1px rgba(34, 197, 94, 0.1),
                0 7px 17px rgba(4, 36, 22, 0.24);
            backdrop-filter: blur(8px);
            overflow: hidden;
            animation: calloutBreathe 5.8s ease-in-out infinite;
        }

        .highlight-callout::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(105deg, rgba(255, 255, 255, 0) 18%, rgba(187, 247, 208, 0.12) 50%, rgba(255, 255, 255, 0) 82%);
            transform: translateX(-140%);
            animation: calloutShimmer 8.5s ease-in-out infinite;
        }

        .highlight-callout #fetchLivePricesBtn {
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(34, 197, 94, 0.58);
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.95) 0%, rgba(74, 222, 128, 0.95) 100%);
            color: #062312;
            font-weight: 800;
            box-shadow: 0 7px 16px rgba(22, 163, 74, 0.28);
            transition: transform 0.22s ease, box-shadow 0.28s ease, filter 0.28s ease;
        }

        .highlight-callout #fetchLivePricesBtn::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 180%;
            aspect-ratio: 1 / 1;
            transform: translate(-50%, -50%) scale(0.2);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(220, 252, 231, 0.34) 0%, rgba(220, 252, 231, 0) 60%);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.42s ease, opacity 0.42s ease;
        }

        .highlight-callout #fetchLivePricesBtn:hover {
            transform: translateY(-2px) scale(1.02);
            filter: saturate(1.05) brightness(1.02);
            box-shadow: 0 9px 18px rgba(22, 163, 74, 0.34), 0 0 0 1px rgba(74, 222, 128, 0.24);
        }

        .highlight-callout #fetchLivePricesBtn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 5px 11px rgba(22, 163, 74, 0.26);
        }

        .highlight-callout #fetchLivePricesBtn:active::after {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .highlight-callout .settings-live-status {
            color: #9ee8bf;
        }

        @keyframes calloutBreathe {
            0%, 100% {
                box-shadow:
                    inset 0 1px 0 rgba(167, 243, 208, 0.08),
                    0 0 0 1px rgba(34, 197, 94, 0.1),
                    0 7px 17px rgba(4, 36, 22, 0.24);
            }
            50% {
                box-shadow:
                    inset 0 1px 0 rgba(187, 247, 208, 0.12),
                    0 0 0 1px rgba(74, 222, 128, 0.16),
                    0 8px 20px rgba(7, 56, 32, 0.3),
                    0 0 14px rgba(34, 197, 94, 0.16);
            }
        }

        @keyframes calloutShimmer {
            0%, 70% { transform: translateX(-140%); opacity: 0; }
            78% { opacity: 1; }
            92% { transform: translateX(140%); opacity: 1; }
            100% { transform: translateX(140%); opacity: 0; }
        }

        .settings-live-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-height: 1.1rem;
        }

        .invoice-sheet {
            display: none;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .invoice-table th,
        .invoice-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.65rem 0;
            text-align: left;
        }

        .invoice-table td:last-child,
        .invoice-table th:last-child {
            text-align: right;
        }

        .form-label {
            font-size: 0.96rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.7rem;
        }

        .form-input {
            background: rgba(12, 20, 36, 0.78);
            border: 1px solid rgba(148, 163, 184, 0.14);
            border-radius: 18px;
            min-height: 58px;
            padding: 0 1.1rem;
            font-size: 1.04rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.14), 0 8px 18px rgba(212, 175, 55, 0.14);
            transform: translateY(-1px);
            animation: inputFocusPulse 380ms cubic-bezier(0.22, 1, 0.36, 1) 1;
        }

        .form-input::placeholder {
            color: rgba(148, 163, 184, 0.3);
        }

        .select-input {
            background: rgba(12, 20, 36, 0.78);
            border: 1px solid rgba(148, 163, 184, 0.14);
            border-radius: 18px;
            min-height: 58px;
            padding: 0 1.1rem;
            font-size: 1.04rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .currency-mini:focus-visible,
        .mini-btn:focus-visible,
        .split-link:focus-visible,
        .select-input:focus-visible {
            outline: none;
            border-color: var(--teal-accent);
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.2), 0 8px 18px rgba(20, 184, 166, 0.15);
            transform: translateY(-1px);
            animation: inputFocusPulse 380ms cubic-bezier(0.22, 1, 0.36, 1) 1;
        }

        .results-card {
            background: rgba(15, 23, 42, 0.45);
            border: 0;
            border-radius: 28px;
            padding: 2.1rem 1.95rem;
            margin-top: 0.8rem;
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            transform: translateY(-4px);
            position: relative;
            z-index: 3;
            text-align: center;
            overflow: hidden;
            isolation: isolate;
        }


        .results-card::before {
            display: none;
        }

        .results-card::after {
            content: "";
            position: absolute;
            left: 2.4rem;
            right: 2.4rem;
            bottom: 0;
            height: 1px;
            background: linear-gradient(90deg, rgba(148, 163, 184, 0), rgba(148, 163, 184, 0.24), rgba(148, 163, 184, 0));
            pointer-events: none;
        }

        .results-card > * {
            position: relative;
            z-index: 1;
        }

        .results-tabs {
            margin: 0.8rem auto 0.75rem;
            display: inline-flex;
            gap: 0.45rem;
            padding: 0.3rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(10, 19, 34, 0.55);
        }

        .results-tab {
            border: 0;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.42rem 0.78rem;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.22s ease;
        }

        .results-tab:hover {
            color: var(--text-primary);
        }

        .results-tab.active {
            color: var(--text-primary);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.34);
        }

        .results-tab-panel {
            animation: fadeUpTab 0.24s ease;
        }

        @keyframes fadeUpTab {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #settingsCard::before,
        #assetsCard::before,
        #debtsCard::before,
        #resultsCard::before,
        #historyCard::before {
            content: "";
            position: absolute;
            inset: -24% -12%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.88;
            filter: blur(4px) saturate(120%);
        }

        #settingsCard::before {
            background: radial-gradient(60% 52% at 18% 14%, rgba(74, 135, 219, 0.5), rgba(74, 135, 219, 0));
        }

        #assetsCard::before {
            background: radial-gradient(66% 56% at 50% 10%, rgba(212, 175, 55, 0.58), rgba(212, 175, 55, 0));
        }

        #debtsCard::before {
            background: radial-gradient(62% 52% at 78% 16%, rgba(239, 115, 51, 0.5), rgba(239, 115, 51, 0));
        }

        #resultsCard::before {
            display: block;
            background:
                radial-gradient(56% 52% at 28% 14%, rgba(212, 175, 55, 0.5), rgba(212, 175, 55, 0)),
                radial-gradient(56% 52% at 76% 18%, rgba(20, 184, 166, 0.42), rgba(20, 184, 166, 0));
        }

        #historyCard::before {
            background: radial-gradient(64% 56% at 24% 14%, rgba(104, 92, 201, 0.5), rgba(104, 92, 201, 0));
        }

        #settingsCard > *,
        #assetsCard > *,
        #debtsCard > *,
        #historyCard > * {
            position: relative;
            z-index: 1;
        }

        #settingsCard {
            border-color: rgba(74, 135, 219, 0.32);
        }

        #assetsCard {
            border-color: rgba(212, 175, 55, 0.34);
        }

        #debtsCard {
            border-color: rgba(239, 115, 51, 0.34);
            margin-bottom: 1.1rem;
        }

        #debtsCard .calc-card-title {
            color: #ffb27a;
            text-shadow: 0 0 12px rgba(239, 115, 51, 0.24);
        }

        #debtsCard .section-icon {
            background: rgba(239, 115, 51, 0.16);
            border-color: rgba(239, 115, 51, 0.45);
            color: #ffc39b;
        }

        #debtsCard .form-input {
            border-color: rgba(239, 115, 51, 0.28);
        }

        #debtsCard .form-input:focus {
            border-color: rgba(239, 115, 51, 0.72);
            box-shadow: 0 0 0 2px rgba(239, 115, 51, 0.18), 0 8px 18px rgba(239, 115, 51, 0.14);
        }

        #debtsCard .money-input {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            max-width: 560px;
        }

        #debtsCard .money-input .form-input {
            width: 100%;
            padding-right: 1.1rem;
        }

        #debtsCard .currency-mini {
            position: static;
            transform: none;
            min-width: 72px;
            height: 40px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .debt-helper-row {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            margin-top: 0.52rem;
            padding: 0.34rem 0.58rem;
            border-radius: 999px;
            border: 1px solid rgba(239, 115, 51, 0.35);
            background: rgba(239, 115, 51, 0.1);
            color: #ffc39b;
            font-size: 0.78rem;
            line-height: 1.2;
            position: relative;
        }

        .debt-helper-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 1px solid rgba(239, 115, 51, 0.5);
            font-size: 0.68rem;
            font-weight: 700;
            cursor: help;
        }

        .debt-helper-tip {
            position: absolute;
            left: 0;
            bottom: calc(100% + 0.5rem);
            width: min(340px, 78vw);
            padding: 0.56rem 0.66rem;
            border-radius: 10px;
            border: 1px solid rgba(239, 115, 51, 0.45);
            background: rgba(18, 13, 11, 0.94);
            color: #ffd5bb;
            font-size: 0.76rem;
            line-height: 1.45;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            opacity: 0;
            transform: translateY(4px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 12;
        }

        .debt-helper-icon:hover + .debt-helper-tip,
        .debt-helper-icon:focus + .debt-helper-tip,
        .debt-helper-icon:focus-visible + .debt-helper-tip {
            opacity: 1;
            transform: translateY(0);
        }

        #resultsCard {
            border-color: rgba(212, 175, 55, 0.34);
        }

        #historyCard {
            border-color: rgba(104, 92, 201, 0.34);
        }

        .result-row {
            display: none;
        }

        .results-hero {
            max-width: 760px;
            margin: 0 auto 1rem;
            padding: 1.1rem 1rem 1.2rem;
            border-radius: 18px;
            background: linear-gradient(180deg, rgba(22, 45, 78, 0.62) 0%, rgba(15, 31, 55, 0.58) 100%);
            border: 1px solid rgba(148, 177, 214, 0.28);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04), 0 14px 28px rgba(3, 10, 24, 0.34);
        }

        .results-hero-status {
            color: rgba(206, 224, 246, 0.92);
            font-size: 0.92rem;
            margin-bottom: 0.7rem;
            letter-spacing: 0.01em;
        }

        .results-compact-grid {
            max-width: 760px;
            margin: 0.85rem auto 0.9rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .compact-stat {
            border: 1px solid rgba(148, 177, 214, 0.24);
            border-radius: 12px;
            background: rgba(11, 24, 43, 0.56);
            padding: 0.72rem 0.85rem;
            text-align: left;
        }

        .compact-stat-label {
            display: block;
            font-size: 0.72rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: rgba(194, 214, 240, 0.82);
            margin-bottom: 0.18rem;
        }

        .compact-stat-value {
            font-size: 1.02rem;
            font-weight: 700;
            color: #e8f1ff;
            text-shadow: 0 0 10px rgba(74, 135, 219, 0.2);
        }

        .breakdown-card {
            background: rgba(9, 20, 38, 0.56);
            border: 1px solid rgba(148, 177, 214, 0.2);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            padding: 0.9rem 0.9rem 0.55rem;
            margin: 0.3rem auto 1rem;
            max-width: 760px;
        }

        .breakdown-title {
            font-size: 0.95rem;
            color: rgba(212, 226, 246, 0.95);
            margin-bottom: 0.75rem;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.84rem;
            padding: 0.34rem 0;
            color: rgba(211, 225, 243, 0.9);
            border-bottom: 1px solid rgba(148, 177, 214, 0.18);
        }

        .history-card {
            margin-top: 1.7rem;
            background: rgba(15, 23, 42, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.08);
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            border-top: 1px solid rgba(212, 175, 55, 0.35);
            border-radius: 18px;
            padding: 1.05rem;
        }

        .history-accordion {
            overflow: hidden;
            padding: 0;
        }

        .history-accordion > summary {
            list-style: none;
            cursor: pointer;
            padding: 1.55rem 1.8rem;
            margin: 0;
            user-select: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
            width: 100%;
        }

        .history-accordion > summary::-webkit-details-marker {
            display: none;
        }

        .history-accordion > summary::after {
            content: "+";
            color: var(--gold);
            font-size: 1.35rem;
            line-height: 1;
            position: absolute;
            right: 2.2rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .history-accordion[open] > summary::after {
            content: "-";
        }

        .history-summary-left {
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            font-size: 1.02rem;
            font-weight: 700;
            color: #f0f6ff;
        }

        .history-summary-right {
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-left: auto;
            text-align: right;
            margin-right: 1.9rem;
            font-weight: 600;
        }

        .history-content {
            padding: 0 1.8rem 1.7rem;
        }

        .history-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .history-chart {
            width: 100%;
            height: 122px;
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(10, 21, 39, 0.7), rgba(10, 20, 35, 0.52));
            margin-bottom: 0.8rem;
        }

        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 0.55rem;
            margin-bottom: 0.65rem;
        }

        .history-year-card {
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 12px;
            padding: 0.62rem 0.72rem;
            background: rgba(12, 24, 42, 0.6);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
        }

        .history-year-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .history-year-label {
            font-size: 0.82rem;
            color: rgba(187, 203, 225, 0.86);
        }

        .history-year-amount {
            font-size: 0.98rem;
            font-weight: 700;
            color: #e8f1ff;
        }

        .history-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.14rem 0.45rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(148, 163, 184, 0.12);
            color: #d2dfef;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .history-badge.up {
            background: rgba(16, 185, 129, 0.14);
            border-color: rgba(16, 185, 129, 0.42);
            color: #86efac;
        }

        .history-badge.down {
            background: rgba(239, 68, 68, 0.14);
            border-color: rgba(239, 68, 68, 0.42);
            color: #fca5a5;
        }

        .history-badge.flat {
            background: rgba(245, 158, 11, 0.14);
            border-color: rgba(245, 158, 11, 0.42);
            color: #fcd34d;
        }

        .history-empty {
            color: var(--text-secondary);
            font-size: 0.88rem;
        }

        .hawl-card {
            margin-top: 1rem;
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.45);
            padding: 1rem;
        }

        .hawl-title {
            color: var(--text-secondary);
            font-size: 0.92rem;
            margin-bottom: 0.75rem;
        }

        .hawl-summary {
            margin-top: 0.75rem;
            display: grid;
            gap: 0.4rem;
        }

        .hawl-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.88rem;
            color: var(--text-secondary);
        }

        .due-badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.2rem 0.55rem;
            font-size: 0.78rem;
            font-weight: 700;
            border: 1px solid transparent;
            color: var(--text-primary);
            background: rgba(148, 163, 184, 0.16);
        }

        .due-badge.soon {
            background: rgba(251, 191, 36, 0.14);
            border-color: rgba(251, 191, 36, 0.45);
            color: #fde68a;
        }

        .due-badge.overdue {
            background: rgba(239, 68, 68, 0.14);
            border-color: rgba(239, 68, 68, 0.45);
            color: #fca5a5;
        }

        .result-label {
            font-size: 0.92rem;
            color: rgba(194, 214, 240, 0.86);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .result-value {
            font-size: 1.42rem;
            font-weight: 700;
            color: #e8f1ff;
            text-shadow: 0 0 14px rgba(74, 135, 219, 0.28);
        }

        .final-result {
            background:
                radial-gradient(420px 200px at 50% 40%, rgba(212, 175, 55, 0.34) 0%, rgba(212, 175, 55, 0.14) 42%, rgba(212, 175, 55, 0) 78%),
                linear-gradient(180deg, rgba(117, 92, 34, 0.74) 0%, rgba(74, 57, 20, 0.7) 100%);
            padding: 2rem 1.2rem 1.3rem;
            border-radius: 20px;
            text-align: center;
            margin-top: 0.2rem;
            position: relative;
            overflow: hidden;
            transform: scale(1);
            opacity: 1;
            animation: finalLoadIn 560ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
            isolation: isolate;
            box-shadow:
                inset 0 0 0 1px rgba(212, 175, 55, 0.54),
                0 6px 14px rgba(2, 6, 18, 0.24);
        }

        .result-confetti-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 2;
        }

        .result-confetti {
            position: absolute;
            width: 6px;
            height: 10px;
            border-radius: 2px;
            opacity: 0;
            animation: confettiBurst 980ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes confettiBurst {
            0% {
                opacity: 0;
                transform: translate3d(0, 0, 0) rotate(0deg) scale(0.7);
            }
            10% { opacity: 0.9; }
            100% {
                opacity: 0;
                transform: translate3d(var(--tx, 0), var(--ty, -70px), 0) rotate(var(--rot, 120deg)) scale(1);
            }
        }

        .final-result::before {
            content: "";
            position: absolute;
            inset: -20%;
            z-index: -1;
            background:
                radial-gradient(circle at 50% 50%, rgba(224, 189, 79, 0.36) 0%, rgba(212, 175, 55, 0.24) 28%, rgba(212, 175, 55, 0.07) 60%, rgba(212, 175, 55, 0) 82%);
            opacity: 0.25;
            animation: none;
        }

        .final-result::after {
            content: "";
            position: absolute;
            width: 220px;
            height: 220px;
            left: 50%;
            top: 45%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(233, 205, 118, 0.5) 0%, rgba(212, 175, 55, 0.08) 45%, rgba(212, 175, 55, 0) 72%);
            z-index: -1;
            opacity: 0.18;
        }

        .amount-divider {
            width: min(440px, 86%);
            height: 1px;
            margin: 0.9rem auto;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0), rgba(255, 218, 120, 0.98), rgba(212, 175, 55, 0));
            box-shadow: none;
        }

        .result-shimmer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(255, 243, 196, 0.9) 50%, rgba(212, 175, 55, 0) 100%);
            background-size: 220% 100%;
            animation: none;
            opacity: 0.35;
        }

        .final-label {
            font-size: 1.05rem;
            color: #D4AF37;
            font-weight: 600;
            margin-bottom: 0.35rem;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.28);
        }

        .final-amount {
            font-size: clamp(2.2rem, 4.6vw, 3.35rem);
            font-weight: 800;
            color: #ffefb6;
            text-shadow: none;
            position: relative;
            display: inline-block;
            z-index: 1;
            white-space: nowrap;
            line-height: 1.05;
        }

        .final-amount-wrap {
            position: relative;
            display: inline-grid;
            place-items: center;
            padding: 0.45rem 1rem;
            margin: 0 auto;
        }

        .final-amount-ring {
            position: absolute;
            width: min(100%, 320px);
            min-width: 230px;
            height: 92px;
            border-radius: 999px;
            background: conic-gradient(from 0deg, rgba(212, 175, 55, 0), rgba(255, 239, 178, 0.88), rgba(20, 184, 166, 0.45), rgba(212, 175, 55, 0));
            opacity: 0.58;
            mask-image: radial-gradient(closest-side, transparent calc(100% - 5px), #000 calc(100% - 4px));
            animation: amountRingSpin 9s linear infinite;
            pointer-events: none;
        }

        @keyframes amountRingSpin {
            to { transform: rotate(360deg); }
        }

        .final-amount::before {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 260px;
            height: 120px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 239, 188, 0.4) 0%, rgba(212, 175, 55, 0.24) 40%, rgba(212, 175, 55, 0) 74%);
            z-index: -1;
            opacity: 0.12;
            animation: none;
        }

        .final-result.pulse-in {
            animation: finalValuePulse 420ms cubic-bezier(0.16, 1, 0.3, 1);
        }

        .final-subamount {
            margin-top: 0.45rem;
            font-size: 0.92rem;
            color: rgba(255, 240, 196, 0.88);
            font-weight: 600;
        }

        .nisab-panel {
            max-width: 760px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 120px minmax(0, 1fr);
            gap: 0.85rem;
            align-items: center;
        }

        .nisab-donut {
            width: 102px;
            height: 102px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: rgba(10, 20, 35, 0.66);
            border: 1px solid rgba(148, 163, 184, 0.25);
            margin: 0 auto;
            position: relative;
        }

        .nisab-donut-ring {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: conic-gradient(rgba(212, 175, 55, 0.95) 0deg 9deg, rgba(42, 58, 84, 0.6) 9deg 360deg);
            display: grid;
            place-items: center;
        }

        .nisab-donut-ring::after {
            content: "";
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: rgba(8, 15, 28, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.16);
        }

        .nisab-donut-label {
            position: absolute;
            font-size: 0.85rem;
            font-weight: 800;
            color: #f4d47b;
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.32);
        }

        .nisab-panel-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .nisab-panel {
            max-width: 760px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 120px minmax(0, 1fr);
            gap: 0.85rem;
            align-items: center;
        }

        .nisab-donut {
            width: 102px;
            height: 102px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: rgba(10, 20, 35, 0.66);
            border: 1px solid rgba(148, 163, 184, 0.25);
            margin: 0 auto;
        }

        .nisab-donut-ring {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: conic-gradient(rgba(212, 175, 55, 0.95) 0deg 9deg, rgba(42, 58, 84, 0.6) 9deg 360deg);
            display: grid;
            place-items: center;
        }

        .nisab-donut-ring::after {
            content: "";
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: rgba(8, 15, 28, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.16);
        }

        .nisab-donut-label {
            position: absolute;
            font-size: 0.85rem;
            font-weight: 800;
            color: #f4d47b;
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.32);
        }

        .nisab-panel-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .nisab-status {
            margin: 0.75rem auto 0;
            max-width: 620px;
            padding: 0.45rem 0.65rem;
            border-radius: 10px;
            background: rgba(116, 87, 27, 0.24);
            color: #f8e5ab;
            border: 1px solid rgba(244, 212, 123, 0.3);
            text-align: center;
            font-size: 0.8rem;
            line-height: 1.35;
        }

        #backToTop {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--darker-bg);
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        #backToTop:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.4);
        }

        #backToTop.show {
            display: flex;
        }

        .info-box {
            background: rgba(16, 185, 129, 0.1);
            border: 0;
            box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.25);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--accent);
        }

        .results-prelude-info {
            margin: 0 auto 0.95rem;
            max-width: 760px;
            text-align: left;
        }

        .pdf-report-root {
            position: fixed;
            left: -100000px;
            top: 0;
            width: 1024px;
            max-width: none;
            background: #ffffff;
            color: #0f172a;
            border: 0;
            z-index: -1;
            padding: 28px;
            font-family: "Segoe UI", Tahoma, sans-serif;
        }

        .pdf-report-root.is-active {
            left: 0;
            z-index: 2000;
        }

        .pdf-report-title {
            display: grid;
            gap: 8px;
            margin-bottom: 18px;
        }

        .pdf-report-title h1 {
            margin: 0;
            font-size: 36px;
            line-height: 1.1;
            color: #111827;
        }

        .pdf-report-meta {
            font-size: 14px;
            color: #475569;
        }

        .pdf-kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
            margin: 14px 0 20px;
        }

        .pdf-kpi-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px;
            background: #f8fafc;
        }

        .pdf-kpi-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #64748b;
            margin-bottom: 6px;
        }

        .pdf-kpi-value {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.2;
            word-break: break-word;
        }

        .pdf-report-section {
            margin-top: 18px;
        }

        .pdf-report-section h2 {
            margin: 0 0 8px;
            font-size: 22px;
            color: #111827;
        }

        .pdf-insights-list {
            margin: 0;
            padding-left: 20px;
            color: #334155;
            font-size: 14px;
            line-height: 1.55;
        }

        .pdf-table-wrap {
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .pdf-table th,
        .pdf-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
            word-break: break-word;
        }

        .pdf-table th {
            background: #f1f5f9;
            color: #334155;
            font-weight: 700;
            font-size: 11px;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .pdf-table td strong {
            color: #0f172a;
        }

        .pdf-chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 10px;
        }

        .pdf-chart-card {
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 10px;
            background: #ffffff;
        }

        .pdf-chart-title {
            margin: 0 0 8px;
            font-size: 14px;
            color: #334155;
            font-weight: 700;
        }

        .pdf-chart-canvas {
            width: 100%;
            height: 240px;
        }

        .pdf-chart-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .pdf-empty-note {
            color: #64748b;
            font-size: 13px;
            font-style: italic;
            padding: 8px 0;
        }

        @media (max-width: 900px) {
            .calc-shell {
                grid-template-columns: 1fr;
            }

            .section-rail {
                display: none;
            }

            .content-canvas {
                padding: 0;
                border: 0;
                box-shadow: none;
                background: transparent;
            }
        }

        @media (max-width: 900px) {
            body {
                overflow-x: hidden;
            }

            #landing {
                padding: 1.1rem 0.9rem 1.2rem;
            }

            .top-nav {
                padding: 0.45rem 0.6rem;
            }

            .top-nav-inner {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 0.45rem;
                flex-wrap: wrap;
            }

            .top-nav-logo {
                text-align: left;
                font-size: 0.9rem;
            }

            .top-nav-controls {
                width: 100%;
                justify-content: flex-start;
                flex-direction: column;
                gap: 0.45rem;
                display: flex;
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                pointer-events: none;
                transform: translateY(-8px);
                transition: max-height 0.28s ease, opacity 0.22s ease, transform 0.28s ease;
            }

            .top-nav.mobile-open .top-nav-controls {
                max-height: 340px;
                opacity: 1;
                pointer-events: auto;
                transform: translateY(0);
                padding-top: 0.45rem;
            }

            .top-nav-links {
                width: 100%;
                padding: 0;
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.4rem;
                border: 0;
                background: transparent;
                overflow: visible;
            }

            .top-link-indicator {
                display: none;
            }

            .top-link {
                width: 100%;
                text-align: center;
                padding: 0.46rem 0.7rem;
                font-size: 0.79rem;
            }

            .top-theme-wrap {
                width: 100%;
                margin: 0;
                justify-content: center;
            }

            .entries-nav-btn {
                width: 100%;
                justify-content: center;
            }

            .top-nav-theme {
                min-width: 146px;
                width: auto;
                height: 36px;
            }

            .nav-spacer {
                height: 74px;
            }

            .top-nav.mobile-open + .nav-spacer {
                height: 250px;
            }

            #landing,
            #how-it-works,
            #calculator,
            #settingsCard,
            #assetsCard,
            #debtsCard,
            #resultsCard,
            #historyCard {
                scroll-margin-top: 138px;
            }

            .moon {
                width: 250px;
                height: 250px;
                top: 18%;
                right: -80px;
                opacity: 0.32;
            }

            .hero-title {
                font-size: 3.4rem;
                margin-bottom: 0.6rem;
            }

            .hero-subtitle {
                margin-bottom: 2.1rem;
                font-size: 1.05rem;
            }

            .hero-content {
                width: 100%;
                max-width: 100%;
            }

            .verse-container {
                max-width: 100%;
                padding: 1.2rem 1.05rem;
                margin-bottom: 2.1rem;
                border-radius: 14px;
                overflow: visible;
            }

            .verse-container::after {
                display: none;
            }

            .verse-text {
                font-size: 0.98rem;
                line-height: 1.55;
                max-width: 92%;
                margin: 0 auto 0.4rem;
                padding-inline: 0.3rem;
                overflow-wrap: anywhere;
                word-break: break-word;
                text-align: center;
                text-indent: 0;
            }

            .verse-reference {
                font-size: 0.86rem;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
                gap: 0.85rem;
                margin-bottom: 1.5rem;
            }

            .hero-preview-card {
                margin-bottom: 2rem;
                padding: 0.9rem;
            }

            .hero-preview-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .hero-particles .floating-particle:nth-child(n+5) {
                display: none;
            }

            .btn {
                width: 100%;
                max-width: 340px;
            }

            #calculator {
                padding: 3rem 1rem;
            }

            .calculator-header {
                margin-bottom: 1.8rem;
            }

            .quick-start {
                gap: 0.35rem;
                justify-content: center;
            }

            .quick-step {
                font-size: 0.78rem;
                padding: 0.38rem 0.54rem;
            }

            .calc-card {
                border-radius: 20px;
                padding: 1.2rem 1rem;
                margin-bottom: 1.25rem;
            }

            .settings-accordion > summary,
            .history-accordion > summary {
                padding: 1rem 1rem;
            }

            .settings-accordion > summary::after,
            .history-accordion > summary::after {
                right: 1rem;
            }

            .settings-summary-right,
            .history-summary-right {
                display: none;
            }

            .settings-content,
            .history-content {
                padding: 0 1rem 1rem;
            }

            .calc-card-title {
                font-size: 1.42rem;
                margin-bottom: 1rem;
                gap: 0.55rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            #assetsCard .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .asset-field-row {
                grid-template-columns: 1fr;
                gap: 0.52rem;
            }

            .assets-topbar {
                top: 8px;
                margin-bottom: 0.95rem;
                padding: 0.75rem 0.7rem 0.8rem;
            }

            #assetsCard .money-input .form-input {
                min-height: 58px;
                font-size: 1.02rem;
            }
            
            .results-compact-grid {
                grid-template-columns: 1fr;
            }

            .results-tabs {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .nisab-panel {
                grid-template-columns: 1fr;
                gap: 0.7rem;
            }

            .nisab-panel-grid {
                grid-template-columns: 1fr;
            }
            
            .amount-currency {
                grid-template-columns: 1fr;
            }

            .dual-currency {
                grid-template-columns: 1fr;
            }

            .extra-asset-row {
                grid-template-columns: 1fr;
                gap: 0.55rem;
            }

            .core-extra-row {
                grid-template-columns: minmax(0, 1fr) auto;
                grid-template-areas:
                    "amount amount"
                    "currency remove";
                gap: 0.5rem;
            }

            .core-extra-row .money-input {
                justify-content: flex-start;
            }

            .core-extra-row .mini-btn {
                justify-self: end;
                padding: 0.55rem 0.75rem;
            }

            #assetsCard .currency-mini {
                min-width: 52px;
                height: 32px;
                font-size: 0.8rem;
                right: 7px;
            }

            .final-amount {
                font-size: 2.5rem;
            }

            #backToTop {
                right: 1rem;
                bottom: 1rem;
                width: 46px;
                height: 46px;
                font-size: 1.25rem;
            }
        }

        @media (max-width: 900px) {
            .top-nav-menu-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .nav-spacer {
                height: 82px;
            }

            .top-nav.mobile-open + .nav-spacer {
                height: 298px;
            }

            .top-nav-logo {
                font-size: 0.84rem;
            }

            .top-link {
                font-size: 0.76rem;
                padding: 0.42rem 0.62rem;
            }

            .top-nav-links {
                grid-template-columns: 1fr;
            }

            .top-theme-label {
                font-size: 0.74rem;
            }

            .top-nav-theme {
                min-width: 132px;
                font-size: 0.78rem;
            }

            #calculator {
                padding: 2.75rem 0.8rem;
            }

            #landing {
                padding: 0.85rem 0.8rem;
            }

            .hero-title {
                font-size: 3.25rem;
            }

            .hero-subtitle {
                font-size: 1rem;
            }

            .calc-card-title {
                font-size: 1.3rem;
            }

            .section-icon {
                width: 34px;
                height: 34px;
                border-radius: 10px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .reveal-on-scroll {
                opacity: 1 !important;
                transform: none !important;
            }

            .ramadan-crescent {
                animation: none !important;
            }

            .aurora-layer {
                animation: none !important;
                transform: none !important;
                opacity: 0.1 !important;
            }

            .highlight-callout,
            .highlight-callout::before {
                animation: none !important;
            }

            .highlight-callout #fetchLivePricesBtn:hover,
            .highlight-callout #fetchLivePricesBtn:active {
                transform: none !important;
                filter: none !important;
            }

            .top-link-indicator,
            .top-link::after,
            .nav-progress-fill {
                transition: none !important;
                animation: none !important;
            }

            .final-result,
            .final-result::before {
                animation: none !important;
            }

            .result-shimmer,
            .final-amount::before,
            .final-amount-ring,
            .result-confetti {
                animation: none !important;
            }


            .final-result {
                transform: none !important;
                opacity: 1 !important;
            }

            .form-input:focus,
            .currency-mini:focus-visible,
            .mini-btn:focus-visible,
            .split-link:focus-visible,
            .select-input:focus-visible {
                animation: none !important;
            }
        }

        @keyframes finalLoadIn {
            from { transform: scale(0.98); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes finalGlowPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes finalValuePulse {
            0% { transform: scale(0.985); opacity: 1; }
            70% { transform: scale(1.012); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shimmerSweep {
            0% { background-position: 200% 0; }
            100% { background-position: -120% 0; }
        }

        @keyframes amountAuraPulse {
            0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(0.97); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.04); }
        }

        @keyframes inputFocusPulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0), 0 0 0 rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.14), 0 8px 18px rgba(212, 175, 55, 0.14); }
        }

        html {
            scroll-behavior: smooth;
        }

        @media print {
            .starfield,
            .top-nav,
            .nav-spacer,
            .section-rail,
            #landing,
            #how-it-works,
            #backToTop,
            .mini-btn,
            .header-actions,
            .app-toast {
                display: none !important;
            }

            body {
                background: #fff !important;
                color: #000 !important;
            }

            #calculator {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            .calc-card,
            .results-card {
                border: 1px solid #ddd !important;
                background: #fff !important;
                box-shadow: none !important;
                break-inside: avoid;
            }

            .result-value,
            .final-amount,
            .calc-card-title,
            .calculator-title {
                color: #000 !important;
                -webkit-text-fill-color: #000 !important;
            }

            body.invoice-print #calculator {
                display: none !important;
            }

            body.invoice-print .invoice-sheet {
                display: block !important;
                max-width: 850px;
                margin: 0 auto;
                padding: 24px;
                color: #111827;
                font-family: "Segoe UI", Tahoma, sans-serif;
            }
        }
    </style>
</head>
<body>
    <div class="aurora-layer" aria-hidden="true"></div>
    <div class="starfield"></div>
    <header class="top-nav" aria-label="Main navigation">
        <div class="top-nav-inner">
            <div class="top-nav-logo">Zakat App</div>
            <button type="button" id="mobileMenuToggle" class="top-nav-menu-btn" aria-expanded="false" aria-controls="topNavControls">Menu</button>
            <div class="top-nav-controls" id="topNavControls">
                <nav class="top-nav-links">
                    <span class="top-link-indicator" aria-hidden="true"></span>
                    <button type="button" class="top-link active" data-nav-target="landing">Home</button>
                    <button type="button" class="top-link" data-nav-target="how-it-works">How It Works</button>
                    <button type="button" class="top-link" data-nav-target="calculator">Calculator</button>
                    <button type="button" class="top-link" data-nav-target="assetsCard">Assets</button>
                    <button type="button" class="top-link" data-nav-target="debtsCard">Debts</button>
                    <button type="button" class="top-link" data-nav-target="resultsCard">Results</button>
                    <button type="button" class="top-link" data-nav-target="historyCard">History</button>
                    <a href="faq.html" class="top-link" aria-label="Open FAQ page">FAQ</a>
                </nav>
                <a href="entries.html" class="entries-nav-btn" id="allEntriesBtn" aria-label="Open all entries">
                    <span>All Entries</span>
                    <span class="entries-badge" id="entriesCountBadge">0</span>
                </a>
                <div class="top-theme-wrap">
                    <select id="topThemeMode" class="top-nav-theme" aria-label="Theme mode">
                        <option value="midnight-gold">Midnight Gold</option>
                        <option value="emerald-night">Emerald Night</option>
                        <option value="royal-indigo">Royal Indigo</option>
                        <option value="teal-dawn">Teal Dawn</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="nav-progress" aria-hidden="true"><div class="nav-progress-fill" id="navProgressFill"></div></div>
    </header>
    <div class="nav-spacer" aria-hidden="true"></div>

    <section id="landing">
        <div class="moon">
            <div class="moon-crater crater-1"></div>
            <div class="moon-crater crater-2"></div>
            <div class="moon-crater crater-3"></div>
        </div>
        <div class="hero-particles" aria-hidden="true">
            <span class="floating-particle crescent" style="--x: 14%; --y: 26%; --dur: 15s; --delay: -2s;"></span>
            <span class="floating-particle lantern" style="--x: 24%; --y: 38%; --dur: 18s; --delay: -5s;"></span>
            <span class="floating-particle crescent" style="--x: 78%; --y: 24%; --dur: 16s; --delay: -1.5s;"></span>
            <span class="floating-particle lantern" style="--x: 86%; --y: 46%; --dur: 19s; --delay: -6.5s;"></span>
            <span class="floating-particle crescent" style="--x: 64%; --y: 62%; --dur: 17s; --delay: -3.2s;"></span>
            <span class="floating-particle lantern" style="--x: 36%; --y: 68%; --dur: 20s; --delay: -7.4s;"></span>
        </div>

        <div class="hero-content">
            <h1 class="hero-title">Zakat</h1>
            <p class="hero-subtitle">Purify your wealth. Strengthen your community.</p>

            <div class="verse-container">
                <p class="verse-text">"Take from their wealth a charity by which you purify them and cause them increase."</p>
                <p class="verse-reference"> Qur'an 9:103</p>
            </div>

            <div class="cta-buttons">
                <button id="calculateCtaBtn" class="btn btn-primary">Calculate Your Zakat</button>
                <a href="#how-it-works" class="btn btn-secondary">Learn How It Works</a>
            </div>

            <div class="hero-preview-card" aria-label="App preview">
                <div class="hero-preview-head">
                    <span>Mini Calculator Preview</span>
                    <span class="preview-pill">Offline</span>
                </div>
                <div class="hero-preview-grid">
                    <div class="hero-preview-item">
                        <span>Total Assets</span>
                        <strong>BDT 1,230,000</strong>
                    </div>
                    <div class="hero-preview-item">
                        <span>Debts</span>
                        <strong>BDT 180,000</strong>
                    </div>
                    <div class="hero-preview-item">
                        <span>Nisab (Silver)</span>
                        <strong>BDT 188,726</strong>
                    </div>
                    <div class="hero-preview-item">
                        <span>Status</span>
                        <strong>Above Nisab</strong>
                    </div>
                </div>
                <div class="hero-preview-due">
                    <span class="hero-preview-due-label">Estimated Zakat Due</span>
                    <span class="hero-preview-due-value">BDT 26,250</span>
                </div>
            </div>

            <div class="why-zakat">
                <div class="why-card">
                    <div class="why-icon">&#x2728;</div>
                    <h3 class="why-title">Purifies Wealth</h3>
                    <p class="why-text">Brings barakah (blessing) to your earnings and possessions</p>
                </div>
                <div class="why-card">
                    <div class="why-icon">&#x1F91D;</div>
                    <h3 class="why-title">Supports the Needy</h3>
                    <p class="why-text">Helps those in need and strengthens community bonds</p>
                </div>
                <div class="why-card">
                    <div class="why-icon">&#x2696;&#xFE0F;</div>
                    <h3 class="why-title">Social Balance</h3>
                    <p class="why-text">Creates equity and fulfills our responsibility to society</p>
                </div>
            </div>
        </div>
    </section>

    <section id="how-it-works">
        <h2 class="section-title">How Zakat is Calculated</h2>
        <p class="section-subtitle">A simple four-step process</p>

        <div class="steps-container">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3 class="step-title">Add Your Assets</h3>
                <p class="step-text">
                    Include cash, bank savings, gold, silver, stocks, crypto, business inventory, and any wealth you've held for one lunar year.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">2</div>
                <h3 class="step-title">Subtract Debts</h3>
                <p class="step-text">
                    Deduct short-term debts that are due within the year. Long-term debts like mortgages are typically not deducted.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">3</div>
                <h3 class="step-title">Check Nisab</h3>
                <p class="step-text">
                    Compare your net wealth with the nisab threshold (value of 87.48g gold or 612.36g silver). Zakat is due if you're above this.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">4</div>
                <h3 class="step-title">Pay 2.5%</h3>
                <p class="step-text">
                    If your wealth exceeds nisab for one full lunar year, pay 2.5% of your total zakatable wealth to eligible recipients.
                </p>
            </div>
        </div>
    </section>

    <div class="section-separator" aria-hidden="true"></div>

    <section id="calculator">
        <div class="calculator-header">
            <h2 class="calculator-title">Zakat Calculator</h2>
            <p class="calculator-subtitle">Enter your financial details below</p>
            <p class="today-dates">
                Today (Gregorian): <span id="todayGregorian">-</span> |
                Today (Hijri): <span id="todayHijri">-</span>
            </p>
            <div class="ramadan-meta">
                <span class="ramadan-crescent" aria-hidden="true"></span>
                <span class="ramadan-badge" id="ramadanBadge">Ramadan Mubarak</span>
            </div>
            <div class="header-actions">
                <button type="button" id="exportInvoiceBtn" class="mini-btn">Export Invoice PDF</button>
            </div>
            <div class="quick-start" id="quickStartBar" aria-label="Quick start">
                <button type="button" class="quick-step active" data-target="assetsCard"><span class="moon-phase" aria-hidden="true">&#x1F311;</span><span>Assets</span></button>
                <span class="quick-sep">&#x2192;</span>
                <button type="button" class="quick-step" data-target="debtsCard"><span class="moon-phase" aria-hidden="true">&#x1F313;</span><span>Debts</span></button>
                <span class="quick-sep">&#x2192;</span>
                <button type="button" class="quick-step" data-target="resultsCard"><span class="moon-phase" aria-hidden="true">&#x1F314;</span><span>Result</span></button>
            </div>
        </div>
        <div class="calc-shell">
            <aside class="section-rail" aria-label="Calculator sections">
                <button type="button" class="rail-link active" data-rail-target="settingsCard">Settings</button>
                <button type="button" class="rail-link" data-rail-target="assetsCard">Assets</button>
                <button type="button" class="rail-link" data-rail-target="debtsCard">Debts</button>
                <button type="button" class="rail-link" data-rail-target="resultsCard">Results</button>
                <button type="button" class="rail-link" data-rail-target="historyCard">History</button>
            </aside>
            <div class="content-canvas">

        <details class="calc-card settings-accordion" id="settingsCard">
            <summary class="calc-card-title">
                <span class="history-summary-left"><span class="section-icon">&#x2699;&#xFE0F;</span>Settings</span>
                <span class="settings-summary-right">Tap to expand</span>
            </summary>
            <div class="settings-content">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Display Currency</label>
                    <select id="currency" class="select-input form-input">
                        <option value="USD">USD ($)</option>
                        <option value="BDT">BDT</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Theme Mode</label>
                    <select id="themeMode" class="select-input form-input">
                        <option value="midnight-gold">Midnight Gold</option>
                        <option value="emerald-night">Emerald Night</option>
                        <option value="royal-indigo">Royal Indigo</option>
                        <option value="teal-dawn">Teal Dawn</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">USD to BDT Rate</label>
                    <input type="number" id="usdToBdt" class="form-input" value="122.30" step="0.01" placeholder="122.30">
                </div>

                <div class="form-group">
                    <label class="form-label">Nisab Calculation</label>
                    <select id="nisabType" class="select-input form-input">
                        <option value="silver">Silver (612.36g) - Recommended</option>
                        <option value="gold">Gold (87.48g)</option>
                    </select>
                    <details class="explain-toggle">
                        <summary>Why Silver is Recommended?</summary>
                        <div class="explain-content">
                            Silver nisab is lower than gold nisab, so more people who are able to contribute are included.
                            This tends to increase support reaching poor and eligible recipients.
                            Many scholars recommend silver-based nisab for this broader social benefit, while gold remains an accepted opinion.
                        </div>
                    </details>
                </div>

                <div class="form-group">
                    <label class="form-label" id="goldPriceLabel">Gold Price per Gram (USD)</label>
                    <input type="number" id="goldPrice" class="form-input" value="" step="0.01" placeholder="Enter gold price per gram">
                </div>

                <div class="form-group">
                    <label class="form-label" id="silverPriceLabel">Silver Price per Gram (USD)</label>
                    <input type="number" id="silverPrice" class="form-input" value="" step="0.01" placeholder="Enter silver price per gram">
                </div>

                <div class="form-group settings-live-prices">
                    <div class="highlight-callout">
                        <button type="button" id="fetchLivePricesBtn" class="mini-btn">Fetch Live 24K Gold &amp; 999 Silver</button>
                        <span id="livePriceStatus" class="settings-live-status"></span>
                    </div>
                </div>
            </div>
            <div class="hawl-card">
                <div class="hawl-title">Zakat Date + Hawl Reminder</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Your Zakat Date (Hijri)</label>
                        <div class="amount-currency">
                            <select id="zakatHijriMonth" class="select-input form-input">
                                <option value="">Month</option>
                                <option>Mu?arram</option>
                                <option>Safar</option>
                                <option>Rabi al-Awwal</option>
                                <option>Rabi al-Thani</option>
                                <option>Jumada al-Ula</option>
                                <option>Jumada al-Akhirah</option>
                                <option>Rajab</option>
                                <option>Shaban</option>
                                <option>Ramadan</option>
                                <option>Shawwal</option>
                                <option>Dhu al-Qadah</option>
                                <option>Dhu al-Hijjah</option>
                            </select>
                            <select id="zakatHijriDay" class="select-input form-input">
                                <option value="">Day</option>
                            </select>
                        </div>
                        <input type="text" id="zakatHijriNote" class="form-input" placeholder="Optional note (e.g., 1 Ramadan)" style="margin-top:0.6rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Zakat Paid (Gregorian)</label>
                        <input type="date" id="lastZakatPaid" class="form-input">
                    </div>
                </div>
                <div class="hawl-summary">
                    <div class="hawl-row"><span>Zakat Date</span><strong id="zakatDateSummary">-</strong></div>
                    <div class="hawl-row"><span>Last Paid</span><strong id="lastPaidSummary">-</strong></div>
                    <div class="hawl-row"><span>Next Due (estimate)</span><strong id="nextDueSummary">-</strong></div>
                    <div class="hawl-row"><span>Status</span><span class="due-badge" id="dueStatusBadge">On track</span></div>
                </div>
            </div>
            <div class="info-box">
                <p><strong>Market rates:</strong> Click Fetch Live 24K Gold &amp; 999 Silver or enter your own values.</p>
            </div>
            </div>
        </details>

        <div class="calc-card" id="assetsCard">
            <h3 class="calc-card-title"><span class="section-icon">&#x1F48E;</span>Your Assets</h3>
            <div class="assets-topbar" id="assetsTopbar">
                <div class="assets-live-row">
                    <span class="assets-live-label">Live Total Assets</span>
                    <span class="assets-live-total" id="assetsLiveTotal">BDT 0.00</span>
                </div>
                <div class="assets-live-sub" id="assetsLiveTotalSub">USD 0.00</div>
                <div class="asset-category-chips" aria-label="Asset categories">
                    <button type="button" class="asset-chip" data-asset-jump="assetsCashGroup">Cash</button>
                    <button type="button" class="asset-chip" data-asset-jump="assetsMetalsGroup">Metals</button>
                    <button type="button" class="asset-chip" data-asset-jump="assetsInvestmentsGroup">Investments</button>
                    <button type="button" class="asset-chip" data-asset-jump="assetsBusinessGroup">Business</button>
                </div>
            </div>
            <div class="assets-entry-tools">
                <p class="form-label">Core Assets</p>
                <a class="view-all-entries-link" href="entries.html">View all entries</a>
            </div>
            <div class="form-grid">
                <div class="form-group asset-group" id="assetsCashGroup">
                    <label class="form-label">Cash & Bank (Total)</label>
                    <div class="asset-field-row">
                        <div class="money-input">
                            <input type="number" id="cashBankTotalAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                            <input type="hidden" id="cashBankTotalCur" value="BDT">
                            <button type="button" class="currency-mini" data-currency-for="cashBankTotalCur">BDT</button>
                        </div>
                        <input type="text" id="cashBankTotalNote" class="form-input asset-note-input" placeholder="Note (optional)">
                    </div>
                    <button type="button" class="split-link" id="splitCashBankBtn">Split details</button>
                    <div class="split-panel" id="splitCashBankPanel">
                        <div class="split-grid">
                            <div class="form-group">
                                <label class="form-label">Cash at Home</label>
                                <div class="asset-field-row">
                                    <div class="money-input">
                                        <input type="number" id="cashAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                                        <input type="hidden" id="cashCur" value="BDT">
                                        <button type="button" class="currency-mini" data-currency-for="cashCur">BDT</button>
                                    </div>
                                    <input type="text" id="cashNote" class="form-input asset-note-input" placeholder="Note (optional)">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bank Balance</label>
                                <div class="asset-field-row">
                                    <div class="money-input">
                                        <input type="number" id="bankAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                                        <input type="hidden" id="bankCur" value="BDT">
                                        <button type="button" class="currency-mini" data-currency-for="bankCur">BDT</button>
                                    </div>
                                    <input type="text" id="bankNote" class="form-input asset-note-input" placeholder="Note (optional)">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="cashBank">+ Add entry</button>
                    <div class="core-entry-list" id="cashBankExtraList"></div>
                </div>

                <div class="form-group asset-group" id="assetsInvestmentsGroup">
                    <label class="form-label">Stocks & Investments</label>
                    <div class="asset-field-row">
                        <div class="money-input">
                            <input type="number" id="investmentsAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                            <input type="hidden" id="investmentsCur" value="BDT">
                            <button type="button" class="currency-mini" data-currency-for="investmentsCur">BDT</button>
                        </div>
                        <input type="text" id="investmentsNote" class="form-input asset-note-input" placeholder="Note (optional)">
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="stocks">+ Add entry</button>
                    <div class="core-entry-list" id="stocksExtraList"></div>
                </div>

                <div class="form-group asset-group" id="assetsMetalsGroup">
                    <label class="form-label">Gold (Cash Value)</label>
                    <div class="asset-field-row">
                        <div class="money-input">
                            <input type="number" id="goldAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                            <input type="hidden" id="goldCur" value="BDT">
                            <button type="button" class="currency-mini" data-currency-for="goldCur">BDT</button>
                        </div>
                        <input type="text" id="goldNote" class="form-input asset-note-input" placeholder="Note (optional)">
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="gold">+ Add entry</button>
                    <div class="core-entry-list" id="goldExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Silver (Cash Value)</label>
                    <div class="asset-field-row">
                        <div class="money-input">
                            <input type="number" id="silverAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                            <input type="hidden" id="silverCur" value="BDT">
                            <button type="button" class="currency-mini" data-currency-for="silverCur">BDT</button>
                        </div>
                        <input type="text" id="silverNote" class="form-input asset-note-input" placeholder="Note (optional)">
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="silver">+ Add entry</button>
                    <div class="core-entry-list" id="silverExtraList"></div>
                </div>

                <div class="form-group asset-group" id="assetsBusinessGroup">
                    <label class="form-label">Business Inventory</label>
                    <div class="asset-field-row">
                        <div class="money-input">
                            <input type="number" id="businessAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                            <input type="hidden" id="businessCur" value="BDT">
                            <button type="button" class="currency-mini" data-currency-for="businessCur">BDT</button>
                        </div>
                        <input type="text" id="businessNote" class="form-input asset-note-input" placeholder="Note (optional)">
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="business">+ Add entry</button>
                    <div class="core-entry-list" id="businessExtraList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Money Owed to You</label>
                    <div class="asset-field-row">
                        <div class="money-input">
                            <input type="number" id="receivablesAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                            <input type="hidden" id="receivablesCur" value="BDT">
                            <button type="button" class="currency-mini" data-currency-for="receivablesCur">BDT</button>
                        </div>
                        <input type="text" id="receivablesNote" class="form-input asset-note-input" placeholder="Note (optional)">
                    </div>
                    <button type="button" class="split-link add-core-entry" data-core-field="receivables">+ Add entry</button>
                    <div class="core-entry-list" id="receivablesExtraList"></div>
                </div>
            </div>

            <details class="optional-accordion">
                <summary>Additional fields</summary>
                <div class="optional-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Digital Assets</label>
                            <div class="asset-field-row">
                                <div class="money-input">
                                    <input type="number" id="digitalAssetsAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                                    <input type="hidden" id="digitalAssetsCur" value="BDT">
                                    <button type="button" class="currency-mini" data-currency-for="digitalAssetsCur">BDT</button>
                                </div>
                                <input type="text" id="digitalAssetsNote" class="form-input asset-note-input" placeholder="Note (optional)">
                            </div>
                        </div>
                    </div>
                    <div class="extra-assets">
                        <div class="extra-assets-header">
                            <div class="extra-assets-title">Additional Asset Entries</div>
                            <div class="extra-assets-actions">
                                <button type="button" id="addAssetRowBtn" class="mini-btn">+ Add Entry</button>
                                <a class="view-all-entries-link" href="entries.html">View all entries</a>
                            </div>
                        </div>
                        <div id="extraAssetsList"></div>
                    </div>
                </div>
            </details>
        </div>

        <div class="calc-card" id="debtsCard">
            <h3 class="calc-card-title"><span class="section-icon">&#x1F4C4;</span>Liabilities</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Short-term Debts (due within year)</label>
                    <div class="money-input">
                        <input type="number" id="debtsAmt" class="form-input" value="0" step="0.01" placeholder="Amount">
                        <input type="hidden" id="debtsCur" value="BDT">
                        <button type="button" class="currency-mini" data-currency-for="debtsCur">BDT</button>
                    </div>
                    <div class="debt-helper-row" role="note" aria-label="Debts helper">
                        <span>Only short-term debts count</span>
                        <span class="debt-helper-icon" tabindex="0" aria-label="More info">i</span>
                        <span class="debt-helper-tip">Include only debts due within the current lunar year. Long-term liabilities are usually not deducted from zakatable wealth.</span>
                    </div>
                </div>
            </div>
            <div class="info-box">
                <p><strong>Note:</strong> Only include debts due within the current year. Long-term debts like mortgages are typically not deducted from zakatable wealth.</p>
            </div>
        </div>

        <div class="results-card" id="resultsCard">
            <h3 class="calc-card-title"><span class="section-icon">&#x1F389;</span>Results</h3>
            <div class="info-box results-prelude-info">
                <p>
                    <strong>Important:</strong> This calculator provides an estimate. Zakat is due if you've held wealth above nisab for one complete lunar year (Hawl).
                    For specific cases or questions, please consult with a qualified Islamic scholar.
                </p>
            </div>
            <div class="results-hero">
                <p class="results-hero-status" id="resultsHeroStatus">Your current status will appear here.</p>
                <div class="final-result">
                    <div class="result-confetti-layer" id="resultConfettiLayer" aria-hidden="true"></div>
                    <span class="result-shimmer" aria-hidden="true"></span>
                    <div class="final-label" id="zakatAmountLabel">Your Zakat Due (2.5%)</div>
                    <div class="amount-divider" aria-hidden="true"></div>
                    <div class="final-amount-wrap">
                        <span class="final-amount-ring" aria-hidden="true"></span>
                        <div class="final-amount" id="zakatAmount">BDT 0.00</div>
                    </div>
                    <div class="amount-divider" aria-hidden="true"></div>
                    <div class="final-subamount" id="zakatAmountSecondary">USD 0.00</div>
                    <div class="nisab-status" id="nisabStatus"></div>
                </div>
            </div>
            <div class="results-tabs" role="tablist" aria-label="Result views">
                <button type="button" class="results-tab active" role="tab" aria-selected="true" data-result-tab="summaryTabPanel">Summary</button>
                <button type="button" class="results-tab" role="tab" aria-selected="false" data-result-tab="breakdownTabPanel">Breakdown</button>
                <button type="button" class="results-tab" role="tab" aria-selected="false" data-result-tab="nisabTabPanel">Nisab</button>
            </div>

            <div class="results-tab-panel active" id="summaryTabPanel" role="tabpanel">
                <div class="results-compact-grid">
                    <div class="compact-stat">
                        <span class="compact-stat-label">Total Assets</span>
                        <span class="compact-stat-value" id="totalAssets">$0.00</span>
                    </div>
                    <div class="compact-stat">
                        <span class="compact-stat-label">Total Liabilities</span>
                        <span class="compact-stat-value" id="totalLiabilities">$0.00</span>
                    </div>
                    <div class="compact-stat">
                        <span class="compact-stat-label">Zakatable Wealth</span>
                        <span class="compact-stat-value" id="zakatableWealth">$0.00</span>
                    </div>
                    <div class="compact-stat">
                        <span class="compact-stat-label">Nisab Threshold</span>
                        <span class="compact-stat-value" id="nisabThreshold">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="results-tab-panel" id="breakdownTabPanel" role="tabpanel" hidden>
                <div class="breakdown-card">
                    <div class="breakdown-title">Breakdown</div>
                    <div class="breakdown-row"><span>Cash + Bank</span><strong id="bdCashBank">-</strong></div>
                    <div class="breakdown-row"><span>Metals</span><strong id="bdMetals">-</strong></div>
                    <div class="breakdown-row"><span>Digital Assets</span><strong id="bdCrypto">-</strong></div>
                    <div class="breakdown-row"><span>Stocks</span><strong id="bdStocks">-</strong></div>
                    <div class="breakdown-row"><span>Business</span><strong id="bdBusiness">-</strong></div>
                    <div class="breakdown-row"><span>Receivables</span><strong id="bdReceivables">-</strong></div>
                    <div class="breakdown-row"><span>Extra assets</span><strong id="bdExtraAssets">-</strong></div>
                    <div class="breakdown-row"><span>Debts deducted</span><strong id="bdDebts">-</strong></div>
                </div>
            </div>

            <div class="results-tab-panel" id="nisabTabPanel" role="tabpanel" hidden>
                <div class="nisab-panel">
                    <div class="nisab-donut" aria-hidden="true">
                        <div class="nisab-donut-ring"></div>
                        <div class="nisab-donut-label">2.5%</div>
                    </div>
                    <div class="nisab-panel-grid">
                        <div class="compact-stat">
                            <span class="compact-stat-label">Nisab Threshold</span>
                            <span class="compact-stat-value" id="nisabTabThreshold">-</span>
                        </div>
                        <div class="compact-stat">
                            <span class="compact-stat-label">Your Wealth</span>
                            <span class="compact-stat-value" id="nisabTabWealth">-</span>
                        </div>
                        <div class="compact-stat">
                            <span class="compact-stat-label">Above/Below Nisab</span>
                            <span class="compact-stat-value" id="nisabTabGap">-</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <details class="calc-card history-card history-accordion" id="historyCard">
            <summary>
                <span class="history-summary-left"><span class="section-icon">&#x1F5D3;&#xFE0F;</span>Zakat History Tracker</span>
                <span class="history-summary-right">Tap to expand</span>
            </summary>
            <div class="history-content">
                <div class="history-actions">
                    <input type="number" id="historyYear" class="form-input" min="1900" max="2200" placeholder="Year (e.g., 2026)">
                    <button type="button" id="saveHistoryBtn" class="mini-btn">Save Year</button>
                </div>
                <svg id="historyChart" class="history-chart" viewBox="0 0 100 40" preserveAspectRatio="none" aria-label="Zakat history line chart"></svg>
                <div class="history-list" id="historyList">No history saved yet.</div>
                <div class="breakdown-row"><span>Total zakat given (lifetime)</span><strong id="historyLifetime">BDT 0.00</strong></div>
            </div>
        </details>
            </div>
        </div>
    </section>

    <section id="invoiceSheet" class="invoice-sheet" aria-hidden="true">
        <h1>Zakat Invoice</h1>
        <p id="invoiceGeneratedOn">Generated on: -</p>
        <table class="invoice-table">
            <tbody>
                <tr><th>Total Assets</th><td id="invoiceTotalAssets">-</td></tr>
                <tr><th>Total Liabilities</th><td id="invoiceTotalLiabilities">-</td></tr>
                <tr><th>Net Zakatable Wealth</th><td id="invoiceZakatableWealth">-</td></tr>
                <tr><th>Nisab Threshold</th><td id="invoiceNisabThreshold">-</td></tr>
                <tr><th>Zakat Status</th><td id="invoiceNisabStatus">-</td></tr>
                <tr><th>Zakat Due (BDT)</th><td id="invoiceZakatAmount">-</td></tr>
            </tbody>
        </table>
    </section>

    <div id="pdfReport" class="pdf-report-root" aria-hidden="true"></div>

    <button id="backToTop">?</button>
    <div id="appToast" class="app-toast" role="status" aria-live="polite"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        const currencySymbols = {
            'USD': '$',
            'BDT': 'BDT '
        };
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const runningAnimations = new WeakMap();
        const zakatHistoryStorageKey = 'zakatHistoryData';
        const themeStorageKey = 'zakatThemeMode';
        const entriesStorageKey = 'zakat_entries_v1';
        const draftEntries = {};
        let draftSummary = { totalEntries: 0, totalsByCurrency: {} };
        const elementCache = new Map();
        const formatterCache = new Map();
        let saveTimer = null;
        let midnightRefreshTimer = null;
        let scrollRafId = null;
        let quickStepButtons = [];
        let quickStepSections = [];
        let lastDisplayCurrency = null;
        let topNavLinks = [];
        let topNavSections = [];
        let topLinkIndicator = null;
        let railLinks = [];
        let railSections = [];
        let wasZakatEligible = false;
        const calcInputIds = new Set([
            'usdToBdt', 'goldPrice', 'silverPrice', 'zakatHijriMonth', 'zakatHijriDay', 'zakatHijriNote',
            'lastZakatPaid', 'cashBankTotalAmt', 'cashAmt', 'bankAmt', 'investmentsAmt',
            'goldAmt', 'silverAmt', 'businessAmt', 'receivablesAmt', 'digitalAssetsAmt', 'debtsAmt', 'currency', 'nisabType', 'themeMode'
        ]);
        let latestZakatAmountBdt = 0;

        function byId(id) {
            if (!elementCache.has(id)) {
                elementCache.set(id, document.getElementById(id));
            }
            return elementCache.get(id);
        }

        // Normalize parseFloat across the app so values like "1,234.56" are read as numbers.
        const nativeParseFloat = window.parseFloat.bind(window);
        window.parseFloat = (value) => nativeParseFloat(String(value ?? '').replace(/,/g, ''));

        const thousandInputBound = new WeakSet();

        function sanitizeNumericInputText(rawValue) {
            const safe = String(rawValue ?? '').replace(/,/g, '').trim();
            if (!safe) return '';

            const isNegative = safe.startsWith('-');
            const unsigned = isNegative ? safe.slice(1) : safe;
            const hasDot = unsigned.includes('.');
            const parts = unsigned.split('.');
            const intPartRaw = (parts.shift() || '').replace(/\D/g, '');
            const decPartRaw = parts.join('').replace(/\D/g, '');
            const intPart = intPartRaw || '0';
            const decimalPart = hasDot ? `.${decPartRaw}` : '';
            return `${isNegative ? '-' : ''}${intPart}${decimalPart}`;
        }

        function formatNumericWithThousands(rawValue) {
            const safe = String(rawValue ?? '');
            if (!safe) return '';

            const isNegative = safe.startsWith('-');
            const unsigned = isNegative ? safe.slice(1) : safe;
            const [intPartRaw = '0', decPartRaw] = unsigned.split('.');
            const intPart = intPartRaw.replace(/^0+(?=\d)/, '') || '0';
            const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const decimalPart = decPartRaw !== undefined ? `.${decPartRaw}` : '';
            return `${isNegative ? '-' : ''}${formattedInt}${decimalPart}`;
        }

        function bindThousandFormatter(input) {
            if (!(input instanceof HTMLInputElement)) return;
            if (input.dataset.noThousands === 'true') return;
            if (input.id === 'historyYear') return;
            if (thousandInputBound.has(input)) {
                const sanitizedExisting = sanitizeNumericInputText(input.value);
                input.value = sanitizedExisting ? formatNumericWithThousands(sanitizedExisting) : '';
                return;
            }

            input.dataset.thousandEnabled = 'true';
            input.type = 'text';
            input.inputMode = 'decimal';
            input.autocomplete = 'off';

            const applyFormat = () => {
                const sanitized = sanitizeNumericInputText(input.value);
                if (!sanitized) {
                    input.value = '';
                    return;
                }
                input.value = formatNumericWithThousands(sanitized);
            };

            input.addEventListener('input', applyFormat);
            input.addEventListener('blur', applyFormat);
            applyFormat();
            thousandInputBound.add(input);
        }

        function initThousandSeparatedInputs(root = document) {
            root.querySelectorAll('input[type="number"], input[data-thousand-enabled="true"]').forEach((input) => bindThousandFormatter(input));
        }

        function getCurrencyFormatter(currency) {
            if (!formatterCache.has(currency)) {
                formatterCache.set(currency, new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }));
            }
            return formatterCache.get(currency);
        }

        function scheduleSaveData(delayMs = 300) {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveData();
                saveTimer = null;
            }, delayMs);
        }

        function sanitizeAmount(rawValue) {
            const normalized = String(rawValue ?? '').replace(/[,\s]/g, '').trim();
            if (!normalized) return 0;
            const parsed = Number.parseFloat(normalized);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function getAmountInputFieldKey(inputEl) {
            if (!(inputEl instanceof HTMLInputElement)) return '';
            if (inputEl.dataset.draftKey) return inputEl.dataset.draftKey;
            if (inputEl.id) return inputEl.id;
            const row = inputEl.closest('.core-extra-row, .extra-asset-row');
            if (!row) return '';
            if (!row.dataset.draftRowId) row.dataset.draftRowId = makeEntryId();
            return `${row.dataset.field || 'row'}_${row.dataset.draftRowId}`;
        }

        function getCurrencyForAmountInput(inputEl) {
            if (!(inputEl instanceof HTMLInputElement)) return byId('currency')?.value || 'BDT';
            const row = inputEl.closest('.core-extra-row, .extra-asset-row');
            if (row) {
                const rowCurrency = row.querySelector('.core-extra-currency, .extra-asset-currency');
                return rowCurrency?.value || byId('currency')?.value || 'BDT';
            }
            const group = inputEl.closest('.form-group');
            const currencyHidden = group?.querySelector('.money-input input[type="hidden"]');
            return currencyHidden?.value || byId('currency')?.value || 'BDT';
        }

        function isAmountInput(inputEl) {
            if (!(inputEl instanceof HTMLInputElement)) return false;
            if (inputEl.classList.contains('core-extra-amount') || inputEl.classList.contains('extra-asset-amount')) return true;
            if (inputEl.id && /Amt$/i.test(inputEl.id)) return true;
            return false;
        }

        function setDraftForInput(inputEl) {
            const key = getAmountInputFieldKey(inputEl);
            if (!key) return;
            draftEntries[key] = sanitizeAmount(inputEl.value);
        }

        function recomputeDraftSummary() {
            const persisted = loadEntries();
            const totalsByCurrency = {};
            persisted.forEach((entry) => {
                const currency = String(entry.currency || 'BDT');
                const amount = sanitizeAmount(entry.amount);
                totalsByCurrency[currency] = (totalsByCurrency[currency] || 0) + amount;
            });

            Object.keys(draftEntries).forEach((key) => {
                const amount = sanitizeAmount(draftEntries[key]);
                if (!amount) return;
                const input = document.querySelector(`[data-draft-key="${key}"]`) || byId(key);
                const currency = getCurrencyForAmountInput(input) || 'BDT';
                totalsByCurrency[currency] = (totalsByCurrency[currency] || 0) + amount;
            });

            draftSummary = {
                totalEntries: persisted.length + Object.keys(draftEntries).length,
                totalsByCurrency
            };
        }

        function recalculateTotals() {
            recalcFast();
            recomputeDraftSummary();
            scheduleSaveData();
        }

        function resolveDraftAmountForCoreField(field, preferredInput = null) {
            if (preferredInput instanceof HTMLInputElement && isAmountInput(preferredInput)) {
                return sanitizeAmount(preferredInput.value);
            }
            const fieldToInput = {
                cashBank: 'cashBankTotalAmt',
                stocks: 'investmentsAmt',
                gold: 'goldAmt',
                silver: 'silverAmt',
                business: 'businessAmt',
                receivables: 'receivablesAmt'
            };
            const inputId = fieldToInput[field];
            const inputEl = inputId ? byId(inputId) : null;
            return sanitizeAmount(inputEl?.value || 0);
        }

        function getAddButtonForAmountInput(inputEl) {
            const group = inputEl.closest('.form-group');
            let button = group?.querySelector('.add-core-entry');
            if (button) return button;

             const inputId = inputEl.id || '';
            if (inputId === 'cashAmt' || inputId === 'bankAmt' || inputId === 'cashBankTotalAmt') {
                button = document.querySelector('#assetsCashGroup .add-core-entry[data-core-field="cashBank"]');
                if (button) return button;
            }

            const coreRow = inputEl.closest('.core-extra-row');
            if (coreRow?.dataset.field) {
                button = document.querySelector(`.add-core-entry[data-core-field="${coreRow.dataset.field}"]`);
                if (button) return button;
            }

            const optional = inputEl.closest('.optional-content');
            if (optional) {
                button = optional.querySelector('#addAssetRowBtn');
                if (button) return button;
            }
            return null;
        }

        function makeEntryId() {
            return `${Date.now()}_${Math.random().toString(16).slice(2, 10)}`;
        }

        function loadEntries() {
            try {
                const raw = localStorage.getItem(entriesStorageKey);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (_error) {
                return [];
            }
        }

        function saveEntries(entries) {
            localStorage.setItem(entriesStorageKey, JSON.stringify(entries));
            updateEntriesBadge();
        }

        function addEntry({ category, amount, currency, note = '', meta = {} }) {
            const entries = loadEntries();
            const numericAmount = parseFloat(amount) || 0;
            const entry = {
                id: makeEntryId(),
                createdAt: new Date().toISOString(),
                category: String(category || 'Other'),
                amount: Number.isFinite(numericAmount) ? numericAmount : 0,
                currency: String(currency || 'BDT'),
                note: String(note || ''),
                meta: meta && typeof meta === 'object' ? meta : {}
            };
            entries.push(entry);
            saveEntries(entries);
            return entry;
        }

        function updateEntry(entryId, patch = {}) {
            const entries = loadEntries();
            const index = entries.findIndex((item) => item.id === entryId);
            if (index < 0) return;
            const next = { ...entries[index], ...patch };
            if (patch.amount !== undefined) {
                const numericAmount = parseFloat(patch.amount) || 0;
                next.amount = Number.isFinite(numericAmount) ? numericAmount : 0;
            }
            entries[index] = next;
            saveEntries(entries);
        }

        function removeEntry(entryId) {
            const entries = loadEntries();
            const filtered = entries.filter((item) => item.id !== entryId);
            if (filtered.length === entries.length) return;
            saveEntries(filtered);
        }

        function updateEntriesBadge() {
            const badge = byId('entriesCountBadge');
            if (!badge) return;
            badge.textContent = String(loadEntries().length);
        }

        function showToast(message) {
            const toast = byId('appToast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 1300);
        }

        function coreFieldToCategory(field) {
            const map = {
                cashBank: 'Cash',
                stocks: 'Investments',
                gold: 'Gold Cash',
                silver: 'Silver',
                business: 'Business Inventory',
                receivables: 'Money Owed To You'
            };
            return map[field] || 'Other';
        }

        function applyTheme(themeMode) {
            const allowed = new Set(['midnight-gold', 'emerald-night', 'royal-indigo', 'teal-dawn']);
            const mode = allowed.has(themeMode) ? themeMode : 'midnight-gold';
            document.body.setAttribute('data-theme', mode);
            const themeEl = byId('themeMode');
            if (themeEl && themeEl.value !== mode) themeEl.value = mode;
            const topThemeEl = byId('topThemeMode');
            if (topThemeEl && topThemeEl.value !== mode) topThemeEl.value = mode;
            updateTopThemeLabel(mode);
        }

        function themeLabelFromMode(mode) {
            const labels = {
                'midnight-gold': 'Midnight Gold',
                'emerald-night': 'Emerald Night',
                'royal-indigo': 'Royal Indigo',
                'teal-dawn': 'Teal Dawn'
            };
            return labels[mode] || 'Midnight Gold';
        }

        function updateTopThemeLabel(mode) {
            const labelEl = byId('topThemeLabel');
            if (!labelEl) return;
            const currentMode = mode || byId('topThemeMode')?.value || byId('themeMode')?.value || 'midnight-gold';
            labelEl.textContent = themeLabelFromMode(currentMode);
        }

        function updateTopNavIndicator() {
            if (!topLinkIndicator || !topNavLinks.length) return;
            const activeLink = topNavLinks.find((link) => link.classList.contains('active')) || topNavLinks[0];
            if (!activeLink) return;
            const parentRect = activeLink.parentElement?.getBoundingClientRect();
            const linkRect = activeLink.getBoundingClientRect();
            if (!parentRect) return;
            const x = linkRect.left - parentRect.left;
            topLinkIndicator.style.width = `${linkRect.width}px`;
            topLinkIndicator.style.transform = `translateX(${x}px)`;
            topLinkIndicator.style.opacity = "1";
        }

        function updateNavProgress() {
            const fill = byId('navProgressFill');
            if (!fill) return;
            const maxScroll = Math.max(1, document.documentElement.scrollHeight - window.innerHeight);
            const pct = Math.min(100, Math.max(0, (window.scrollY / maxScroll) * 100));
            fill.style.width = `${pct.toFixed(2)}%`;
        }

        function getZakatHistory() {
            try {
                const raw = localStorage.getItem(zakatHistoryStorageKey);
                const parsed = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parsed)) return [];
                return parsed
                    .map((x) => ({ year: parseInt(x.year, 10), amountBdt: parseFloat(x.amountBdt) || 0 }))
                    .filter((x) => Number.isFinite(x.year));
            } catch (_) {
                return [];
            }
        }

        function setZakatHistory(rows) {
            localStorage.setItem(zakatHistoryStorageKey, JSON.stringify(rows));
        }

        function upsertZakatHistory(year, amountBdt) {
            const y = parseInt(year, 10);
            if (!Number.isFinite(y)) return;
            const rows = getZakatHistory();
            const idx = rows.findIndex((r) => r.year === y);
            const safeAmount = Number.isFinite(amountBdt) ? amountBdt : 0;
            if (idx >= 0) rows[idx].amountBdt = safeAmount;
            else rows.push({ year: y, amountBdt: safeAmount });
            rows.sort((a, b) => a.year - b.year);
            setZakatHistory(rows);
            renderZakatHistory();
        }

        function renderZakatHistory() {
            const rows = getZakatHistory().sort((a, b) => a.year - b.year);
            const listEl = document.getElementById('historyList');
            const lifeEl = document.getElementById('historyLifetime');
            const chartEl = document.getElementById('historyChart');
            if (!listEl || !lifeEl || !chartEl) return;

            const formatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            listEl.innerHTML = rows.length
                ? rows.map((r, idx) => {
                    const prev = idx > 0 ? rows[idx - 1].amountBdt : null;
                    let badge = '<span class="history-badge flat">Base</span>';
                    if (prev !== null) {
                        if (r.amountBdt > prev) badge = '<span class="history-badge up">Up</span>';
                        else if (r.amountBdt < prev) badge = '<span class="history-badge down">Down</span>';
                        else badge = '<span class="history-badge flat">Flat</span>';
                    }
                    return `
                        <article class="history-year-card">
                            <div class="history-year-head">
                                <span class="history-year-label">${r.year}</span>
                                ${badge}
                            </div>
                            <div class="history-year-amount">BDT ${formatter.format(r.amountBdt)}</div>
                        </article>
                    `;
                }).join('')
                : '<div class="history-empty">No history saved yet.</div>';

            const lifetime = rows.reduce((sum, r) => sum + (r.amountBdt || 0), 0);
            lifeEl.textContent = `BDT ${formatter.format(lifetime)}`;

            if (!rows.length) {
                chartEl.innerHTML = '<text x="50" y="22" text-anchor="middle" font-size="4" fill="#94a3b8">No data yet</text>';
                return;
            }

            const w = 100;
            const h = 40;
            const px = 4;
            const py = 3;
            const min = Math.min(...rows.map((r) => r.amountBdt));
            const max = Math.max(...rows.map((r) => r.amountBdt));
            const spread = Math.max(1, max - min);
            const innerW = w - (2 * px);
            const innerH = h - (2 * py);
            const barGap = 1.2;
            const barW = Math.max(3.4, (innerW - (barGap * (rows.length - 1))) / rows.length);

            const bars = rows.map((r, i) => {
                const norm = spread === 0 ? 0.65 : ((r.amountBdt - min) / spread);
                const bh = Math.max(6, norm * (innerH - 2) + 6);
                const x = px + i * (barW + barGap);
                const y = h - py - bh;
                const isPeak = r.amountBdt === max;
                const fill = isPeak ? 'url(#historyBarPeak)' : 'url(#historyBarGrad)';
                return `
                    <rect x="${x.toFixed(2)}" y="${y.toFixed(2)}" width="${barW.toFixed(2)}" height="${bh.toFixed(2)}" rx="1.2" fill="${fill}" opacity="${isPeak ? '1' : '0.9'}"></rect>
                `;
            }).join('');

            chartEl.innerHTML = `
                <defs>
                    <linearGradient id="historyBarGrad" x1="0" y1="1" x2="0" y2="0">
                        <stop offset="0%" stop-color="rgba(66, 92, 144, 0.85)"></stop>
                        <stop offset="100%" stop-color="rgba(132, 178, 255, 0.92)"></stop>
                    </linearGradient>
                    <linearGradient id="historyBarPeak" x1="0" y1="1" x2="0" y2="0">
                        <stop offset="0%" stop-color="rgba(212, 175, 55, 0.9)"></stop>
                        <stop offset="100%" stop-color="rgba(255, 225, 132, 0.98)"></stop>
                    </linearGradient>
                </defs>
                <line x1="${px}" y1="${h - py}" x2="${w - px}" y2="${h - py}" stroke="rgba(148,163,184,0.42)" stroke-width="0.42"></line>
                ${bars}
            `;
        }

        function animateNumber(el, targetValue, renderFn, duration = 560) {
            if (!el) return;
            const safeTarget = Number.isFinite(targetValue) ? targetValue : 0;
            const currentValue = parseFloat(el.dataset.animValue || `${safeTarget}`);
            if (runningAnimations.has(el)) {
                cancelAnimationFrame(runningAnimations.get(el));
                runningAnimations.delete(el);
            }
            if (prefersReducedMotion) {
                renderFn(safeTarget);
                el.dataset.animValue = String(safeTarget);
                return;
            }

            const start = Number.isFinite(currentValue) ? currentValue : safeTarget;
            const startTime = performance.now();
            const easeOut = (t) => 1 - Math.pow(1 - t, 4);

            const tick = (now) => {
                const progress = Math.min(1, (now - startTime) / duration);
                const eased = easeOut(progress);
                const value = start + (safeTarget - start) * eased;
                renderFn(value);
                if (progress < 1) {
                    runningAnimations.set(el, requestAnimationFrame(tick));
                } else {
                    el.dataset.animValue = String(safeTarget);
                    runningAnimations.delete(el);
                }
            };

            runningAnimations.set(el, requestAnimationFrame(tick));
        }

        function setupScrollReveal() {
            const cards = document.querySelectorAll('#calculator .calc-card, #calculator .results-card, #calculator .info-box');
            cards.forEach((el, index) => {
                el.classList.add('reveal-on-scroll');
                el.style.transitionDelay = `${index * 100}ms`;
            });
            if (prefersReducedMotion || !('IntersectionObserver' in window)) {
                cards.forEach((el) => el.classList.add('revealed'));
                return;
            }

            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.12 });

            cards.forEach((el) => observer.observe(el));
        }

        function setupMoonParallax() {
            const moon = document.querySelector('.moon');
            if (prefersReducedMotion) return;

            let rafId = null;
            let targetX = 0;
            let targetY = 0;
            let currentX = 0;
            let currentY = 0;

            const tick = () => {
                currentX += (targetX - currentX) * 0.1;
                currentY += (targetY - currentY) * 0.1;

                // Layer depth: skyline (slow) -> starfield (medium) -> moon (faster).
                document.documentElement.style.setProperty('--skyline-px', `${(currentX * 1.4).toFixed(2)}px`);
                document.documentElement.style.setProperty('--skyline-py', `${(currentY * 0.9).toFixed(2)}px`);
                document.documentElement.style.setProperty('--star-px', `${(currentX * 2.3).toFixed(2)}px`);
                document.documentElement.style.setProperty('--star-py', `${(currentY * 1.6).toFixed(2)}px`);
                if (moon) {
                    moon.style.setProperty('--moon-px', `${(currentX * 3.6).toFixed(2)}px`);
                    moon.style.setProperty('--moon-py', `${(currentY * 3.6).toFixed(2)}px`);
                }

                if (Math.abs(targetX - currentX) > 0.05 || Math.abs(targetY - currentY) > 0.05) {
                    rafId = requestAnimationFrame(tick);
                } else {
                    rafId = null;
                }
            };

            const startTick = () => {
                if (!rafId) rafId = requestAnimationFrame(tick);
            };

            window.addEventListener('mousemove', (event) => {
                const nx = (event.clientX / window.innerWidth) - 0.5;
                const ny = (event.clientY / window.innerHeight) - 0.5;
                targetX = nx * 3.2;
                targetY = ny * 3.2;
                startTick();
            });

            document.addEventListener('mouseleave', () => {
                targetX = 0;
                targetY = 0;
                startTick();
            });
        }

        function addExtraAssetRow(entry = {}, options = {}) {
            const list = document.getElementById('extraAssetsList');
            if (!list) return;
            const defaultCurrency = document.getElementById('currency')?.value || 'BDT';
            const trackEntry = options.trackEntry === true;

            const row = document.createElement('div');
            row.className = 'extra-asset-row';
            row.dataset.draftRowId = makeEntryId();
            row.innerHTML = `
                <select class="select-input form-input extra-asset-type">
                    <option value="Cash">Cash</option>
                    <option value="Bank">Bank</option>
                    <option value="Gold">Gold</option>
                    <option value="Silver">Silver</option>
                    <option value="Stocks">Stocks</option>
                    <option value="Digital Assets">Digital Assets</option>
                    <option value="Business">Business</option>
                    <option value="Receivable">Receivable</option>
                    <option value="Other">Other</option>
                </select>
                <input type="number" class="form-input extra-asset-amount" step="0.01" placeholder="Amount" value="${entry.amount || 0}">
                <div class="money-input">
                    <input type="hidden" class="extra-asset-currency" value="${entry.currency || defaultCurrency}">
                    <button type="button" class="currency-mini extra-asset-currency-btn">${entry.currency || defaultCurrency}</button>
                </div>
                <button type="button" class="mini-btn remove-asset-row">Remove</button>
            `;
            const amountInput = row.querySelector('.extra-asset-amount');
            if (amountInput) amountInput.dataset.draftKey = `extra_${row.dataset.draftRowId}`;

            row.querySelector('.extra-asset-type').value = entry.type || 'Other';
            if (entry.entryId) row.dataset.entryId = entry.entryId;

            const syncEntry = () => {
                const entryId = row.dataset.entryId;
                if (!entryId) return;
                const amount = parseFloat(row.querySelector('.extra-asset-amount')?.value || '0') || 0;
                const category = row.querySelector('.extra-asset-type')?.value || 'Other';
                const currency = row.querySelector('.extra-asset-currency')?.value || defaultCurrency;
                updateEntry(entryId, {
                    category,
                    amount,
                    currency,
                    note: '',
                    meta: { source: 'additional-entry' }
                });
            };

            row.querySelectorAll('input, select').forEach((el) => {
                el.addEventListener('input', () => {
                    if (el instanceof HTMLInputElement && isAmountInput(el)) setDraftForInput(el);
                    syncEntry();
                    calculateZakat();
                });
                el.addEventListener('change', () => {
                    if (el instanceof HTMLInputElement && isAmountInput(el)) setDraftForInput(el);
                    syncEntry();
                    calculateZakat();
                });
            });
            row.querySelector('.remove-asset-row').addEventListener('click', () => {
                if (row.dataset.entryId) removeEntry(row.dataset.entryId);
                row.remove();
                calculateZakat();
            });
            list.appendChild(row);
            initThousandSeparatedInputs(row);
            if (amountInput) setDraftForInput(amountInput);

            if (trackEntry && !row.dataset.entryId) {
                const created = addEntry({
                    category: row.querySelector('.extra-asset-type')?.value || 'Other',
                    amount: row.querySelector('.extra-asset-amount')?.value || '0',
                    currency: row.querySelector('.extra-asset-currency')?.value || defaultCurrency,
                    note: '',
                    meta: { source: 'additional-entry' }
                });
                row.dataset.entryId = created.id;
                showToast('Entry added');
            }
        }

        function addCoreExtraRow(field, entry = {}, options = {}) {
            const list = byId(`${field}ExtraList`);
            if (!list) return;
            const defaultCurrency = byId('currency')?.value || 'BDT';
            const trackEntry = options.trackEntry === true;

            const row = document.createElement('div');
            row.className = 'core-extra-row';
            row.dataset.field = field;
            row.dataset.draftRowId = makeEntryId();
            if (entry.entryId) row.dataset.entryId = entry.entryId;
            row.innerHTML = `
                <input type="number" class="form-input core-extra-amount" step="0.01" placeholder="Amount" value="${entry.amount || 0}">
                <div class="money-input">
                    <input type="hidden" class="core-extra-currency" value="${entry.currency || defaultCurrency}">
                    <button type="button" class="currency-mini core-extra-currency-btn">${entry.currency || defaultCurrency}</button>
                </div>
                <button type="button" class="mini-btn remove-core-row">Remove</button>
            `;
            const amountInput = row.querySelector('.core-extra-amount');
            if (amountInput) amountInput.dataset.draftKey = `core_${field}_${row.dataset.draftRowId}`;

            const syncEntry = () => {
                const entryId = row.dataset.entryId;
                if (!entryId) return;
                const amount = parseFloat(row.querySelector('.core-extra-amount')?.value || '0') || 0;
                const currency = row.querySelector('.core-extra-currency')?.value || defaultCurrency;
                updateEntry(entryId, {
                    category: coreFieldToCategory(field),
                    amount,
                    currency,
                    note: '',
                    meta: { source: 'core-entry', field }
                });
            };

            row.querySelectorAll('input').forEach((el) => {
                el.addEventListener('input', () => {
                    if (el instanceof HTMLInputElement && isAmountInput(el)) setDraftForInput(el);
                    syncEntry();
                    calculateZakat();
                });
                el.addEventListener('change', () => {
                    if (el instanceof HTMLInputElement && isAmountInput(el)) setDraftForInput(el);
                    syncEntry();
                    calculateZakat();
                });
            });
            row.querySelector('.remove-core-row').addEventListener('click', () => {
                if (row.dataset.entryId) removeEntry(row.dataset.entryId);
                row.remove();
                calculateZakat();
            });
            list.appendChild(row);
            initThousandSeparatedInputs(row);
            if (amountInput) setDraftForInput(amountInput);

            if (trackEntry && !row.dataset.entryId) {
                const created = addEntry({
                    category: coreFieldToCategory(field),
                    amount: row.querySelector('.core-extra-amount')?.value || '0',
                    currency: row.querySelector('.core-extra-currency')?.value || defaultCurrency,
                    note: '',
                    meta: { source: 'core-entry', field }
                });
                row.dataset.entryId = created.id;
                showToast('Entry added');
            }
        }

        function serializeCoreExtraEntries() {
            const fields = ['cashBank', 'stocks', 'gold', 'silver', 'business', 'receivables'];
            const data = {};
            fields.forEach((field) => {
                const rows = [];
                byId(`${field}ExtraList`)?.querySelectorAll('.core-extra-row').forEach((row) => {
                    rows.push({
                        label: row.querySelector('.core-extra-label')?.value || '',
                        amount: row.querySelector('.core-extra-amount')?.value || '0',
                        currency: row.querySelector('.core-extra-currency')?.value || 'BDT',
                        entryId: row.dataset.entryId || ''
                    });
                });
                data[field] = rows;
            });
            return data;
        }

        function restoreCoreExtraEntries(data) {
            const fields = ['cashBank', 'stocks', 'gold', 'silver', 'business', 'receivables'];
            fields.forEach((field) => {
                const list = byId(`${field}ExtraList`);
                if (!list) return;
                list.innerHTML = '';
                (data?.[field] || []).forEach((entry) => addCoreExtraRow(field, entry));
            });
        }

        function getCoreExtraTotalBdt(field, toBdt) {
            let total = 0;
            byId(`${field}ExtraList`)?.querySelectorAll('.core-extra-row').forEach((row) => {
                const amount = parseFloat(row.querySelector('.core-extra-amount')?.value) || 0;
                const currency = row.querySelector('.core-extra-currency')?.value || 'BDT';
                total += toBdt(amount, currency);
            });
            return total;
        }

        function updateCurrencyMiniButtons() {
            document.querySelectorAll('.currency-mini[data-currency-for]').forEach((btn) => {
                const id = btn.getAttribute('data-currency-for');
                const hidden = id ? document.getElementById(id) : null;
                if (hidden) btn.textContent = hidden.value || 'BDT';
            });
        }

        function toggleCurrencyFor(hiddenId) {
            const hidden = document.getElementById(hiddenId);
            if (!hidden) return;
            hidden.value = hidden.value === 'USD' ? 'BDT' : 'USD';
            updateCurrencyMiniButtons();
            calculateZakat();
        }

        function updateMetalPriceLabels() {
            const displayCurrency = byId('currency')?.value || 'BDT';
            const goldPriceLabel = byId('goldPriceLabel');
            const silverPriceLabel = byId('silverPriceLabel');
            if (goldPriceLabel) goldPriceLabel.textContent = `Gold Price per Gram (${displayCurrency})`;
            if (silverPriceLabel) silverPriceLabel.textContent = `Silver Price per Gram (${displayCurrency})`;
        }

        function getMetalPriceCurrency() {
            const goldInput = byId('goldPrice');
            const silverInput = byId('silverPrice');
            return goldInput?.dataset.priceCurrency || silverInput?.dataset.priceCurrency || 'USD';
        }

        function setMetalPriceCurrency(currency) {
            const safe = currency === 'BDT' ? 'BDT' : 'USD';
            const goldInput = byId('goldPrice');
            const silverInput = byId('silverPrice');
            if (goldInput) goldInput.dataset.priceCurrency = safe;
            if (silverInput) silverInput.dataset.priceCurrency = safe;
        }

        function convertMetalPricesBetweenCurrencies(fromCurrency, toCurrency) {
            if (!fromCurrency || !toCurrency || fromCurrency === toCurrency) return;
            const rate = parseFloat(byId('usdToBdt')?.value) || 0;
            if (rate <= 0) return;
            setMetalPriceBaseUsdFromVisible(fromCurrency);
            renderMetalPricesFromBaseUsd(toCurrency);
        }

        function setMetalPriceBaseUsdFromVisible(visibleCurrency) {
            const rate = parseFloat(byId('usdToBdt')?.value) || 0;
            ['goldPrice', 'silverPrice'].forEach((id) => {
                const input = byId(id);
                if (!input) return;
                const raw = parseFloat(input.value);
                if (!Number.isFinite(raw)) return;
                const baseUsd = visibleCurrency === 'USD'
                    ? raw
                    : (rate > 0 ? (raw / rate) : raw);
                input.dataset.baseUsd = String(baseUsd);
            });
            setMetalPriceCurrency(visibleCurrency);
        }

        function renderMetalPricesFromBaseUsd(targetCurrency) {
            const rate = parseFloat(byId('usdToBdt')?.value) || 0;
            ['goldPrice', 'silverPrice'].forEach((id) => {
                const input = byId(id);
                if (!input) return;
                let baseUsd = parseFloat(input.dataset.baseUsd || '');
                if (!Number.isFinite(baseUsd)) {
                    const fallback = parseFloat(input.value);
                    if (!Number.isFinite(fallback)) return;
                    const currentCurrency = getMetalPriceCurrency();
                    baseUsd = currentCurrency === 'USD' ? fallback : (rate > 0 ? (fallback / rate) : fallback);
                    input.dataset.baseUsd = String(baseUsd);
                }
                const nextVal = targetCurrency === 'USD' ? baseUsd : baseUsd * rate;
                input.value = Number.isFinite(nextVal) ? nextVal.toFixed(2) : input.value;
            });
            setMetalPriceCurrency(targetCurrency);
        }

        function maybeMigrateLegacyMetalPrices(displayCurrency) {
            const goldVal = parseFloat(byId('goldPrice')?.value || '');
            const silverVal = parseFloat(byId('silverPrice')?.value || '');
            if (!Number.isFinite(goldVal) || !Number.isFinite(silverVal)) return;

            // Heuristic for older saves where labels changed but values stayed in previous currency.
            if (displayCurrency === 'BDT' && goldVal < 1000 && silverVal < 50) {
                convertMetalPricesBetweenCurrencies('USD', 'BDT');
                return;
            }
            if (displayCurrency === 'USD' && goldVal > 1000 && silverVal > 50) {
                convertMetalPricesBetweenCurrencies('BDT', 'USD');
            }
        }

        async function fetchLiveMetalPrices() {
            const statusEl = byId('livePriceStatus');
            const btn = byId('fetchLivePricesBtn');
            if (statusEl) statusEl.textContent = 'Fetching live prices...';
            if (btn) btn.disabled = true;

            try {
                const [goldRes, silverRes] = await Promise.all([
                    fetch('https://api.gold-api.com/price/XAU'),
                    fetch('https://api.gold-api.com/price/XAG')
                ]);
                if (!goldRes.ok || !silverRes.ok) {
                    throw new Error('Unable to fetch live prices');
                }

                const [goldData, silverData] = await Promise.all([goldRes.json(), silverRes.json()]);
                const ozToGram = 31.1034768;
                const goldUsdPerGram = (Number(goldData?.price) || 0) / ozToGram;
                const silverUsdPerGram = (Number(silverData?.price) || 0) / ozToGram;

                if (!(goldUsdPerGram > 0) || !(silverUsdPerGram > 0)) {
                    throw new Error('Invalid live price response');
                }

                const goldInput = byId('goldPrice');
                const silverInput = byId('silverPrice');
                if (goldInput) goldInput.dataset.baseUsd = String(goldUsdPerGram);
                if (silverInput) silverInput.dataset.baseUsd = String(silverUsdPerGram);

                const displayCurrency = byId('currency')?.value || 'BDT';
                renderMetalPricesFromBaseUsd(displayCurrency);
                updateMetalPriceLabels();
                calculateZakat();

                const updatedAt = goldData?.updatedAt || silverData?.updatedAt || '';
                let updatedText = 'Live prices updated';
                if (updatedAt) {
                    const dt = new Date(updatedAt);
                    if (!Number.isNaN(dt.getTime())) {
                        updatedText += ` (${new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'short' }).format(dt)})`;
                    }
                }
                if (statusEl) statusEl.textContent = updatedText;
            } catch (error) {
                if (statusEl) statusEl.textContent = 'Live price fetch failed. Enter values manually.';
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function autoFetchLiveMetalPricesIfEmpty() {
            const goldVal = parseFloat(byId('goldPrice')?.value || '');
            const silverVal = parseFloat(byId('silverPrice')?.value || '');
            const goldEmpty = !Number.isFinite(goldVal) || goldVal <= 0;
            const silverEmpty = !Number.isFinite(silverVal) || silverVal <= 0;
            if (goldEmpty && silverEmpty) {
                fetchLiveMetalPrices();
            }
        }

        function syncDefaultCurrenciesToMain() {
            const mainCurrency = document.getElementById('currency')?.value || 'BDT';
            const fieldMap = {
                cashBankTotalCur: 'cashBankTotalAmt',
                cashCur: 'cashAmt',
                bankCur: 'bankAmt',
                goldCur: 'goldAmt',
                silverCur: 'silverAmt',
                investmentsCur: 'investmentsAmt',
                digitalAssetsCur: 'digitalAssetsAmt',
                businessCur: 'businessAmt',
                receivablesCur: 'receivablesAmt',
                debtsCur: 'debtsAmt'
            };

            Object.keys(fieldMap).forEach((curId) => {
                const curEl = document.getElementById(curId);
                const amtEl = document.getElementById(fieldMap[curId]);
                if (!curEl || !amtEl) return;
                const amount = parseFloat(amtEl.value) || 0;
                if (!curEl.value || amount === 0) curEl.value = mainCurrency;
            });

            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                const amount = parseFloat(row.querySelector('.extra-asset-amount')?.value) || 0;
                const curEl = row.querySelector('.extra-asset-currency');
                const curBtn = row.querySelector('.extra-asset-currency-btn');
                if (!curEl) return;
                if (!curEl.value || amount === 0) curEl.value = mainCurrency;
                if (curBtn) curBtn.textContent = curEl.value;
            });

            updateCurrencyMiniButtons();
        }

        function handleMainCurrencyChange() {
            const currencyEl = byId('currency');
            if (!currencyEl) return;
            const nextCurrency = currencyEl.value || 'BDT';
            const prevCurrency = lastDisplayCurrency || getMetalPriceCurrency();
            if (prevCurrency !== nextCurrency) {
                convertMetalPricesBetweenCurrencies(prevCurrency, nextCurrency);
            }
            setMetalPriceCurrency(nextCurrency);
            lastDisplayCurrency = nextCurrency;
            updateMetalPriceLabels();
            syncDefaultCurrenciesToMain();
            calculateZakat();
        }

        function getExtraAssetsBdt(toBdt) {
            let total = 0;
            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                const amount = parseFloat(row.querySelector('.extra-asset-amount')?.value) || 0;
                const currency = row.querySelector('.extra-asset-currency')?.value || 'BDT';
                total += toBdt(amount, currency);
            });
            return total;
        }

        function serializeExtraAssets() {
            const rows = [];
            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                rows.push({
                    type: row.querySelector('.extra-asset-type')?.value || 'Other',
                    amount: row.querySelector('.extra-asset-amount')?.value || '0',
                    currency: row.querySelector('.extra-asset-currency')?.value || 'BDT',
                    entryId: row.dataset.entryId || ''
                });
            });
            return rows;
        }

        function restoreExtraAssets(entries) {
            const list = document.getElementById('extraAssetsList');
            if (!list) return;
            list.innerHTML = '';
            (entries || []).forEach((entry) => addExtraAssetRow(entry));
        }

        function setSplitPanelOpen(isOpen) {
            const splitPanel = byId('splitCashBankPanel');
            const splitBtn = byId('splitCashBankBtn');
            if (!splitPanel || !splitBtn) return;
            splitPanel.classList.toggle('open', isOpen);
            splitBtn.textContent = isOpen ? 'Hide split details' : 'Split details';
            splitBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }

        function setupAssetCategoryChips() {
            document.querySelectorAll('.asset-chip[data-asset-jump]').forEach((chip) => {
                chip.addEventListener('click', () => {
                    const targetId = chip.getAttribute('data-asset-jump');
                    const rawTarget = targetId ? byId(targetId) : null;
                    if (!rawTarget) return;

                    // Keep the section heading visible under fixed top-nav + sticky assets bar.
                    const topNavH = document.querySelector('.top-nav')?.offsetHeight || 64;
                    const assetsBarH = byId('assetsTopbar')?.offsetHeight || 0;
                    const extraGap = 20;
                    const offset = topNavH + Math.min(assetsBarH, 86) + extraGap;

                    // "Cash" should jump to the top of assets, not below the heading.
                    const target = targetId === 'assetsCashGroup' ? (byId('assetsCard') || rawTarget) : rawTarget;
                    const targetY = Math.max(0, window.scrollY + target.getBoundingClientRect().top - offset);
                    window.scrollTo({ top: targetY, behavior: prefersReducedMotion ? 'auto' : 'smooth' });
                });
            });
        }

        function updateCurrentDates() {
            const now = new Date();
            const gregorianEl = document.getElementById('todayGregorian');
            const hijriEl = document.getElementById('todayHijri');
            if (!gregorianEl || !hijriEl) return;

            const gregorianDate = new Intl.DateTimeFormat('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).format(now);
            gregorianEl.textContent = gregorianDate;

            try {
                const hijriFormatter = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                const calendarName = hijriFormatter.resolvedOptions().calendar || '';
                if (!calendarName.toLowerCase().startsWith('islamic')) {
                    throw new Error('Hijri calendar not supported');
                }
                const parts = hijriFormatter.formatToParts(now);
                const monthPart = parts.find((p) => p.type === 'month')?.value || '';
                hijriEl.textContent = hijriFormatter.format(now) + ' AH';

                const isRamadan = monthPart.toLowerCase().includes('ramadan');
                document.body.classList.toggle('ramadan-mode', isRamadan);
            } catch (e) {
                hijriEl.textContent = 'Hijri date not supported on this device';
                document.body.classList.remove('ramadan-mode');
            }
        }

        function scheduleDateRefreshAtMidnight() {
            if (midnightRefreshTimer) clearTimeout(midnightRefreshTimer);
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const msUntilMidnight = nextMidnight.getTime() - now.getTime();

            midnightRefreshTimer = setTimeout(() => {
                updateCurrentDates();
                scheduleDateRefreshAtMidnight();
            }, msUntilMidnight);
        }

        function fillHijriDayOptions() {
            const daySelect = document.getElementById('zakatHijriDay');
            if (!daySelect || daySelect.options.length > 1) return;
            for (let d = 1; d <= 30; d += 1) {
                const option = document.createElement('option');
                option.value = String(d);
                option.textContent = String(d);
                daySelect.appendChild(option);
            }
        }

        function formatIsoDate(isoDate) {
            if (!isoDate) return '-';
            const dt = new Date(`${isoDate}T00:00:00`);
            if (Number.isNaN(dt.getTime())) return '-';
            return new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).format(dt);
        }

        function addDaysToIso(isoDate, days) {
            if (!isoDate) return '';
            const dt = new Date(`${isoDate}T00:00:00`);
            if (Number.isNaN(dt.getTime())) return '';
            dt.setDate(dt.getDate() + days);
            return dt.toISOString().slice(0, 10);
        }

        function updateHawlReminderUI() {
            const hijriDay = document.getElementById('zakatHijriDay')?.value || '';
            const hijriMonth = document.getElementById('zakatHijriMonth')?.value || '';
            const hijriNote = document.getElementById('zakatHijriNote')?.value?.trim() || '';
            const lastPaid = document.getElementById('lastZakatPaid')?.value || '';

            const zakatDateText = hijriNote || ((hijriDay && hijriMonth) ? `${hijriDay} ${hijriMonth}` : '-');
            const nextDueIso = addDaysToIso(lastPaid, 354);

            const zakatDateSummary = document.getElementById('zakatDateSummary');
            const lastPaidSummary = document.getElementById('lastPaidSummary');
            const nextDueSummary = document.getElementById('nextDueSummary');
            const dueStatusBadge = document.getElementById('dueStatusBadge');
            if (!zakatDateSummary || !lastPaidSummary || !nextDueSummary || !dueStatusBadge) return;

            zakatDateSummary.textContent = zakatDateText;
            lastPaidSummary.textContent = formatIsoDate(lastPaid);
            nextDueSummary.textContent = nextDueIso ? formatIsoDate(nextDueIso) : '-';

            dueStatusBadge.classList.remove('soon', 'overdue');
            dueStatusBadge.textContent = 'On track';

            if (nextDueIso) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const nextDue = new Date(`${nextDueIso}T00:00:00`);
                const msDiff = nextDue.getTime() - today.getTime();
                const daysDiff = Math.floor(msDiff / (24 * 60 * 60 * 1000));
                if (daysDiff < 0) {
                    dueStatusBadge.textContent = 'Overdue';
                    dueStatusBadge.classList.add('overdue');
                } else if (daysDiff <= 14) {
                    dueStatusBadge.textContent = 'Due soon';
                    dueStatusBadge.classList.add('soon');
                }
            }
        }

        function recalcFast() {
            const currency = byId('currency').value;
            const symbol = currencySymbols[currency];
            const nisabType = byId('nisabType').value;
            const goldPrice = parseFloat(byId('goldPrice').value) || 0;
            const silverPrice = parseFloat(byId('silverPrice').value) || 0;
            const usdToBdt = parseFloat(byId('usdToBdt').value) || 0;
            const priceCurrency = currency;

            const read = (id) => parseFloat(byId(id).value) || 0;
            const toBdt = (amount, entryCurrency) => {
                if (entryCurrency === 'BDT') return amount;
                if (entryCurrency === 'USD') return amount * usdToBdt;
                return 0;
            };
            const bdtToDisplay = (amountBdt) => (currency === 'BDT' ? amountBdt : (usdToBdt > 0 ? (amountBdt / usdToBdt) : 0));

            const splitCash = read('cashAmt');
            const splitBank = read('bankAmt');
            const useSplitCashBank = splitCash > 0 || splitBank > 0;
            const cashBdt = useSplitCashBank
                ? toBdt(splitCash, byId('cashCur').value)
                : toBdt(read('cashBankTotalAmt'), byId('cashBankTotalCur').value);
            const bankBdt = useSplitCashBank ? toBdt(splitBank, byId('bankCur').value) : 0;
            const goldBdt = toBdt(read('goldAmt'), byId('goldCur').value);
            const silverBdt = toBdt(read('silverAmt'), byId('silverCur').value);
            const investmentsBdt = toBdt(read('investmentsAmt'), byId('investmentsCur').value);
            const digitalAssetsBdt = toBdt(read('digitalAssetsAmt'), byId('digitalAssetsCur').value);
            const businessBdt = toBdt(read('businessAmt'), byId('businessCur').value);
            const receivablesBdt = toBdt(read('receivablesAmt'), byId('receivablesCur').value);
            const extraAssetsBdt = getExtraAssetsBdt(toBdt);
            const debtsBdt = toBdt(read('debtsAmt'), byId('debtsCur').value);

            const cashBankBdt = cashBdt + bankBdt + getCoreExtraTotalBdt('cashBank', toBdt);
            const stocksBdt = investmentsBdt + getCoreExtraTotalBdt('stocks', toBdt);
            const goldTotalBdt = goldBdt + getCoreExtraTotalBdt('gold', toBdt);
            const silverTotalBdt = silverBdt + getCoreExtraTotalBdt('silver', toBdt);
            const businessTotalBdt = businessBdt + getCoreExtraTotalBdt('business', toBdt);
            const receivablesTotalBdt = receivablesBdt + getCoreExtraTotalBdt('receivables', toBdt);

            const totalAssetsBdt = cashBankBdt + goldTotalBdt + silverTotalBdt + stocksBdt + digitalAssetsBdt + businessTotalBdt + receivablesTotalBdt + extraAssetsBdt;
            const totalLiabilitiesBdt = debtsBdt;
            const zakatableWealthBdt = totalAssetsBdt - totalLiabilitiesBdt;

            const GOLD_NISAB_GRAMS = 87.48;
            const SILVER_NISAB_GRAMS = 612.36;
            const nisabPriceValue = nisabType === 'gold' ? (GOLD_NISAB_GRAMS * goldPrice) : (SILVER_NISAB_GRAMS * silverPrice);
            const nisabThresholdBdt = priceCurrency === 'BDT'
                ? nisabPriceValue
                : nisabPriceValue * usdToBdt;
            const zakatAmountBdt = zakatableWealthBdt >= nisabThresholdBdt ? (zakatableWealthBdt * 0.025) : 0;
            latestZakatAmountBdt = zakatAmountBdt;

            const formatter = getCurrencyFormatter(currency);
            const totalAssets = bdtToDisplay(totalAssetsBdt);
            const totalLiabilities = bdtToDisplay(totalLiabilitiesBdt);
            const zakatableWealth = bdtToDisplay(zakatableWealthBdt);
            const nisabThreshold = bdtToDisplay(nisabThresholdBdt);
            const zakatAmountDisplay = bdtToDisplay(zakatAmountBdt);
            const zakatAmountUsd = usdToBdt > 0 ? (zakatAmountBdt / usdToBdt) : 0;

            animateNumber(byId('totalAssets'), totalAssets, (v) => { byId('totalAssets').textContent = symbol + formatter.format(v); });
            animateNumber(byId('totalLiabilities'), totalLiabilities, (v) => { byId('totalLiabilities').textContent = symbol + formatter.format(v); });
            byId('zakatableWealth').textContent = currency === 'BDT'
                ? ("BDT " + formatter.format(zakatableWealthBdt))
                : (symbol + formatter.format(zakatableWealth) + " (BDT " + formatter.format(zakatableWealthBdt) + ")");
            byId('nisabThreshold').textContent = currency === 'BDT'
                ? ("BDT " + formatter.format(nisabThresholdBdt))
                : (symbol + formatter.format(nisabThreshold) + " (BDT " + formatter.format(nisabThresholdBdt) + ")");
            byId('zakatAmountLabel').textContent = `Your Zakat Due (2.5%) in ${currency}`;
            animateNumber(byId('zakatAmount'), zakatAmountDisplay, (v) => { byId('zakatAmount').textContent = formatter.format(v); }, 850);
            animateNumber(byId('zakatAmountSecondary'), currency === 'BDT' ? zakatAmountUsd : zakatAmountBdt, (v) => {
                byId('zakatAmountSecondary').textContent = currency === 'BDT' ? ("USD " + formatter.format(v)) : ("BDT " + formatter.format(v));
            }, 850);
            animateNumber(byId('bdCashBank'), bdtToDisplay(cashBankBdt), (v) => { byId('bdCashBank').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdMetals'), bdtToDisplay(goldTotalBdt + silverTotalBdt), (v) => { byId('bdMetals').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdCrypto'), bdtToDisplay(digitalAssetsBdt), (v) => { byId('bdCrypto').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdStocks'), bdtToDisplay(stocksBdt), (v) => { byId('bdStocks').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdBusiness'), bdtToDisplay(businessTotalBdt), (v) => { byId('bdBusiness').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdReceivables'), bdtToDisplay(receivablesTotalBdt), (v) => { byId('bdReceivables').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdExtraAssets'), bdtToDisplay(extraAssetsBdt), (v) => { byId('bdExtraAssets').textContent = symbol + formatter.format(v); });
            animateNumber(byId('bdDebts'), bdtToDisplay(debtsBdt), (v) => { byId('bdDebts').textContent = symbol + formatter.format(v); });
            const assetsLiveTotalEl = byId('assetsLiveTotal');
            if (assetsLiveTotalEl) assetsLiveTotalEl.textContent = symbol + formatter.format(totalAssets);
            const assetsLiveTotalSubEl = byId('assetsLiveTotalSub');
            if (assetsLiveTotalSubEl) {
                assetsLiveTotalSubEl.textContent = currency === 'BDT'
                    ? ("USD " + formatter.format(usdToBdt > 0 ? (totalAssetsBdt / usdToBdt) : 0))
                    : ("BDT " + formatter.format(totalAssetsBdt));
            }
            const nisabTabThreshold = byId('nisabTabThreshold');
            if (nisabTabThreshold) {
                nisabTabThreshold.textContent = currency === 'BDT'
                    ? ("BDT " + formatter.format(nisabThresholdBdt))
                    : (symbol + formatter.format(nisabThreshold));
            }
            const nisabTabWealth = byId('nisabTabWealth');
            if (nisabTabWealth) {
                nisabTabWealth.textContent = currency === 'BDT'
                    ? ("BDT " + formatter.format(zakatableWealthBdt))
                    : (symbol + formatter.format(zakatableWealth));
            }
            const nisabTabGap = byId('nisabTabGap');
            if (nisabTabGap) {
                const gapBdt = zakatableWealthBdt - nisabThresholdBdt;
                const gapDisplay = bdtToDisplay(Math.abs(gapBdt));
                const gapPrefix = gapBdt >= 0 ? 'Above ' : 'Below ';
                nisabTabGap.textContent = gapPrefix + (currency === 'BDT'
                    ? ("BDT " + formatter.format(Math.abs(gapBdt)))
                    : (symbol + formatter.format(gapDisplay)));
            }
            updateHawlReminderUI();

            const finalCard = document.querySelector('.final-result');
            if (finalCard && !prefersReducedMotion) {
                finalCard.classList.remove('pulse-in');
                void finalCard.offsetWidth;
                finalCard.classList.add('pulse-in');
            }

            const statusEl = byId('nisabStatus');
            const heroStatusEl = byId('resultsHeroStatus');
            const isEligible = zakatableWealthBdt >= nisabThresholdBdt && zakatAmountBdt > 0;
            if (zakatableWealthBdt < nisabThresholdBdt) {
                if (heroStatusEl) heroStatusEl.textContent = 'Below Nisab. Zakat is not due at this time.';
                statusEl.innerHTML = 'Below Nisab threshold';
                statusEl.style.background = 'rgba(139, 97, 24, 0.4)';
                statusEl.style.border = '1px solid rgba(255, 208, 106, 0.55)';
            } else {
                if (heroStatusEl) heroStatusEl.textContent = 'Above Nisab. Your zakat is due for this cycle.';
                statusEl.innerHTML = 'Above Nisab threshold';
                statusEl.style.background = 'rgba(116, 87, 27, 0.38)';
                statusEl.style.border = '1px solid rgba(244, 212, 123, 0.5)';
            }
            if (isEligible && !wasZakatEligible) {
                launchResultConfetti();
            }
            wasZakatEligible = isEligible;

            updateQuickStartProgress();
        }

        function calculateZakat() {
            recalculateTotals();
        }

        function saveData() {
            const data = {
                currency: byId('currency').value,
                themeMode: byId('themeMode')?.value || 'midnight-gold',
                nisabType: byId('nisabType').value,
                usdToBdt: byId('usdToBdt').value,
                goldPrice: byId('goldPrice').value,
                silverPrice: byId('silverPrice').value,
                metalPriceCurrency: getMetalPriceCurrency(),
                zakatHijriMonth: byId('zakatHijriMonth').value,
                zakatHijriDay: byId('zakatHijriDay').value,
                zakatHijriNote: byId('zakatHijriNote').value,
                lastZakatPaid: byId('lastZakatPaid').value,
                cashBankTotalAmt: byId('cashBankTotalAmt').value,
                cashBankTotalCur: byId('cashBankTotalCur').value,
                cashBankTotalNote: byId('cashBankTotalNote')?.value || '',
                cashAmt: byId('cashAmt').value,
                cashCur: byId('cashCur').value,
                cashNote: byId('cashNote')?.value || '',
                bankAmt: byId('bankAmt').value,
                bankCur: byId('bankCur').value,
                bankNote: byId('bankNote')?.value || '',
                goldAmt: byId('goldAmt').value,
                goldCur: byId('goldCur').value,
                goldNote: byId('goldNote')?.value || '',
                silverAmt: byId('silverAmt').value,
                silverCur: byId('silverCur').value,
                silverNote: byId('silverNote')?.value || '',
                investmentsAmt: byId('investmentsAmt').value,
                investmentsCur: byId('investmentsCur').value,
                investmentsNote: byId('investmentsNote')?.value || '',
                digitalAssetsAmt: byId('digitalAssetsAmt').value,
                digitalAssetsCur: byId('digitalAssetsCur').value,
                digitalAssetsNote: byId('digitalAssetsNote')?.value || '',
                businessAmt: byId('businessAmt').value,
                businessCur: byId('businessCur').value,
                businessNote: byId('businessNote')?.value || '',
                receivablesAmt: byId('receivablesAmt').value,
                receivablesCur: byId('receivablesCur').value,
                receivablesNote: byId('receivablesNote')?.value || '',
                debtsAmt: byId('debtsAmt').value,
                debtsCur: byId('debtsCur').value,
                coreExtraEntries: serializeCoreExtraEntries(),
                extraAssets: serializeExtraAssets()
            };
            localStorage.setItem('zakatCalculatorData', JSON.stringify(data));
            localStorage.setItem(themeStorageKey, data.themeMode);
        }

        function loadData() {
            const saved = localStorage.getItem('zakatCalculatorData');
            const savedTheme = localStorage.getItem(themeStorageKey);
            if (savedTheme) applyTheme(savedTheme);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.themeMode) applyTheme(data.themeMode);

                // Backward compatibility: migrate old BDT/USD split fields if present.
                const migrate = (newAmt, newCur, oldBDT, oldUSD) => {
                    if (data[newAmt] !== undefined) return;
                    const bdt = parseFloat(data[oldBDT] || 0) || 0;
                    const usd = parseFloat(data[oldUSD] || 0) || 0;
                    if (bdt > 0) {
                        data[newAmt] = String(bdt);
                        data[newCur] = 'BDT';
                    } else if (usd > 0) {
                        data[newAmt] = String(usd);
                        data[newCur] = 'USD';
                    }
                };

                migrate('bankAmt', 'bankCur', 'bankBDT', 'bankUSD');
                migrate('goldAmt', 'goldCur', 'goldBDT', 'goldUSD');
                migrate('silverAmt', 'silverCur', 'silverBDT', 'silverUSD');
                migrate('investmentsAmt', 'investmentsCur', 'investmentsBDT', 'investmentsUSD');
                migrate('digitalAssetsAmt', 'digitalAssetsCur', 'cryptoBDT', 'cryptoUSD');
                migrate('businessAmt', 'businessCur', 'businessBDT', 'businessUSD');
                migrate('receivablesAmt', 'receivablesCur', 'receivablesBDT', 'receivablesUSD');
                migrate('debtsAmt', 'debtsCur', 'debtsBDT', 'debtsUSD');

                if (data.digitalAssetsAmt === undefined && data.cryptoAmt !== undefined) {
                    data.digitalAssetsAmt = data.cryptoAmt;
                    data.digitalAssetsCur = data.cryptoCur || 'BDT';
                }

                // Migrate previous dual cash inputs back into current single cash input.
                if (data.cashAmt === undefined) {
                    const legacyCashBdt = parseFloat(data.cashBDT || 0) || 0;
                    const legacyCashUsd = parseFloat(data.cashUSD || 0) || 0;
                    data.cashAmt = String(legacyCashBdt);
                    data.cashCur = 'BDT';
                    if (legacyCashUsd > 0) {
                        data.extraAssets = data.extraAssets || [];
                        data.extraAssets.push({
                            type: 'Cash',
                            amount: String(legacyCashUsd),
                            currency: 'USD'
                        });
                    }
                }

                if (data.cashBankTotalAmt === undefined) data.cashBankTotalAmt = '0';
                if (data.cashBankTotalCur === undefined) data.cashBankTotalCur = data.currency || 'BDT';
                if (data.lastZakatPaid === undefined) data.lastZakatPaid = new Date().toISOString().slice(0, 10);

                // Backward compatibility: older extra rows used "label" instead of "type".
                if (Array.isArray(data.extraAssets)) {
                    data.extraAssets = data.extraAssets.map((entry) => ({
                        type: entry.type || entry.label || 'Other',
                        amount: entry.amount || '0',
                        currency: entry.currency || 'BDT'
                    }));
                }

                if (!data.coreExtraEntries || typeof data.coreExtraEntries !== 'object') {
                    data.coreExtraEntries = {
                        cashBank: [],
                        stocks: [],
                        gold: [],
                        silver: [],
                        business: [],
                        receivables: []
                    };
                }

                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = data[key];
                });

                // Preserve and migrate metal price currency context.
                const savedMetalCurrency = (data.metalPriceCurrency === 'BDT' || data.metalPriceCurrency === 'USD')
                    ? data.metalPriceCurrency
                    : 'USD';
                setMetalPriceCurrency(savedMetalCurrency);
                const displayCurrency = byId('currency')?.value || 'BDT';
                if (savedMetalCurrency !== displayCurrency) {
                    convertMetalPricesBetweenCurrencies(savedMetalCurrency, displayCurrency);
                }
                // Safety migration for older/stale saves where metalPriceCurrency was stored
                // but values were still in the other unit.
                maybeMigrateLegacyMetalPrices(displayCurrency);
                lastDisplayCurrency = displayCurrency;
                setMetalPriceBaseUsdFromVisible(displayCurrency);
                updateMetalPriceLabels();

                restoreCoreExtraEntries(data.coreExtraEntries);
                restoreExtraAssets(data.extraAssets);
                const splitPanel = document.getElementById('splitCashBankPanel');
                const splitBtn = document.getElementById('splitCashBankBtn');
                if (splitPanel && splitBtn) {
                    const cashSplit = parseFloat(data.cashAmt || '0') || 0;
                    const bankSplit = parseFloat(data.bankAmt || '0') || 0;
                    setSplitPanelOpen(cashSplit > 0 || bankSplit > 0);
                }
                syncDefaultCurrenciesToMain();
                recalcFast();
            } else {
                restoreCoreExtraEntries({});
                restoreExtraAssets([]);
                setMetalPriceCurrency(byId('currency')?.value || 'USD');
                setMetalPriceBaseUsdFromVisible(byId('currency')?.value || 'BDT');
                updateMetalPriceLabels();
                lastDisplayCurrency = byId('currency')?.value || 'BDT';
                syncDefaultCurrenciesToMain();
                setSplitPanelOpen(false);
                const lastPaidEl = document.getElementById('lastZakatPaid');
                if (lastPaidEl && !lastPaidEl.value) {
                    lastPaidEl.value = new Date().toISOString().slice(0, 10);
                }
                recalcFast();
            }
        }

        function scrollToCalculator() {
            const calculator = document.getElementById('calculator');
            if (!calculator) return;
            calculator.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' });
            if (prefersReducedMotion) return;
            calculator.classList.remove('spotlight-active');
            void calculator.offsetWidth;
            calculator.classList.add('spotlight-active');
            setTimeout(() => calculator.classList.remove('spotlight-active'), 900);
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exportInvoicePdf() {
            // Ensure invoice values use the latest current calculation output.
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setText('invoiceGeneratedOn', `Generated on: ${new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date())}`);
            setText('invoiceTotalAssets', document.getElementById('totalAssets')?.textContent || '-');
            setText('invoiceTotalLiabilities', document.getElementById('totalLiabilities')?.textContent || '-');
            setText('invoiceZakatableWealth', document.getElementById('zakatableWealth')?.textContent || '-');
            setText('invoiceNisabThreshold', document.getElementById('nisabThreshold')?.textContent || '-');
            setText('invoiceZakatAmount', document.getElementById('zakatAmount')?.textContent || '-');

            const statusRaw = (document.getElementById('nisabStatus')?.textContent || '').replace(/[\u26A0\uFE0F\u2705]/g, '').trim();
            setText('invoiceNisabStatus', statusRaw || '-');

            document.body.classList.add('invoice-print');
            window.print();
            setTimeout(() => {
                document.body.classList.remove('invoice-print');
            }, 250);
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function buildReportDataFromState() {
            const currency = byId('currency')?.value || 'BDT';
            const symbol = currencySymbols[currency] || '';
            const formatter = getCurrencyFormatter(currency);
            const usdToBdt = sanitizeAmount(byId('usdToBdt')?.value || 0);
            const toBdt = (amount, cur) => {
                const val = sanitizeAmount(amount);
                const c = String(cur || 'BDT').toUpperCase();
                if (c === 'BDT') return val;
                return usdToBdt > 0 ? val * usdToBdt : 0;
            };
            const bdtToDisplay = (amountBdt) => (currency === 'BDT' ? amountBdt : (usdToBdt > 0 ? amountBdt / usdToBdt : 0));
            const formatDisplay = (amountBdt) => `${symbol}${formatter.format(bdtToDisplay(amountBdt))}`;
            const formatBdt = (amountBdt) => `BDT ${getCurrencyFormatter('BDT').format(amountBdt)}`;
            const nisabType = (byId('nisabType')?.value || 'silver').toLowerCase();
            const nisabMethodText = nisabType === 'gold' ? 'Gold (87.48g)' : 'Silver (612.36g)';

            const entriesStore = loadEntries();
            const now = new Date();
            const nowText = new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'medium' }).format(now);

            const pushRow = (rows, payload) => {
                const amount = sanitizeAmount(payload.amount);
                if (!(amount > 0)) return;
                const currencyCode = String(payload.currency || 'BDT').toUpperCase();
                const convertedBdt = toBdt(amount, currencyCode);
                rows.push({
                    category: payload.category || 'Other',
                    label: payload.label || '',
                    amount,
                    currency: currencyCode,
                    convertedBdt,
                    timestamp: payload.timestamp || '-'
                });
            };

            const assetRows = [];
            const debtRows = [];

            const splitCash = sanitizeAmount(byId('cashAmt')?.value || 0);
            const splitBank = sanitizeAmount(byId('bankAmt')?.value || 0);
            const useSplitCashBank = splitCash > 0 || splitBank > 0;
            if (useSplitCashBank) {
                pushRow(assetRows, { category: 'Cash', label: byId('cashNote')?.value || '', amount: splitCash, currency: byId('cashCur')?.value || 'BDT' });
                pushRow(assetRows, { category: 'Bank', label: byId('bankNote')?.value || '', amount: splitBank, currency: byId('bankCur')?.value || 'BDT' });
            } else {
                pushRow(assetRows, { category: 'Cash + Bank', label: byId('cashBankTotalNote')?.value || '', amount: byId('cashBankTotalAmt')?.value || 0, currency: byId('cashBankTotalCur')?.value || 'BDT' });
            }

            pushRow(assetRows, { category: 'Gold Cash', label: byId('goldNote')?.value || '', amount: byId('goldAmt')?.value || 0, currency: byId('goldCur')?.value || 'BDT' });
            pushRow(assetRows, { category: 'Silver', label: byId('silverNote')?.value || '', amount: byId('silverAmt')?.value || 0, currency: byId('silverCur')?.value || 'BDT' });
            pushRow(assetRows, { category: 'Investments', label: byId('investmentsNote')?.value || '', amount: byId('investmentsAmt')?.value || 0, currency: byId('investmentsCur')?.value || 'BDT' });
            pushRow(assetRows, { category: 'Digital Assets', label: byId('digitalAssetsNote')?.value || '', amount: byId('digitalAssetsAmt')?.value || 0, currency: byId('digitalAssetsCur')?.value || 'BDT' });
            pushRow(assetRows, { category: 'Business Inventory', label: byId('businessNote')?.value || '', amount: byId('businessAmt')?.value || 0, currency: byId('businessCur')?.value || 'BDT' });
            pushRow(assetRows, { category: 'Money Owed To You', label: byId('receivablesNote')?.value || '', amount: byId('receivablesAmt')?.value || 0, currency: byId('receivablesCur')?.value || 'BDT' });

            document.querySelectorAll('.core-extra-row').forEach((row) => {
                pushRow(assetRows, {
                    category: coreFieldToCategory(row.dataset.field || ''),
                    label: 'Additional entry',
                    amount: row.querySelector('.core-extra-amount')?.value || 0,
                    currency: row.querySelector('.core-extra-currency')?.value || 'BDT'
                });
            });

            document.querySelectorAll('.extra-asset-row').forEach((row) => {
                pushRow(assetRows, {
                    category: row.querySelector('.extra-asset-type')?.value || 'Other',
                    label: 'Additional asset',
                    amount: row.querySelector('.extra-asset-amount')?.value || 0,
                    currency: row.querySelector('.extra-asset-currency')?.value || 'BDT'
                });
            });

            pushRow(debtRows, {
                category: 'Liabilities',
                label: 'Short-term debts',
                amount: byId('debtsAmt')?.value || 0,
                currency: byId('debtsCur')?.value || 'BDT'
            });

            entriesStore.forEach((entry) => {
                const categoryText = String(entry.category || 'Other');
                const isDebt = /debt|liabil/i.test(categoryText);
                const target = isDebt ? debtRows : assetRows;
                pushRow(target, {
                    category: categoryText,
                    label: entry.note || '',
                    amount: entry.amount || 0,
                    currency: entry.currency || 'BDT',
                    timestamp: entry.createdAt ? new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(entry.createdAt)) : '-'
                });
            });

            const totalAssetsBdt = assetRows.reduce((sum, row) => sum + row.convertedBdt, 0);
            const totalLiabilitiesBdt = debtRows.reduce((sum, row) => sum + row.convertedBdt, 0);
            const zakatableWealthBdt = totalAssetsBdt - totalLiabilitiesBdt;
            const goldPrice = sanitizeAmount(byId('goldPrice')?.value || 0);
            const silverPrice = sanitizeAmount(byId('silverPrice')?.value || 0);
            const nisabValueRaw = nisabType === 'gold' ? (87.48 * goldPrice) : (612.36 * silverPrice);
            const nisabThresholdBdt = currency === 'BDT' ? nisabValueRaw : (nisabValueRaw * usdToBdt);
            const zakatDueBdt = zakatableWealthBdt >= nisabThresholdBdt ? zakatableWealthBdt * 0.025 : 0;

            const assetCategoryTotalsBdt = {};
            assetRows.forEach((row) => {
                assetCategoryTotalsBdt[row.category] = (assetCategoryTotalsBdt[row.category] || 0) + row.convertedBdt;
            });

            const debtCategoryTotalsBdt = {};
            debtRows.forEach((row) => {
                debtCategoryTotalsBdt[row.category] = (debtCategoryTotalsBdt[row.category] || 0) + row.convertedBdt;
            });

            const sortedAssetCats = Object.entries(assetCategoryTotalsBdt).sort((a, b) => b[1] - a[1]);
            const biggestAsset = sortedAssetCats[0] || ['None', 0];
            const biggestAssetPct = totalAssetsBdt > 0 ? ((biggestAsset[1] / totalAssetsBdt) * 100) : 0;
            const top3 = [...assetRows].sort((a, b) => b.convertedBdt - a.convertedBdt).slice(0, 3);
            const liabilityRatio = totalAssetsBdt > 0 ? totalLiabilitiesBdt / totalAssetsBdt : 0;
            const nisabMultiple = nisabThresholdBdt > 0 ? zakatableWealthBdt / nisabThresholdBdt : 0;
            const historyRows = getZakatHistory().sort((a, b) => a.year - b.year);

            return {
                generatedAt: nowText,
                selectedCurrency: currency,
                nisabMethod: nisabMethodText,
                kpis: {
                    totalAssets: formatDisplay(totalAssetsBdt),
                    totalLiabilities: formatDisplay(totalLiabilitiesBdt),
                    netWealth: formatDisplay(zakatableWealthBdt),
                    nisabThreshold: formatDisplay(nisabThresholdBdt),
                    zakatDue: formatDisplay(zakatDueBdt)
                },
                totalsRaw: {
                    totalAssetsBdt,
                    totalLiabilitiesBdt,
                    zakatableWealthBdt,
                    nisabThresholdBdt,
                    zakatDueBdt
                },
                tables: {
                    assets: assetRows,
                    debts: debtRows
                },
                insights: {
                    biggestAssetText: `${biggestAsset[0]} (${biggestAssetPct.toFixed(1)}% of total assets)`,
                    top3Entries: top3.map((row) => `${row.category}: ${formatDisplay(row.convertedBdt)}`),
                    liabilityRatioText: `${(liabilityRatio * 100).toFixed(1)}%`,
                    nisabMultipleText: `${nisabMultiple.toFixed(2)}x nisab`
                },
                charts: {
                    pie: {
                        labels: sortedAssetCats.map(([label]) => label),
                        values: sortedAssetCats.map(([, value]) => bdtToDisplay(value))
                    },
                    bar: {
                        labels: Array.from(new Set([...Object.keys(assetCategoryTotalsBdt), ...Object.keys(debtCategoryTotalsBdt)])).slice(0, 8),
                        assetValues: [],
                        debtValues: []
                    },
                    line: {
                        labels: historyRows.map((row) => String(row.year)),
                        values: historyRows.map((row) => bdtToDisplay(row.amountBdt))
                    }
                },
                helpers: {
                    formatDisplay,
                    formatBdt
                }
            };
        }

        function renderReportHTML(data) {
            const reportRoot = byId('pdfReport');
            if (!reportRoot) return;

            data.charts.bar.labels.forEach((label) => {
                const assetSumBdt = data.tables.assets
                    .filter((row) => row.category === label)
                    .reduce((sum, row) => sum + row.convertedBdt, 0);
                const debtSumBdt = data.tables.debts
                    .filter((row) => row.category === label)
                    .reduce((sum, row) => sum + row.convertedBdt, 0);
                data.charts.bar.assetValues.push(data.selectedCurrency === 'BDT' ? assetSumBdt : (sanitizeAmount(byId('usdToBdt')?.value || 0) > 0 ? assetSumBdt / sanitizeAmount(byId('usdToBdt')?.value || 0) : 0));
                data.charts.bar.debtValues.push(data.selectedCurrency === 'BDT' ? debtSumBdt : (sanitizeAmount(byId('usdToBdt')?.value || 0) > 0 ? debtSumBdt / sanitizeAmount(byId('usdToBdt')?.value || 0) : 0));
            });

            const renderRows = (rows) => {
                if (!rows.length) {
                    return `<tr><td colspan="7"><span class="pdf-empty-note">No entries found.</span></td></tr>`;
                }
                return rows.map((row) => `
                    <tr>
                        <td>${escapeHtml(row.timestamp || '-')}</td>
                        <td>${escapeHtml(row.category)}</td>
                        <td>${escapeHtml(row.label || '-')}</td>
                        <td><strong>${escapeHtml(new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(row.amount))}</strong></td>
                        <td>${escapeHtml(row.currency)}</td>
                        <td>${escapeHtml(data.helpers.formatBdt(row.convertedBdt))}</td>
                        <td>${escapeHtml(data.helpers.formatDisplay(row.convertedBdt))}</td>
                    </tr>
                `).join('');
            };

            const top3Text = data.insights.top3Entries.length
                ? data.insights.top3Entries.map((item) => `<li>${escapeHtml(item)}</li>`).join('')
                : '<li>No entries available.</li>';

            reportRoot.innerHTML = `
                <section class="pdf-report-title">
                    <h1>Zakat Report</h1>
                    <div class="pdf-report-meta">Generated: ${escapeHtml(data.generatedAt)}</div>
                    <div class="pdf-report-meta">Selected Currency: ${escapeHtml(data.selectedCurrency)} | Nisab Method: ${escapeHtml(data.nisabMethod)}</div>
                </section>

                <section class="pdf-kpi-grid">
                    <article class="pdf-kpi-card"><div class="pdf-kpi-label">Total Assets</div><div class="pdf-kpi-value">${escapeHtml(data.kpis.totalAssets)}</div></article>
                    <article class="pdf-kpi-card"><div class="pdf-kpi-label">Total Liabilities</div><div class="pdf-kpi-value">${escapeHtml(data.kpis.totalLiabilities)}</div></article>
                    <article class="pdf-kpi-card"><div class="pdf-kpi-label">Net Zakatable Wealth</div><div class="pdf-kpi-value">${escapeHtml(data.kpis.netWealth)}</div></article>
                    <article class="pdf-kpi-card"><div class="pdf-kpi-label">Nisab Threshold</div><div class="pdf-kpi-value">${escapeHtml(data.kpis.nisabThreshold)}</div></article>
                    <article class="pdf-kpi-card"><div class="pdf-kpi-label">Zakat Due</div><div class="pdf-kpi-value">${escapeHtml(data.kpis.zakatDue)}</div></article>
                </section>

                <section class="pdf-report-section">
                    <h2>Insights</h2>
                    <ul class="pdf-insights-list">
                        <li><strong>Biggest asset category:</strong> ${escapeHtml(data.insights.biggestAssetText)}</li>
                        <li><strong>Top 3 entries by value:</strong><ul>${top3Text}</ul></li>
                        <li><strong>Liability ratio:</strong> ${escapeHtml(data.insights.liabilityRatioText)}</li>
                        <li><strong>Net wealth vs nisab:</strong> ${escapeHtml(data.insights.nisabMultipleText)}</li>
                    </ul>
                </section>

                <section class="pdf-report-section">
                    <h2>Charts</h2>
                    <div class="pdf-chart-grid">
                        <article class="pdf-chart-card">
                            <h3 class="pdf-chart-title">Asset Category Share</h3>
                            <canvas id="pdfChartPie" class="pdf-chart-canvas"></canvas>
                        </article>
                        <article class="pdf-chart-card">
                            <h3 class="pdf-chart-title">Assets vs Liabilities by Category</h3>
                            <canvas id="pdfChartBar" class="pdf-chart-canvas"></canvas>
                        </article>
                    </div>
                    <div class="pdf-chart-grid" style="grid-template-columns: 1fr;">
                        <article class="pdf-chart-card">
                            <h3 class="pdf-chart-title">Zakat Due Over Time</h3>
                            ${data.charts.line.labels.length ? '<canvas id="pdfChartLine" class="pdf-chart-canvas"></canvas>' : '<div class="pdf-empty-note">No history data available.</div>'}
                        </article>
                    </div>
                </section>

                <section class="pdf-report-section">
                    <h2>Assets Breakdown</h2>
                    <div class="pdf-table-wrap">
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th><th>Category</th><th>Label / Note</th><th>Amount</th><th>Currency</th><th>Converted (BDT)</th><th>Converted (${escapeHtml(data.selectedCurrency)})</th>
                                </tr>
                            </thead>
                            <tbody>${renderRows(data.tables.assets)}</tbody>
                        </table>
                    </div>
                </section>

                <section class="pdf-report-section">
                    <h2>Debts Breakdown</h2>
                    <div class="pdf-table-wrap">
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th><th>Category</th><th>Label / Note</th><th>Amount</th><th>Currency</th><th>Converted (BDT)</th><th>Converted (${escapeHtml(data.selectedCurrency)})</th>
                                </tr>
                            </thead>
                            <tbody>${renderRows(data.tables.debts)}</tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        async function renderReportCharts(data) {
            if (!window.Chart) return;
            const charts = [];
            const commonOpts = { responsive: true, maintainAspectRatio: false, animation: false };

            const pieCanvas = byId('pdfChartPie');
            if (pieCanvas && data.charts.pie.labels.length) {
                charts.push(new Chart(pieCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: data.charts.pie.labels,
                        datasets: [{ data: data.charts.pie.values, backgroundColor: ['#d4af37', '#22c55e', '#3b82f6', '#f97316', '#8b5cf6', '#0ea5e9', '#eab308', '#14b8a6'] }]
                    },
                    options: { ...commonOpts, plugins: { legend: { position: 'bottom' } } }
                }));
            }

            const barCanvas = byId('pdfChartBar');
            if (barCanvas && data.charts.bar.labels.length) {
                charts.push(new Chart(barCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.charts.bar.labels,
                        datasets: [
                            { label: 'Assets', data: data.charts.bar.assetValues, backgroundColor: 'rgba(34, 197, 94, 0.75)' },
                            { label: 'Liabilities', data: data.charts.bar.debtValues, backgroundColor: 'rgba(239, 106, 95, 0.75)' }
                        ]
                    },
                    options: { ...commonOpts, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                }));
            }

            const lineCanvas = byId('pdfChartLine');
            if (lineCanvas && data.charts.line.labels.length) {
                charts.push(new Chart(lineCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.charts.line.labels,
                        datasets: [{ label: `Zakat Due (${data.selectedCurrency})`, data: data.charts.line.values, borderColor: '#d4af37', backgroundColor: 'rgba(212, 175, 55, 0.2)', tension: 0.25, fill: true }]
                    },
                    options: { ...commonOpts, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                }));
            }

            await new Promise((resolve) => setTimeout(resolve, 120));

            charts.forEach((chart) => {
                const canvas = chart.canvas;
                const image = document.createElement('img');
                image.src = canvas.toDataURL('image/png', 1);
                image.className = 'pdf-chart-image';
                canvas.replaceWith(image);
                chart.destroy();
            });
        }

        async function generatePDFfromReport() {
            const reportRoot = byId('pdfReport');
            if (!reportRoot || !window.html2canvas || !window.jspdf?.jsPDF) {
                throw new Error('PDF libraries not available.');
            }

            reportRoot.classList.add('is-active');
            await new Promise((resolve) => requestAnimationFrame(() => requestAnimationFrame(resolve)));

            const canvas = await window.html2canvas(reportRoot, {
                scale: 2.5,
                useCORS: true,
                backgroundColor: '#ffffff',
                windowWidth: reportRoot.scrollWidth,
                windowHeight: reportRoot.scrollHeight,
                scrollX: 0,
                scrollY: 0
            });

            reportRoot.classList.remove('is-active');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;
            const contentWidth = pageWidth - (margin * 2);
            const contentHeight = pageHeight - (margin * 2);

            const pageHeightPx = Math.floor((contentHeight * canvas.width) / contentWidth);
            const totalPages = Math.ceil(canvas.height / pageHeightPx);

            for (let pageIndex = 0; pageIndex < totalPages; pageIndex += 1) {
                if (pageIndex > 0) pdf.addPage();

                const sliceCanvas = document.createElement('canvas');
                sliceCanvas.width = canvas.width;
                sliceCanvas.height = Math.min(pageHeightPx, canvas.height - (pageIndex * pageHeightPx));
                const ctx = sliceCanvas.getContext('2d');
                ctx.drawImage(
                    canvas,
                    0,
                    pageIndex * pageHeightPx,
                    canvas.width,
                    sliceCanvas.height,
                    0,
                    0,
                    canvas.width,
                    sliceCanvas.height
                );

                const imgData = sliceCanvas.toDataURL('image/png', 1);
                const renderedHeight = (sliceCanvas.height * contentWidth) / sliceCanvas.width;
                pdf.addImage(imgData, 'PNG', margin, margin, contentWidth, renderedHeight, undefined, 'FAST');
                pdf.setFontSize(10);
                pdf.setTextColor(100);
                pdf.text(`Page ${pageIndex + 1} / ${totalPages}`, pageWidth - margin, pageHeight - 4, { align: 'right' });
            }

            const datePart = new Date().toISOString().slice(0, 10);
            pdf.save(`zakat-report-${datePart}.pdf`);
        }

        async function exportPDFReport() {
            try {
                const data = buildReportDataFromState();
                renderReportHTML(data);
                await renderReportCharts(data);
                await generatePDFfromReport();
                showToast('PDF report exported');
            } catch (error) {
                console.error(error);
                alert('Could not generate PDF report. Please try again.');
            }
        }

        function hasEnteredFinancialData() {
            const fieldIds = [
                'cashBankTotalAmt', 'cashAmt', 'bankAmt', 'goldAmt', 'silverAmt',
                'investmentsAmt', 'digitalAssetsAmt', 'businessAmt', 'receivablesAmt', 'debtsAmt'
            ];
            const hasMainValues = fieldIds.some((id) => {
                const el = byId(id);
                const value = parseFloat(el?.value || '0');
                return Number.isFinite(value) && Math.abs(value) > 0;
            });
            if (hasMainValues) return true;

            const coreFields = ['cashBank', 'stocks', 'gold', 'silver', 'business', 'receivables'];
            const hasCoreExtraValues = coreFields.some((field) => {
                const list = byId(`${field}ExtraList`);
                if (!list) return false;
                return Array.from(list.querySelectorAll('.core-extra-amount')).some((input) => {
                    const value = parseFloat(input.value || '0');
                    return Number.isFinite(value) && Math.abs(value) > 0;
                });
            });
            if (hasCoreExtraValues) return true;

            return serializeExtraAssets().some((entry) => {
                const value = parseFloat(entry?.amount || '0');
                return Number.isFinite(value) && Math.abs(value) > 0;
            });
        }

        function updateQuickStartProgress() {
            const stepButtons = quickStepButtons.length ? quickStepButtons : Array.from(document.querySelectorAll('.quick-step'));
            if (!stepButtons.length) return;

            const sectionIds = quickStepSections.length ? quickStepSections : ['assetsCard', 'debtsCard', 'resultsCard'];
            let activeIndex = 0;
            const anchor = window.innerHeight * 0.35;

            sectionIds.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (!el) return;
                const rect = el.getBoundingClientRect();
                if (rect.top <= anchor) activeIndex = idx;
            });

            stepButtons.forEach((btn, idx) => {
                btn.classList.toggle('active', idx === activeIndex);
                btn.classList.toggle('done', idx < activeIndex);
            });

            const resultBtn = stepButtons.find((btn) => btn.getAttribute('data-target') === 'resultsCard');
            if (resultBtn) {
                const phaseEl = resultBtn.querySelector('.moon-phase');
                const calculated = hasEnteredFinancialData();
                resultBtn.classList.toggle('calculated', calculated);
                if (phaseEl) phaseEl.textContent = calculated ? String.fromCodePoint(0x1F315) : String.fromCodePoint(0x1F314);
            }
        }

        function setupTopNav() {
            topNavLinks = Array.from(document.querySelectorAll('.top-link[data-nav-target]'));
            topLinkIndicator = document.querySelector('.top-link-indicator');
            topNavSections = topNavLinks
                .map((link) => byId(link.getAttribute('data-nav-target') || ''))
                .filter(Boolean);
            const topNavEl = document.querySelector('.top-nav');
            const mobileMenuBtn = byId('mobileMenuToggle');
            const isMobileNav = () => window.matchMedia('(max-width: 900px)').matches;

            const closeMobileMenu = () => {
                if (!topNavEl || !mobileMenuBtn) return;
                topNavEl.classList.remove('mobile-open');
                mobileMenuBtn.setAttribute('aria-expanded', 'false');
            };

            if (mobileMenuBtn && topNavEl) {
                mobileMenuBtn.addEventListener('click', () => {
                    const willOpen = !topNavEl.classList.contains('mobile-open');
                    topNavEl.classList.toggle('mobile-open', willOpen);
                    mobileMenuBtn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
                });
            }

            document.addEventListener('click', (event) => {
                if (!isMobileNav() || !topNavEl || !mobileMenuBtn) return;
                const target = event.target;
                if (!(target instanceof Node)) return;
                if (!topNavEl.classList.contains('mobile-open')) return;
                if (topNavEl.contains(target)) return;
                closeMobileMenu();
            });

            document.addEventListener('keydown', (event) => {
                if (!isMobileNav() || !topNavEl) return;
                if (event.key === 'Escape' && topNavEl.classList.contains('mobile-open')) {
                    closeMobileMenu();
                }
            });

            topNavLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    const target = byId(link.getAttribute('data-nav-target') || '');
                    if (!target) return;
                    topNavLinks.forEach((item) => item.classList.toggle('active', item === link));
                    updateTopNavIndicator();
                    target.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' });
                    if (isMobileNav()) closeMobileMenu();
                });
            });

            const topThemeEl = byId('topThemeMode');
            if (topThemeEl) {
                topThemeEl.addEventListener('change', () => {
                    applyTheme(topThemeEl.value);
                    scheduleSaveData(0);
                });
            }
            window.addEventListener('resize', () => {
                updateTopNavIndicator();
                if (!isMobileNav()) closeMobileMenu();
            }, { passive: true });
            updateTopThemeLabel();
            updateTopNavIndicator();
            updateNavProgress();
        }

        function updateTopNavActive() {
            if (!topNavLinks.length) return;
            const anchor = window.innerHeight * 0.28;
            let activeId = 'landing';

            topNavSections.forEach((section) => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= anchor) activeId = section.id;
            });

            topNavLinks.forEach((link) => {
                link.classList.toggle('active', link.getAttribute('data-nav-target') === activeId);
            });
            updateTopNavIndicator();
        }

        function setupSectionRail() {
            railLinks = Array.from(document.querySelectorAll('.rail-link[data-rail-target]'));
            railSections = railLinks
                .map((link) => byId(link.getAttribute('data-rail-target') || ''))
                .filter(Boolean);

            railLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    const target = byId(link.getAttribute('data-rail-target') || '');
                    if (!target) return;
                    target.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' });
                });
            });
        }

        function setupResultsTabs() {
            const tabs = Array.from(document.querySelectorAll('.results-tab[data-result-tab]'));
            const panels = Array.from(document.querySelectorAll('.results-tab-panel'));
            if (!tabs.length || !panels.length) return;

            const activate = (panelId) => {
                tabs.forEach((tab) => {
                    const isActive = tab.getAttribute('data-result-tab') === panelId;
                    tab.classList.toggle('active', isActive);
                    tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                });
                panels.forEach((panel) => {
                    const isActive = panel.id === panelId;
                    panel.classList.toggle('active', isActive);
                    panel.hidden = !isActive;
                });
            };

            tabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                    const panelId = tab.getAttribute('data-result-tab');
                    if (!panelId) return;
                    activate(panelId);
                });
            });
        }

        function setupAmountInputBehavior() {
            const calculator = byId('calculator');
            if (!calculator) return;

            const onAmountDraftChange = (event) => {
                const target = event.target;
                if (!(target instanceof HTMLInputElement)) return;
                if (!isAmountInput(target)) return;
                setDraftForInput(target);
                if (target.id && calcInputIds.has(target.id)) return;
                recalculateTotals();
            };

            calculator.addEventListener('input', onAmountDraftChange);
            calculator.addEventListener('change', onAmountDraftChange);

            calculator.addEventListener('keydown', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLInputElement)) return;
                if (!isAmountInput(target)) return;
                if (event.key !== 'Enter') return;
                event.preventDefault();

                setDraftForInput(target);
                const addBtn = getAddButtonForAmountInput(target);
                if (!addBtn) {
                    recalculateTotals();
                    return;
                }
                addBtn.click();
            });

            calculator.querySelectorAll('input[id$="Amt"], .core-extra-amount, .extra-asset-amount').forEach((inputEl) => {
                if (inputEl instanceof HTMLInputElement) setDraftForInput(inputEl);
            });
        }

        function launchResultConfetti() {
            const layer = byId('resultConfettiLayer');
            if (!layer || prefersReducedMotion) return;
            layer.innerHTML = '';
            const colors = ['#f4d47b', '#d4af37', '#7de2d6', '#ffd7a8', '#9ec4ff'];
            const count = 18;
            for (let i = 0; i < count; i += 1) {
                const piece = document.createElement('span');
                piece.className = 'result-confetti';
                const angle = (Math.PI * 2 * i) / count;
                const dist = 36 + Math.random() * 64;
                const tx = Math.cos(angle) * dist;
                const ty = -Math.abs(Math.sin(angle) * dist) - (20 + Math.random() * 60);
                piece.style.left = '50%';
                piece.style.top = '56%';
                piece.style.setProperty('--tx', `${tx.toFixed(1)}px`);
                piece.style.setProperty('--ty', `${ty.toFixed(1)}px`);
                piece.style.setProperty('--rot', `${(-140 + Math.random() * 280).toFixed(0)}deg`);
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = `${(Math.random() * 120).toFixed(0)}ms`;
                layer.appendChild(piece);
            }
            setTimeout(() => { layer.innerHTML = ''; }, 1200);
        }

        function updateSectionRailActive() {
            if (!railLinks.length) return;
            const anchor = window.innerHeight * 0.3;
            let activeId = 'settingsCard';

            railSections.forEach((section) => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= anchor) activeId = section.id;
            });

            railLinks.forEach((link) => {
                link.classList.toggle('active', link.getAttribute('data-rail-target') === activeId);
            });
        }

        function onScrollTick() {
            const backToTop = byId('backToTop');
            if (backToTop) {
                if (window.scrollY > 500) {
                    backToTop.classList.add('show');
                } else {
                    backToTop.classList.remove('show');
                }
            }
            updateTopNavActive();
            updateSectionRailActive();
            updateQuickStartProgress();
            updateNavProgress();
            scrollRafId = null;
        }

        window.addEventListener('scroll', () => {
            if (scrollRafId) return;
            scrollRafId = requestAnimationFrame(onScrollTick);
        }, { passive: true });

        window.addEventListener('load', () => {
            quickStepButtons = Array.from(document.querySelectorAll('.quick-step'));
            quickStepSections = ['assetsCard', 'debtsCard', 'resultsCard'];
            initThousandSeparatedInputs();
            updateEntriesBadge();

            const splitBtn = byId('splitCashBankBtn');
            const splitPanel = byId('splitCashBankPanel');
            if (splitBtn && splitPanel) {
                splitBtn.addEventListener('click', () => {
                    const isOpen = splitPanel.classList.contains('open');
                    setSplitPanelOpen(!isOpen);
                });
            }

            const calculator = byId('calculator');
            if (calculator) {
                const onCalcInput = (event) => {
                    const target = event.target;
                    if (!(target instanceof HTMLElement)) return;
                    if (!target.id || !calcInputIds.has(target.id)) return;
                    if (target.id === 'currency') {
                        handleMainCurrencyChange();
                        return;
                    }
                    if (target.id === 'usdToBdt') {
                        const displayCurrency = byId('currency')?.value || 'BDT';
                        if (displayCurrency === 'BDT') {
                            renderMetalPricesFromBaseUsd('BDT');
                        }
                        calculateZakat();
                        return;
                    }
                    if (target.id === 'goldPrice' || target.id === 'silverPrice') {
                        const displayCurrency = byId('currency')?.value || 'BDT';
                        setMetalPriceBaseUsdFromVisible(displayCurrency);
                        calculateZakat();
                        return;
                    }
                    if (target.id === 'themeMode') {
                        applyTheme(target.value);
                        scheduleSaveData(0);
                        return;
                    }
                    calculateZakat();
                };
                calculator.addEventListener('input', onCalcInput);
                calculator.addEventListener('change', onCalcInput);
            }
            setupAmountInputBehavior();

            document.addEventListener('click', (event) => {
                const btn = event.target.closest('.currency-mini[data-currency-for]');
                if (btn) {
                    const hiddenId = btn.getAttribute('data-currency-for');
                    if (hiddenId) toggleCurrencyFor(hiddenId);
                    return;
                }

                const coreBtn = event.target.closest('.core-extra-currency-btn');
                if (coreBtn) {
                    const row = coreBtn.closest('.core-extra-row');
                    const hidden = row ? row.querySelector('.core-extra-currency') : null;
                    if (!hidden) return;
                    hidden.value = hidden.value === 'USD' ? 'BDT' : 'USD';
                    coreBtn.textContent = hidden.value;
                    if (row?.dataset.entryId) {
                        updateEntry(row.dataset.entryId, {
                            category: coreFieldToCategory(row.dataset.field || ''),
                            amount: row.querySelector('.core-extra-amount')?.value || '0',
                            currency: hidden.value,
                            note: '',
                            meta: { source: 'core-entry', field: row.dataset.field || '' }
                        });
                    }
                    calculateZakat();
                    return;
                }

                const extraBtn = event.target.closest('.extra-asset-currency-btn');
                if (!extraBtn) return;
                const row = extraBtn.closest('.extra-asset-row');
                const hidden = row ? row.querySelector('.extra-asset-currency') : null;
                if (!hidden) return;
                hidden.value = hidden.value === 'USD' ? 'BDT' : 'USD';
                extraBtn.textContent = hidden.value;
                if (row?.dataset.entryId) {
                    updateEntry(row.dataset.entryId, {
                        category: row.querySelector('.extra-asset-type')?.value || 'Other',
                        amount: row.querySelector('.extra-asset-amount')?.value || '0',
                        currency: hidden.value,
                        note: '',
                        meta: { source: 'additional-entry' }
                    });
                }
                calculateZakat();
            });

            const ctaBtn = byId('calculateCtaBtn');
            if (ctaBtn) ctaBtn.addEventListener('click', scrollToCalculator);
            const exportBtn = byId('exportInvoiceBtn');
            if (exportBtn) exportBtn.addEventListener('click', exportInvoicePdf);
            const livePricesBtn = byId('fetchLivePricesBtn');
            if (livePricesBtn) livePricesBtn.addEventListener('click', fetchLiveMetalPrices);
            const backToTopBtn = byId('backToTop');
            if (backToTopBtn) backToTopBtn.addEventListener('click', scrollToTop);
            document.querySelectorAll('.asset-note-input').forEach((noteInput) => {
                noteInput.addEventListener('input', () => scheduleSaveData(150));
            });

            const addAssetBtn = byId('addAssetRowBtn');
            if (addAssetBtn) {
                addAssetBtn.addEventListener('click', () => {
                    const draftAmount = sanitizeAmount(byId('digitalAssetsAmt')?.value || 0);
                    const draftCurrency = byId('digitalAssetsCur')?.value || byId('currency')?.value || 'BDT';
                    addExtraAssetRow({ type: 'Digital Assets', amount: draftAmount, currency: draftCurrency }, { trackEntry: true });
                });
            }
            document.querySelectorAll('.add-core-entry[data-core-field]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const field = btn.getAttribute('data-core-field');
                    if (!field) return;
                    const relatedAmountInput = btn.closest('.form-group')?.querySelector('input[id$=\"Amt\"]');
                    const draftAmount = resolveDraftAmountForCoreField(field, relatedAmountInput || null);
                    addCoreExtraRow(field, { label: '', amount: draftAmount, currency: byId('currency')?.value || 'BDT' }, { trackEntry: true });
                    calculateZakat();
                });
            });
            const saveHistoryBtn = byId('saveHistoryBtn');
            if (saveHistoryBtn) {
                saveHistoryBtn.addEventListener('click', () => {
                    const y = parseInt(byId('historyYear')?.value || '', 10) || new Date().getFullYear();
                    upsertZakatHistory(y, latestZakatAmountBdt);
                });
            }
            quickStepButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const target = targetId ? byId(targetId) : null;
                    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
            updateCurrentDates();
            scheduleDateRefreshAtMidnight();
            fillHijriDayOptions();
            setupScrollReveal();
            setupMoonParallax();
            setupAssetCategoryChips();
            setupTopNav();
            setupSectionRail();
            setupResultsTabs();
            applyTheme(byId('themeMode')?.value || localStorage.getItem(themeStorageKey) || 'midnight-gold');
            loadData();
            initThousandSeparatedInputs();
            const historyYearEl = byId('historyYear');
            if (historyYearEl && !historyYearEl.value) historyYearEl.value = String(new Date().getFullYear());
            renderZakatHistory();
            updateCurrencyMiniButtons();
            updateTopNavActive();
            updateSectionRailActive();
            updateQuickStartProgress();
            autoFetchLiveMetalPricesIfEmpty();
        });

        window.addEventListener('storage', (event) => {
            if (event.key === entriesStorageKey) {
                updateEntriesBadge();
            }
        });
    </script>
</body>
</html>







